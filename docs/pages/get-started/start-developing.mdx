// server/index.js
// Minimal Express server to initiate Daraja STK push (sandbox).
// Note: This is example code for testing. Do NOT store production keys in plaintext.

const express = require("express");
const axios = require("axios");
const bodyParser = require("body-parser");

const app = express();
app.use(bodyParser.json());

/*
  CONFIG - replace with your keys for live
  For sandbox/test use the Daraja sandbox consumer key/secret and shortcode.
*/
const CONF = {
  consumerKey: "YOUR_DARAJA_CONSUMER_KEY",      // sandbox key
  consumerSecret: "YOUR_DARAJA_CONSUMER_SECRET",// sandbox secret
  shortcode: "174379", // Daraja sandbox shortcode (example). Replace with your Paybill/Till when live.
  passkey: "YOUR_LIPA_NA_MPESA_PASSKEY",       // Lipa Na M-Pesa passkey (sandbox)
  callbackBaseUrl: "https://your-backend.example.com", // public URL for callbacks
  environment: "sandbox", // or "production"
};

// get OAuth token
async function getAuthToken() {
  const url =
    CONF.environment === "sandbox"
      ? "https://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials"
      : "https://api.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials";

  const token = Buffer.from(`${CONF.consumerKey}:${CONF.consumerSecret}`).toString("base64");
  const res = await axios.get(url, {
    headers: { Authorization: `Basic ${token}` },
  });
  return res.data.access_token;
}

// STK Push endpoint
app.post("/api/stkpush", async (req, res) => {
  try {
    const { phone, amount, accountReference = "APPLLElinc", transactionDesc = "Subscription" } = req.body;
    if (!phone || !amount) return res.status(400).json({ error: "phone & amount required" });

    const token = await getAuthToken();

    const timestamp = new Date().toISOString().replace(/[-:TZ.]/g, "").slice(0, 14); // YYYYMMDDHHMMSS
    const password = Buffer.from(`${CONF.shortcode}${CONF.passkey}${timestamp}`).toString("base64");

    const url =
      CONF.environment === "sandbox"
        ? "https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest"
        : "https://api.safaricom.co.ke/mpesa/stkpush/v1/processrequest";

    const callbackUrl = `${CONF.callbackBaseUrl}/api/stk/callback`; // Daraja will POST here

    const body = {
      BusinessShortCode: CONF.shortcode,
      Password: password,
      Timestamp: timestamp,
      TransactionType: "CustomerPayBillOnline",
      Amount: amount,
      PartyA: phone.replace(/\D/g, ""), // phone in format 2547xxxxxxx
      PartyB: CONF.shortcode,
      PhoneNumber: phone.replace(/\D/g, ""),
      CallBackURL: callbackUrl,
      AccountReference: accountReference,
      TransactionDesc: transactionDesc,
    };

    const response = await axios.post(url, body, {
      headers: { Authorization: `Bearer ${token}` },
    });

    // store response's CheckoutRequestID, etc. (you should persist to DB)
    return res.json({ success: true, data: response.data });
  } catch (err) {
    console.error("stkpush err", err.response?.data || err.message);
    return res.status(500).json({ error: "STK push failed", detail: err.response?.data || err.message });
  }
});

// Callback endpoint for Daraja (must be publicly reachable)
app.post("/api/stk/callback", (req, res) => {
  // Daraja will POST JSON containing ResultCode, CheckoutRequestID, etc.
  const callback = req.body;
  console.log("Daraja callback received:", JSON.stringify(callback).slice(0, 1200));
  // TODO: parse callback.body and update subscription in DB and push notification to user
  // For now, just respond 200 OK
  res.json({ result: "received" });
});

const port = process.env.PORT || 3333;
app.listen(port, () => console.log("STK backend running on", port));
