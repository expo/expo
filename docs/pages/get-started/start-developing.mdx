import React, { useState, useEffect, Suspense, useRef, useMemo } from "react";
import { Canvas, useFrame } from "@react-three/fiber";
import { OrbitControls, useGLTF, Html } from "@react-three/drei";
import * as THREE from "three";

const planSemanal = [
  "HIIT Total Quema Grasa",
  "Tonificación Intensa (Piernas, Glúteos, Brazos, Abdomen, Cuello)",
  "HIIT Cardio Explosivo",
  "Core + Facial + Postura",
  "HIIT con Fuerza",
  "Sudor Extremo Full Body",
  "Descanso Activo (Caminata ligera o estiramientos)"
];

// Generar calendario 60 días con rutina semanal cíclica
const generateCalendar = () => {
  const days = [];
  for (let i = 0; i < 60; i++) {
    days.push({
      day: i + 1,
      routine: planSemanal[i % 7]
    });
  }
  return days;
};
const calendar = generateCalendar();

// Ejercicios ejemplo con modelos GLTF y animación
const ejercicios = {
  "Burpees": { duration: 40, modelPath: "/models/burpee.glb", animationName: "Burpee" },
  "Sentadillas con salto": { duration: 40, modelPath: "/models/jumpsquat.glb", animationName: "JumpSquat" },
  "Flexiones": { duration: 40, modelPath: "/models/pushup.glb", animationName: "PushUp" },
  "Russian Twists": { duration: 40, modelPath: "/models/torso_twist.glb", animationName: "TorsoTwist" },
  "Planchas": { duration: 40, modelPath: "/models/plank.glb", animationName: "Plank" },
  "Jumping Lunges": { duration: 40, modelPath: "/models/jumping_lunge.glb", animationName: "JumpingLunge" },
  "Mountain Climbers": { duration: 40, modelPath: "/models/mountain_climber.glb", animationName: "MountainClimber" },
  "Descanso": { duration: 20, modelPath: null, animationName: null }
};

// Rutina diaria con ejercicios diferentes (ejemplo simplificado)
const rutinaDia = {
  1: ["Burpees", "Descanso", "Sentadillas con salto", "Descanso", "Mountain Climbers", "Descanso", "Flexiones"],
  2: ["Russian Twists", "Descanso", "Jumping Lunges", "Descanso", "Planchas", "Descanso", "Burpees"],
  3: ["Sentadillas con salto", "Descanso", "Flexiones", "Descanso", "Mountain Climbers", "Descanso", "Russian Twists"],
  // ... Completar para 60 días
};

// Componente para cargar y animar modelo 3D
function AnimatedModel({ modelPath, animationName }) {
  const group = useRef();
  const { scene, animations } = useGLTF(modelPath || "");
  const mixer = useMemo(() => new THREE.AnimationMixer(scene), [scene]);

  useEffect(() => {
    if (!animations || animations.length === 0 || !animationName) return;

    const clip = animations.find((clip) => clip.name === animationName) || animations[0];
    const action = mixer.clipAction(clip);
    action.reset().play();

    return () => {
      action.stop();
      mixer.uncacheClip(clip);
    };
  }, [animations, animationName, mixer]);

  useFrame((_, delta) => mixer.update(delta));

  if (!modelPath) return <Html><p>Descanso, prepárate para el siguiente ejercicio.</p></Html>;

  return <primitive ref={group} object={scene} position={[0, -1, 0]} />;
}

// Componente principal
export default function RutinaApp() {
  const [selectedDay, setSelectedDay] = useState(1);
  const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
  const [timeLeft, setTimeLeft] = useState(
    ejercicios[rutinaDia[selectedDay]?.[0]]?.duration || 20
  );
  const [isRunning, setIsRunning] = useState(false);

  const ejerciciosDia = rutinaDia[selectedDay] || ["Descanso"];

  useEffect(() => {
    if (!isRunning) return;

    const timer = setInterval(() => {
      setTimeLeft((t) => {
        if (t === 1) {
          // Pasar al siguiente ejercicio
          const nextIndex = (currentExerciseIndex + 1) % ejerciciosDia.length;
          setCurrentExerciseIndex(nextIndex);
          return ejercicios[ejerciciosDia[nextIndex]]?.duration || 20;
        }
        return t - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, [isRunning, currentExerciseIndex, ejerciciosDia]);

  useEffect(() => {
    // Reiniciar tiempo al cambiar de día o ejercicio
    setCurrentExerciseIndex(0);
    setTimeLeft(ejercicios[ejerciciosDia[0]]?.duration || 20);
    setIsRunning(false);
  }, [selectedDay]);

  const currentExercise = ejercicios[ejerciciosDia[currentExerciseIndex]] || ejercicios["Descanso"];

  return (
    <div className="min-h-screen bg-zinc-900 text-white p-4 flex flex-col items-center">
      <h1 className="text-3xl font-bold mb-6">Rutina Fitness 60 días</h1>

      {/* Calendario */}
      <div className="grid grid-cols-10 gap-1 max-w-xl mb-6">
        {calendar.map(({ day }) => (
          <button
            key={day}
            onClick={() => setSelectedDay(day)}
            className={`rounded px-2 py-1 text-sm ${
              selectedDay === day ? "bg-green-600" : "bg-zinc-700 hover:bg-zinc-600"
            }`}
          >
            Día {day}
          </button>
        ))}
      </div>

      {/* Rutina del día */}
      <div className="mb-6 max-w-xl text-center">
        <h2 className="text-xl mb-2">Día {selectedDay} - {planSemanal[(selectedDay - 1) % 7]}</h2>
        <p className="text-green-400 font-semibold">
          {ejerciciosDia.join(" → ")}
        </p>
      </div>

      {/* Ejercicio actual */}
      <div className="max-w-xl w-full bg-zinc-800 rounded-xl p-4 shadow-lg text-center">
        <h3 className="text-2xl font-semibold mb-2">{currentExerciseIndex + 1} / {ejerciciosDia.length}</h3>
        <h2 className="text-3xl font-bold mb-2">{ejerciciosDia[currentExerciseIndex]}</h2>
        <p className="text-5xl mb-4">{timeLeft}s</p>

        {/* Modelo 3D */}
        {currentExercise.modelPath ? (
          <div style={{ height: 400 }}>
            <Canvas>
              <ambientLight intensity={0.5} />
              <directionalLight position={[0, 5, 5]} intensity={1} />
              <Suspense fallback={<Html>Loading 3D model...</Html>}>
                <AnimatedModel
                  modelPath={currentExercise.modelPath}
                  animationName={currentExercise.animationName}
                />
              </Suspense>
              <OrbitControls enableZoom={false} />
            </Canvas>
          </div>
        ) : (
          <p className="italic text-zinc-400 py-20">Descanso. Prepárate para el siguiente ejercicio.</p>
        )}

        <div className="mt-6 space-x-4">
          <button
            onClick={() => setIsRunning(true)}
            className="bg-green-600 px-6 py-2 rounded hover:bg-green-700"
          >
            Iniciar
          </button>
          <button
            onClick={() => {
              setIsRunning(false);
              setTimeLeft(currentExercise.duration);
            }}
            className="bg-red-600 px-6 py-2 rounded hover:bg-red-700"
          >
            Pausar
          </button>
          <button
            onClick={() => {
              setIsRunning(false);
              setCurrentExerciseIndex(0);
              setTimeLeft(ejercicios[ejerciciosDia[0]]?.duration || 20);
            }}
            className="bg-yellow-600 px-6 py-2 rounded hover:bg-yellow-700"
          >
            Reiniciar
          </button>
        </div>
      </div>
    </div>
  );
}
