import React, { useEffect, useMemo, useState } from "react"; // InvestApp - Frontend connecté au backend // - Auth: register / login -> stocke accessToken dans localStorage // - Appels API: /api/wallet, /api/wallet/recharge, /api/wallet/withdraw, /api/transactions // - Exemple simple pour simuler l'intégration Mobile Money: envoie recharge au backend qui simulera la confirmation via webhook

export default function InvestAppConnected() { const [token, setToken] = useState(localStorage.getItem('accessToken') || ''); const [me, setMe] = useState({ name: 'Invité', balance: 0, projectRevenue: 0, currency: 'CFA' }); const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [amount, setAmount] = useState(10000); const [journal, setJournal] = useState([]); const API_BASE = process.env.REACT_APP_API_BASE || 'http://localhost:4000';

useEffect(() => { if (token) fetchProfile(); }, [token]);

async function register() { const res = await fetch(${API_BASE}/api/auth/register, { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ email, password, name: email.split('@')[0] }) }); const j = await res.json(); if (j.ok) alert('Inscription OK — connecte-toi'); else alert(JSON.stringify(j)); }

async function login() { const res = await fetch(${API_BASE}/api/auth/login, { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ email, password }) }); const j = await res.json(); if (j.accessToken) { localStorage.setItem('accessToken', j.accessToken); setToken(j.accessToken); } else alert(JSON.stringify(j)); }

async function fetchProfile() { const res = await fetch(${API_BASE}/api/wallet, { headers: { Authorization: Bearer ${token} } }); if (res.status === 401) { setToken(''); localStorage.removeItem('accessToken'); return; } const data = await res.json(); setMe(data); const tx = await (await fetch(${API_BASE}/api/transactions, { headers: { Authorization: Bearer ${token} } })).json(); setJournal(tx); }

async function recharge() { // Cette route simule l'envoi d'une instruction de paiement mobile-money côté backend const res = await fetch(${API_BASE}/api/wallet/recharge, { method: 'POST', headers: { Authorization: Bearer ${token}, 'content-type': 'application/json' }, body: JSON.stringify({ amount }) }); const j = await res.json(); if (j.ok) { alert('Rechargement enregistré. Solde mis à jour'); fetchProfile(); } else alert(JSON.stringify(j)); }

async function withdraw() { const res = await fetch(${API_BASE}/api/wallet/withdraw, { method: 'POST', headers: { Authorization: Bearer ${token}, 'content-type': 'application/json' }, body: JSON.stringify({ amount, payout_account: 'mobile:07xxxxxxx' }) }); const j = await res.json(); if (j.ok) { alert('Demande de retrait créée (en attente)'); fetchProfile(); } else alert(JSON.stringify(j)); }

return ( <div style={{ fontFamily: 'Inter, system-ui, Arial', padding: 20 }}> <h2>InvestApp — Frontend connecté</h2> {!token ? ( <div style={{ maxWidth: 420 }}> <h3>Connexion / Inscription</h3> <input placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} style={{ width: '100%', padding: 8, marginBottom: 8 }} /> <input placeholder="Mot de passe" type="password" value={password} onChange={e=>setPassword(e.target.value)} style={{ width: '100%', padding: 8, marginBottom: 8 }} /> <div style={{ display: 'flex', gap: 8 }}> <button onClick={login}>Se connecter</button> <button onClick={register}>S'inscrire</button> </div> </div> ) : ( <div> <div style={{ display: 'flex', justifyContent: 'space-between', maxWidth: 700 }}> <div> <div style={{ fontSize: 28, fontWeight: 700 }}>{me.currency} {Number(me.balance).toLocaleString()}.00</div> <div>Revenu du projet: {me.currency} {Number(me.project_revenue || me.projectRevenue || 0).toLocaleString()}.00</div> </div> <div> <div>Connecté en tant que: <strong>{me.name || 'Utilisateur'}</strong></div> <button onClick={()=>{ localStorage.removeItem('accessToken'); setToken(''); setMe({}); }}>Se déconnecter</button> </div> </div>

<hr style={{ margin: '16px 0' }} />

      <div style={{ maxWidth: 420 }}>
        <h4>Recharger le solde</h4>
        <input type="number" value={amount} onChange={e=>setAmount(Number(e.target.value))} style={{ width: '100%', padding: 8, marginBottom: 8 }} />
        <button onClick={recharge}>Recharger (simulé / Mobile Money)</button>
      </div>

      <div style={{ maxWidth: 420, marginTop: 12 }}>
        <h4>Retrait</h4>
        <input type="number" value={amount} onChange={e=>setAmount(Number(e.target.value))} style={{ width: '100%', padding: 8, marginBottom: 8 }} />
        <button onClick={withdraw}>Demander retrait</button>
      </div>

      <section style={{ marginTop: 16 }}>
        <h4>Historique (dernières transactions)</h4>
        <ul>
          {journal.map(t => (
            <li key={t.id}>{t.id} — {t.type} — {t.amount} — {t.status} — {new Date(t.created_at).toLocaleString()}</li>
          ))}
        </ul>
      </section>
    </div>
  )}
</div>

); }

/* Backend: ajout recommandé pour Mobile Money (fichier: src/routes/mobile_money.js)

// Exemple: endpoints pour initier paiement & webhook de confirmation import { Router } from 'express'; import { db } from '../db.js';

const r = Router();

// 1) initier un paiement (appelé par frontend) r.post('/initiate', (req, res) => { // body: { userId, amount, provider } // crée une transaction en attente et retourne payment_request_id });

// 2) webhook (ceci sera appelé par le PSP quand le paiement est confirmé) r.post('/webhook', (req, res) => { // body: { payment_request_id, status, provider_meta } // marquer la transaction comme 'succès' et créditer le wallet });

export default r;

Instructions d'intégration PSP (Orange/Moov/MTN):

1. Crée un compte développeur avec le PSP; récupère les clefs sandbox (client_id/secret).


2. Dans backend, implémente la route /api/mobile/initiate qui appelle l'API PSP pour créer un paiement.

Stocke une transaction locale (status: 'en attente') et le payment_request_id renvoyé.



3. Configure l'URL webhook du PSP pour qu'il appelle /api/mobile/webhook sur ton backend.

Dans la route webhook, vérifie la signature (selon le PSP), puis si paiement réussi: mettre transaction -> 'succès' et mettre à jour wallets.balance.



4. Teste en sandbox puis passe en production (met à jour clefs, URLs, vérifications).



Sécurité & recommandations:

N'expose jamais tes clefs sur le frontend.

Utilise HTTPS en production.

Vérifie les signatures HMAC/headers fournis par le PSP.

Limite les montants, ajoute des règles KYC avant acceptation de gros montants. */



