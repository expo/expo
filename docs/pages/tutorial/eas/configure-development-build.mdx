/*******************************************************
 * Data APK Backend (Node.js / Express)
 * - Verify Paystack payment
 * - Call VTpass to deliver data
 * - Save transactions to SQLite (MVP)
 *
 * Install:
 * npm init -y
 * npm install express axios dotenv sqlite3 raw-body
 *
 * Run:
 * node server.js
 *******************************************************/
require("dotenv").config();
const express = require("express");
const axios = require("axios");
const sqlite3 = require("sqlite3").verbose();
const rawBody = require("raw-body"); // for webhook signature verification

const app = express();

// Use JSON body parsing for normal routes
app.use(express.json());

// --- Simple SQLite setup (file: data_apk.db) ---
const db = new sqlite3.Database("./data_apk.db", (err) => {
  if (err) return console.error("DB open error:", err.message);
  console.log("SQLite DB opened.");
});

// Create transactions table if not exists
db.run(
  `CREATE TABLE IF NOT EXISTS transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    request_id TEXT,
    phone TEXT,
    network TEXT,
    variation_code TEXT,
    amount INTEGER,
    paystack_ref TEXT,
    paystack_status TEXT,
    vtpass_response TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )`
);

// Helper: insert transaction
function saveTransaction(tx, cb = () => {}) {
  const stmt = db.prepare(
    `INSERT INTO transactions (request_id, phone, network, variation_code, amount, paystack_ref, paystack_status, vtpass_response)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?)`
  );
  stmt.run(
    tx.request_id,
    tx.phone,
    tx.network,
    tx.variation_code,
    tx.amount,
    tx.paystack_ref || null,
    tx.paystack_status || null,
    tx.vtpass_response || null,
    function (err) {
      if (err) console.error("DB insert error:", err);
      cb(err, this.lastID);
    }
  );
  stmt.finalize();
}

// Home
app.get("/", (req, res) => {
  res.send("Data APK Backend ✅ Running");
});

/**
 * POST /verify-payment
 * Body: { reference, phone, network, variation_code, amount }
 *
 * Flow:
 *  - Verify payment with Paystack API
 *  - If success -> call VTpass to deliver data
 *  - Save transaction record
 */
app.post("/verify-payment", async (req, res) => {
  const { reference, phone, network, variation_code, amount } = req.body;
  if (!reference || !phone || !network || !variation_code) {
    return res.status(400).json({ success: false, error: "Missing required fields." });
  }

  try {
    // 1) Verify payment with Paystack
    const paystackVerifyUrl = `https://api.paystack.co/transaction/verify/${encodeURIComponent(reference)}`;
    const paystackRes = await axios.get(paystackVerifyUrl, {
      headers: {
        Authorization: `Bearer ${process.env.PAYSTACK_SECRET}`
      }
    });

    const payData = paystackRes.data;
    const status = payData?.data?.status;

    // Save initial tx record with paystack info (we'll update vtpass_response later)
    const requestId = "req_" + Date.now();
    const txRecord = {
      request_id: requestId,
      phone,
      network,
      variation_code,
      amount: amount || payData?.data?.amount || 0,
      paystack_ref: reference,
      paystack_status: status,
      vtpass_response: null
    };

    if (status === "success") {
      // 2) Payment successful -> call VTpass
      const vtResult = await vtpassBuyData({
        request_id: requestId,
        serviceID: network,
        billersCode: phone,
        variation_code
      });

      txRecord.vtpass_response = JSON.stringify(vtResult?.data || vtResult);

      // Save tx (successful)
      saveTransaction(txRecord);

      // Respond with both paystack and vtpass results
      return res.json({
        success: true,
        message: "Payment verified and VTpass called.",
        paystack: payData,
        vtpass: vtResult.data || vtResult
      });
    } else {
      // Payment not successful
      saveTransaction(txRecord);
      return res.status(400).json({
        success: false,
        message: "Payment not successful.",
        paystack: payData
      });
    }
  } catch (err) {
    console.error("verify-payment error:", err.response?.data || err.message || err);
    return res.status(500).json({ success: false, error: "Server error verifying payment." });
  }
});

/**
 * POST /vtpass-test
 * Quick route to manually call VTpass (handy for testing)
 * Body: { phone, network, variation_code }
 */
app.post("/vtpass-test", async (req, res) => {
  const { phone, network, variation_code } = req.body;
  if (!phone || !network || !variation_code) {
    return res.status(400).json({ success: false, error: "Missing fields." });
  }
  try {
    const requestId = "manual_" + Date.now();
    const vtResult = await vtpassBuyData({
      request_id: requestId,
      serviceID: network,
      billersCode: phone,
      variation_code
    });

    res.json({ success: true, vtpass: vtResult.data || vtResult });
  } catch (err) {
    console.error("vtpass-test error:", err.response?.data || err.message || err);
    res.status(500).json({ success: false, error: "VTpass error" });
  }
});

/**
 * Paystack Webhook Listener (optional)
 * - Verify signature (recommended)
 * - Handle async events from Paystack
 */
app.post("/paystack-webhook", async (req, res) => {
  try {
    // Get raw body to verify signature
    const raw = await rawBody(req);
    const signature = req.headers["x-paystack-signature"];
    if (process.env.PAYSTACK_SECRET && signature) {
      const crypto = require("crypto");
      const expected = crypto.createHmac("sha512", process.env.PAYSTACK_SECRET).update(raw).digest("hex");
      if (signature !== expected) {
        console.warn("Webhook signature mismatch.");
        return res.status(400).send("Invalid signature");
      }
    }
    const event = JSON.parse(raw.toString());
    console.log("Paystack webhook event:", event.event);
    // Example: when transaction.success -> you could call vtpass here if you included metadata
    // For safety, we recommend verifying with Paystack verify endpoint before delivering.
    res.sendStatus(200);
  } catch (err) {
    console.error("Webhook error:", err);
    res.sendStatus(500);
  }
});

/**
 * Helper: call VTpass API
 * Uses sandbox URL if VTPASS_ENV=sandbox (default)
 */
async function vtpassBuyData({ request_id, serviceID, billersCode, variation_code }) {
  const isSandbox = (process.env.VTPASS_ENV || "sandbox") === "sandbox";
  const url = isSandbox ? "https://sandbox.vtpass.com/api/pay" : "https://vtpass.com/api/pay";

  const payload = {
    request_id,
    serviceID,
    billersCode,
    variation_code,
    phone: billersCode // vtpass expects phone as well
  };

  const auth = {
    username: process.env.VTPASS_API_KEY,
    password: process.env.VTPASS_SECRET
  };

  // Call VTpass
  const res = await axios.post(url, payload, {
    auth,
    headers: { "Content-Type": "application/json" },
    timeout: 20000
  });
  return res;
}

// Start server
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`✅ Server running on port ${PORT}`));
