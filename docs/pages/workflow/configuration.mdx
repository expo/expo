import React, { useState, useEffect, useMemo } from 'react';
import { 
  LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer, ReferenceLine, AreaChart, Area, Cell, Legend
} from 'recharts';
import { 
  LayoutDashboard, Calendar, List, Plus, TrendingUp, TrendingDown, 
  Target, DollarSign, Trash2, X, ChevronLeft, ChevronRight, PieChart, Activity, AlertTriangle, Clock, ArrowUpCircle, ArrowDownCircle, Layers, BarChart2, Zap, Globe
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, Timestamp, where 
} from 'firebase/firestore';

// --- Configuração do Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof app_id !== 'undefined' ? app_id : 'default-app-id';

// --- Utilitários ---
const formatCurrency = (value, currency) => {
  const locale = currency === 'BRL' ? 'pt-BR' : 'en-US';
  return new Intl.NumberFormat(locale, { style: 'currency', currency: currency }).format(value);
};

const formatDate = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString + 'T00:00:00'); 
  return new Intl.DateTimeFormat('pt-BR').format(date);
};

// --- Listas de Ativos Padrão ---
const ASSET_GROUPS = {
  "B3 (Brasil)": [
    "WIN (Mini Índice)", "WDO (Mini Dólar)", 
    "PETR4", "VALE3", "ITUB4", "BBDC4", "BBAS3", "WEGE3", "ABEV3", "PRIO3", "RENT3"
  ],
  "Índices Americanos": [
    "NAS100 (Nasdaq)", "SP500 (S&P 500)", "US30 (Dow Jones)", "US2000 (Russell 2000)"
  ],
  "Forex Majors": [
    "EURUSD", "GBPUSD", "USDJPY", "USDCAD", "AUDUSD", "NZDUSD", "USDCHF"
  ],
  "Forex JPY & Crosses": [
    "GBPJPY", "EURJPY", "AUDJPY", "CADJPY", "CHFJPY", "NZDJPY",
    "EURGBP", "EURAUD", "GBPAUD", "GBPCAD"
  ],
  "Índices Globais": [
    "DAX40 (Alemanha)", "UK100 (Londres)", "JP225 (Nikkei)", "HK50 (Hong Kong)", "EU50 (Europa)", "CN50 (China)"
  ],
  "Cripto": [
    "BTCUSD", "ETHUSD", "SOLUSD", "BNBUSD", "XRPUSD", "ADAUSD", "DOGEUSD", "LTCUSD", "MATICUSD"
  ],
  "Commodities": [
    "XAUUSD (Ouro)", "XAGUSD (Prata)", "WTI (Petróleo)", "BRENT (Petróleo)", "HG (Cobre)", "NG (Gás Natural)"
  ]
};

// --- Componentes UI ---

const Card = ({ children, className = "" }) => (
  <div className={bg-slate-900 border border-slate-800 rounded-xl p-5 shadow-sm ${className}}>
    {children}
  </div>
);

const Button = ({ children, onClick, variant = 'primary', className = "", ...props }) => {
  const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2";
  const variants = {
    primary: "bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-500/20",
    danger: "bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20",
    ghost: "text-slate-400 hover:text-white hover:bg-slate-800",
    success: "bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-500/20"
  };
  return (
    <button onClick={onClick} className={${baseStyle} ${variants[variant]} ${className}} {...props}>
      {children}
    </button>
  );
};

const MetricCard = ({ title, value, subtext, type = 'neutral', icon: Icon }) => {
  const colors = {
    positive: "text-emerald-400",
    negative: "text-rose-400",
    neutral: "text-blue-400",
    warning: "text-amber-400"
  };
  
  return (
    <Card>
      <div className="flex justify-between items-start mb-2">
        <h3 className="text-slate-400 text-sm font-medium">{title}</h3>
        {Icon && <Icon size={18} className="text-slate-500" />}
      </div>
      <div className={text-2xl font-bold ${colors[type] || "text-white"}}>
        {value}
      </div>
      {subtext && <div className="text-xs text-slate-500 mt-1">{subtext}</div>}
    </Card>
  );
};

// --- Modals ---

const AddTradeModal = ({ isOpen, onClose, onSave, currency }) => {
  const [formData, setFormData] = useState({
    symbol: 'WIN (Mini Índice)',
    type: 'Long',
    entryDate: new Date().toISOString().split('T')[0],
    pnl: '',
    setup: '',
    riskMultiple: '', // Novo campo para o R (Unidades)
    mistake: '',
    notes: ''
  });

  if (!isOpen) return null;

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave({
      ...formData,
      pnl: parseFloat(formData.pnl),
      riskMultiple: formData.riskMultiple ? parseFloat(formData.riskMultiple) : null,
      entryDate: formData.entryDate
    });
    setFormData({ symbol: 'WIN (Mini Índice)', type: 'Long', entryDate: new Date().toISOString().split('T')[0], pnl: '', setup: '', riskMultiple: '', mistake: '', notes: '' });
    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
      <div className="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
        <div className="p-6 border-b border-slate-800 flex justify-between items-center">
          <h2 className="text-xl font-bold text-white">Novo Trade</h2>
          <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={20} /></button>
        </div>
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-medium text-slate-400 mb-1">Ativo/Símbolo</label>
              <select 
                required
                className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                value={formData.symbol}
                onChange={(e) => setFormData({...formData, symbol: e.target.value})}
              >
                 {Object.entries(ASSET_GROUPS).map(([group, assets]) => (
                    <optgroup key={group} label={group}>
                        {assets.map(asset => (
                            <option key={asset} value={asset}>{asset}</option>
                        ))}
                    </optgroup>
                 ))}
                 <option value="OUTROS">Outros</option>
              </select>
            </div>
            <div>
              <label className="block text-xs font-medium text-slate-400 mb-1">Direção</label>
              <select 
                className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                value={formData.type}
                onChange={(e) => setFormData({...formData, type: e.target.value})}
              >
                <option value="Long">Compra (Long)</option>
                <option value="Short">Venda (Short)</option>
              </select>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-medium text-slate-400 mb-1">Data</label>
              <input 
                required
                type="date" 
                className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                value={formData.entryDate}
                onChange={(e) => setFormData({...formData, entryDate: e.target.value})}
              />
            </div>
            <div>
              <label className="block text-xs font-medium text-slate-400 mb-1">P&L ({currency})</label>
              <input 
                required
                type="number" 
                step="0.01"
                placeholder="-50.00 ou 100.00"
                className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"

value={formData.pnl}
                onChange={(e) => setFormData({...formData, pnl: e.target.value})}
              />
            </div>
          </div>

          {/* Setup e Risco na mesma linha */}
          <div className="grid grid-cols-2 gap-4">
            <div>
                <label className="block text-xs font-medium text-slate-400 mb-1">Estratégia/Setup</label>
                <select 
                className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                value={formData.setup}
                onChange={(e) => setFormData({...formData, setup: e.target.value})}
                >
                <option value="">Selecione...</option>
                <option value="Pullback">Pullback</option>
                <option value="Fluxo">Fluxo</option>
                <option value="Reversão">Reversão</option>
                <option value="Rompimento">Rompimento</option>
                <option value="Consolidação">Consolidação</option>
                </select>
            </div>
            <div>
                <label className="block text-xs font-medium text-slate-400 mb-1">Retorno (R)</label>
                <input 
                type="number" 
                step="0.1"
                placeholder="Ex: 2.0 ou -1.0"
                className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                value={formData.riskMultiple}
                onChange={(e) => setFormData({...formData, riskMultiple: e.target.value})}
                />
            </div>
          </div>

          <div>
            <label className="block text-xs font-medium text-slate-400 mb-1">Erro / Fator Psicológico</label>
            <select 
              className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
              value={formData.mistake}
              onChange={(e) => setFormData({...formData, mistake: e.target.value})}
            >
              <option value="">Nenhum erro (Trade Técnico)</option>
              <option value="FOMO">FOMO (Entrei por impulso)</option>
              <option value="Hesitação">Hesitação (Entrei Tarde)</option>
              <option value="Saída Antecipada">Saída Antecipada (Mão de Alface)</option>
              <option value="Aumentou Lote">Aumentou Lote (Ganância)</option>
              <option value="Preço Médio">Preço Médio Contra</option>
              <option value="Revenge">Revenge Trading (Dia de Fúria)</option>
            </select>
          </div>

          <div className="pt-4 flex justify-end gap-3">
            <Button variant="ghost" type="button" onClick={onClose}>Cancelar</Button>
            <Button variant="primary" type="submit">Salvar Trade</Button>
          </div>
        </form>
      </div>
    </div>
  );
};

// --- Componentes de Visualização ---

const DashboardView = ({ trades, currency }) => {
  // Cálculos de Estatísticas Avançadas
  const stats = useMemo(() => {
    const totalPnl = trades.reduce((acc, t) => acc + t.pnl, 0);
    const wins = trades.filter(t => t.pnl > 0);
    const losses = trades.filter(t => t.pnl <= 0);
    
    // Básicos
    const winRate = trades.length > 0 ? (wins.length / trades.length) : 0;
    const avgWin = wins.length > 0 ? wins.reduce((acc, t) => acc + t.pnl, 0) / wins.length : 0;
    const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((acc, t) => acc + t.pnl, 0) / losses.length) : 0;
    const profitFactor = avgLoss > 0 ? ((winRate * avgWin) / ((1 - winRate) * avgLoss)) : 0;
    const pfSimple = avgLoss > 0 ? (wins.reduce((acc,t) => acc + t.pnl, 0) / Math.abs(losses.reduce((acc,t) => acc + t.pnl, 0))) : 0;

    // Expectativa Matemática
    const expectancy = (winRate * avgWin) - ((1 - winRate) * avgLoss);

// Dados para o Gráfico de Equidade (Acumulado)
    const sortedTrades = [...trades].sort((a, b) => new Date(a.entryDate) - new Date(b.entryDate));
    let runningTotal = 0;
    const chartData = sortedTrades.map((t, index) => {
      runningTotal += t.pnl;
      return {
        name: index + 1,
        date: formatDate(t.entryDate),
        pnl: t.pnl,
        equity: runningTotal
      };
    });

    // P&L por Ativo (Performance por Pasta)
    const assetStats = {};
    const assetSetups = {}; // Helper para rastrear setup por ativo

    trades.forEach(t => {
        const s = t.symbol || 'Outros';
        const setup = t.setup || 'Sem Setup';

        if (!assetStats[s]) assetStats[s] = { pnl: 0, wins: 0, losses: 0, total: 0 };
        assetStats[s].pnl += t.pnl;
        assetStats[s].total += 1;
        if (t.pnl > 0) assetStats[s].wins += 1;
        else assetStats[s].losses += 1;

        // Rastrear performance do setup neste ativo
        if (!assetSetups[s]) assetSetups[s] = {};
        if (!assetSetups[s][setup]) assetSetups[s][setup] = 0;
        assetSetups[s][setup] += t.pnl;
    });

    const assetData = Object.keys(assetStats).map(k => {
        // Encontrar o melhor e pior setup para este ativo
        const setups = assetSetups[k];
        let bestSetup = '-';
        let worstSetup = '-';
        let maxPnl = -Infinity;
        let minPnl = Infinity;
        
        // Verifica qual setup teve maior e menor lucro
        Object.entries(setups).forEach(([setupName, pnl]) => {
            if (pnl > maxPnl) {
                maxPnl = pnl;
                bestSetup = setupName;
            }
            if (pnl < minPnl) {
                minPnl = pnl;
                worstSetup = setupName;
            }
        });

        // Se não houver dados suficientes
        if (maxPnl === -Infinity) {
            bestSetup = 'Sem dados';
            maxPnl = 0;
        }
        if (minPnl === Infinity) {
            worstSetup = 'Sem dados';
            minPnl = 0;
        }

        return { 
            name: k.split(' ')[0],
            fullName: k,
            value: assetStats[k].pnl,
            wins: assetStats[k].wins,
            losses: assetStats[k].losses,
            bestSetup: bestSetup,
            bestSetupPnl: maxPnl,
            worstSetup: worstSetup,
            worstSetupPnl: minPnl
        };
    }).sort((a,b) => b.value - a.value);

    // P&L por Setup Geral
    const setupStats = {};
    trades.forEach(t => {
        const s = t.setup || 'Outros';
        if (!setupStats[s]) setupStats[s] = 0;
        setupStats[s] += t.pnl;
    });
    const setupData = Object.keys(setupStats).map(k => ({ name: k, value: setupStats[k] })).sort((a,b) => b.value - a.value);

    // P&L por Dia da Semana
    const dayStats = { 'Dom': 0, 'Seg': 0, 'Ter': 0, 'Qua': 0, 'Qui': 0, 'Sex': 0, 'Sáb': 0 };
    trades.forEach(t => {
        const dayName = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'][new Date(t.entryDate + 'T12:00:00').getDay()];
        dayStats[dayName] += t.pnl;
    });
    const dayData = Object.keys(dayStats).map(k => ({ name: k, value: dayStats[k] }));

    // Long vs Short
    const longPnl = trades.filter(t => t.type === 'Long').reduce((acc, t) => acc + t.pnl, 0);
    const shortPnl = trades.filter(t => t.type === 'Short').reduce((acc, t) => acc + t.pnl, 0);

    return { 
        totalPnl, winRate: winRate * 100, profitFactor: pfSimple, 
        chartData, totalTrades: trades.length, avgWin, avgLoss, 
        expectancy, setupData, dayData, assetData, longPnl, shortPnl 
    };
  }, [trades]);

  return (
    <div className="space-y-6 animate-fade-in pb-10">
      {/* Cards de Métricas Principais */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <MetricCard

title="P&L Líquido" 
          value={formatCurrency(stats.totalPnl, currency)} 
          type={stats.totalPnl >= 0 ? 'positive' : 'negative'}
          icon={DollarSign}
        />
        <MetricCard 
          title="Taxa de Acerto" 
          value={${stats.winRate.toFixed(1)}%} 
          subtext={${stats.totalTrades} Trades totais}
          type={stats.winRate >= 50 ? 'positive' : 'negative'}
          icon={Target}
        />
        <MetricCard 
          title="Expectativa / Trade" 
          value={formatCurrency(stats.expectancy, currency)}
          subtext="Valor esperado por operação"
          type={stats.expectancy > 0 ? 'positive' : 'negative'}
          icon={Activity}
        />
        <MetricCard 
          title="Fator de Lucro" 
          value={stats.profitFactor.toFixed(2)} 
          type={stats.profitFactor >= 1.5 ? 'positive' : 'neutral'}
          icon={PieChart}
        />
      </div>

      {/* Gráfico Principal: Curva de Equidade */}
      <Card className="h-80">
        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
          <TrendingUp className="text-blue-500" size={20} />
          Curva de Equidade
        </h3>
        <ResponsiveContainer width="100%" height="100%">
          <AreaChart data={stats.chartData}>
            <defs>
              <linearGradient id="colorEquity" x1="0" y1="0" x2="0" y2="1">
                <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3}/>
                <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
              </linearGradient>
            </defs>
            <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" vertical={false} />
            <XAxis dataKey="name" stroke="#64748b" tick={{fontSize: 12}} tickLine={false} axisLine={false} />
            <YAxis stroke="#64748b" tick={{fontSize: 12}} tickFormatter={(val) => formatCurrency(val, currency).replace(/\s/g, '').replace(',00', '')} tickLine={false} axisLine={false} />
            <RechartsTooltip 
              contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#fff' }}
              itemStyle={{ color: '#fff' }}
              formatter={(value) => formatCurrency(value, currency)}
              labelFormatter={(label) => Trade #${label}}
            />
            <ReferenceLine y={0} stroke="#475569" />
            <Area type="monotone" dataKey="equity" stroke="#3b82f6" strokeWidth={3} fillOpacity={1} fill="url(#colorEquity)" />
          </AreaChart>
        </ResponsiveContainer>
      </Card>

      {/* Seção de Detalhamento por Ativo (O Placar) */}
      <div className="space-y-4">
        <h3 className="text-xl font-bold text-white flex items-center gap-2">
            <Layers className="text-emerald-500" size={24} />
            Detalhamento por Ativo
        </h3>
        
        {/* Gráfico de Barras */}
        <Card className="h-80">
            <ResponsiveContainer width="100%" height="100%">
                <BarChart data={stats.assetData} layout="vertical" margin={{left: 30}}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" horizontal={false} />
                    <XAxis type="number" stroke="#64748b" tickFormatter={(val) => formatCurrency(val, currency).replace(',00','')} />
                    <YAxis type="category" dataKey="name" stroke="#94a3b8" width={60} tick={{fontSize: 11, fontWeight: 'bold'}} />
                    <RechartsTooltip 
                        cursor={{fill: '#1e293b'}}
                        contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#fff' }}
                        formatter={(value) => [formatCurrency(value, currency), "P&L Total"]}
                    />
                    <Bar dataKey="value" radius={[0, 4, 4, 0]}>

{stats.assetData.map((entry, index) => (
                            <Cell key={cell-${index}} fill={entry.value >= 0 ? '#10b981' : '#f43f5e'} />
                        ))}
                    </Bar>
                </BarChart>
            </ResponsiveContainer>
        </Card>

        {/* Cards de Placar por Ativo */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {stats.assetData.map((asset) =>
