// App.js (Ú©Ø§Ù…Ù„Ø§Ù‹ ÛŒÚ©â€ŒÙØ§ÛŒÙ„ÛŒ - VideoTalk MVP with API integration)
// ØªÙˆØ¬Ù‡: Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ BASE_URL Ø±Ø§ Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± Ø®ÙˆØ¯Øª ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡.

import React, { useState, useEffect, useRef } from "react";
import {
  View, Text, TouchableOpacity, TextInput, StyleSheet, FlatList, Image,
  Alert, SafeAreaView, ScrollView, Dimensions, ActivityIndicator, Platform
} from "react-native";
import axios from "axios";
import { NavigationContainer } from "@react-navigation/native";
import { createNativeStackNavigator } from "@react-navigation/native-stack";
import { createBottomTabNavigator } from "@react-navigation/bottom-tabs";
import * as ImagePicker from 'expo-image-picker';
import * as Contacts from 'expo-contacts';
import { Video } from 'expo-av';
import { WebView } from 'react-native-webview';
import AsyncStorage from '@react-native-async-storage/async-storage';

// ---------- Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ----------
const BASE_URL = "https://your-server.example.com"; // <<--- Ø§ÛŒÙ† Ø±Ø§ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡
const windowWidth = Dimensions.get("window").width;
const windowHeight = Dimensions.get("window").height;

// ---------- Ú©Ù…Ú©ÛŒâ€ŒÙ‡Ø§ÛŒ API ----------
const api = axios.create({
  baseURL: BASE_URL,
  timeout: 20000,
});

async function saveToken(token) {
  try { await AsyncStorage.setItem("VT_token", token); } catch (e) {}
}
async function getToken() {
  try { return await AsyncStorage.getItem("VT_token"); } catch (e) { return null; }
}
async function authHeader() {
  const t = await getToken(); return t ? { Authorization: `Bearer ${t}` } : {};
}

// ---------- ØµÙØ­Ù‡ Auth (ÙˆØ±ÙˆØ¯/Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…) ----------
function AuthScreen({ navigation }) {
  const [mode, setMode] = useState("login"); // login | signup
  const [identifier, setIdentifier] = useState(""); // phone or email
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);

  const handle = async () => {
    if (!identifier || !password) { Alert.alert("Ø®Ø·Ø§", "Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"); return; }
    setLoading(true);
    try {
      const url = mode === "login" ? "/api/auth/login" : "/api/auth/signup";
      const res = await api.post(url, { identifier, password });
      if (res.data?.token) {
        await saveToken(res.data.token);
        navigation.replace("MainTabs");
      } else throw new Error("Ø¨Ø¯ÙˆÙ† ØªÙˆÚ©Ù†");
    } catch (err) {
      console.error(err);
      Alert.alert("Ø®Ø·Ø§", err.response?.data?.message || err.message || "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„");
    } finally { setLoading(false); }
  };

  return (
    <SafeAreaView style={styles.container}>
      <Text style={styles.h1}>VideoTalk</Text>
      <Text style={styles.p}>ÙˆØ±ÙˆØ¯ ÛŒØ§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡</Text>
      <View style={{ width: "90%" }}>
        <TextInput placeholder="Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡" value={identifier} onChangeText={setIdentifier} style={styles.input} />
        <TextInput placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" value={password} onChangeText={setPassword} secureTextEntry style={styles.input} />
        <TouchableOpacity style={styles.primaryBtn} onPress={handle} disabled={loading}>
          {loading ? <ActivityIndicator color="#fff" /> : <Text style={{color:"#fff"}}>{mode==="login"?"ÙˆØ±ÙˆØ¯":"Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…"}</Text>}
        </TouchableOpacity>
        <TouchableOpacity onPress={() => setMode(mode==="login"?"signup":"login")}>
          <Text style={{color:"#09f", marginTop:12}}>{mode==="login"?"Ù†Ø¯Ø§Ø±ÛŒØŸ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…":"Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø±ÛŒØŸ ÙˆØ±ÙˆØ¯"}</Text>
        </TouchableOpacity>
      </View>
    </SafeAreaView>
  );
}

// ---------- Home (Shorts feed: Ø¹Ù…ÙˆØ¯ÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ Ú©ÙˆØªØ§Ù‡) ----------
function HomeShortsScreen({ navigation }) {
  const [shorts, setShorts] = useState([]);
  const [loading, setLoading] = useState(false);

  const load = async () => {
    setLoading(true);
    try {
      const headers = await authHeader();
      const res = await api.get("/api/shorts", { headers });
      setShorts(res.data || []);
    } catch (err) {
      console.error(err);
      Alert.alert("Ø®Ø·Ø§", "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ±Øªâ€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯");
    } finally { setLoading(false); }
  };

  useEffect(() => { load(); }, []);

  if (loading) return <View style={styles.center}><ActivityIndicator /></View>;
  if (!shorts.length) return <View style={styles.center}><Text style={{color:"#fff"}}>Ø´ÙˆØ±Øª ÙˆÛŒØ¯Ø¦Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</Text></View>;

  return (
    <FlatList
      data={shorts}
      keyExtractor={i=>i.id}
      renderItem={({item}) => (
        <View style={{ height: windowHeight, backgroundColor:"#000", justifyContent:"center", alignItems:"center" }}>
          <Video
            source={{ uri: item.uri }}
            rate={1.0}
            isLooping
            resizeMode="cover"
            shouldPlay
            useNativeControls={false}
            style={{ width: "100%", height: "100%" }}
          />
          <View style={{ position:"absolute", left:10, bottom:30 }}>
            <Text style={{ color:"#fff", fontSize:18 }}>{item.title}</Text>
            <Text style={{ color:"#ddd" }}>{item.channelName}</Text>
          </View>
          <View style={{ position:"absolute", right:12, bottom:80 }}>
            <TouchableOpacity style={styles.iconCircle}><Text style={{color:"#fff"}}>â¤</Text></TouchableOpacity>
            <TouchableOpacity style={[styles.iconCircle,{marginTop:12}]}><Text style={{color:"#fff"}}>ğŸ’¬</Text></TouchableOpacity>
            <TouchableOpacity style={[styles.iconCircle,{marginTop:12}]}><Text style={{color:"#fff"}}>â†—</Text></TouchableOpacity>
          </View>
        </View>
      )}
      pagingEnabled
      horizontal={false}
    />
  );
}

// ---------- Long Videos screen (Video feed) ----------
function VideosScreen() {
  const [videos, setVideos] = useState([]);
  const [loading, setLoading] = useState(false);
  useEffect(() => {
    (async ()=> {
      setLoading(true);
      try {
        const res = await api.get("/api/videos");
        setVideos(res.data || []);
      } catch(e) { console.error(e); Alert.alert("Ø®Ø·Ø§","Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ Ù†Ø´Ø¯"); }
      setLoading(false);
    })();
  }, []);
  if (loading) return <View style={styles.center}><ActivityIndicator/></View>;
  return (
    <FlatList
      data={videos}
      keyExtractor={v=>v.id}
      renderItem={({item}) => (
        <View style={{ padding: 10 }}>
          <Text style={{ color:"#fff", fontWeight:"bold" }}>{item.title}</Text>
          <Video source={{uri: item.uri}} useNativeControls style={{ width:"100%", height:240, backgroundColor:"#000" }} />
        </View>
      )}
    />
  );
}

// ---------- Channels & Groups screen ----------
function ChannelsScreen({ navigation }) {
  const [channels, setChannels] = useState([]);
  const [query, setQuery] = useState("");
  const [loading, setLoading] = useState(false);

  const load = async () => {
    setLoading(true);
    try {
      const headers = await authHeader();
      const res = await api.get("/api/channels", { headers });
      setChannels(res.data || []);
    } catch (e) { console.error(e); Alert.alert("Ø®Ø·Ø§","Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚"); }
    setLoading(false);
  };

  useEffect(()=> { load(); }, []);

  const filtered = channels.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));

  return (
    <View style={{flex:1, backgroundColor:"#000"}}>
      <View style={styles.searchRow}>
        <TextInput style={styles.searchInput} placeholder="Ø¬Ø³ØªØ¬Ùˆ Ú©Ø§Ù†Ø§Ù„ ÛŒØ§ Ú¯Ø±ÙˆÙ‡..." placeholderTextColor="#999" value={query} onChangeText={setQuery} />
        <TouchableOpacity style={styles.smallBtn} onPress={() => navigation.navigate("CreateChoice")}>
          <Text style={{color:"#fff"}}>+</Text>
        </TouchableOpacity>
      </View>
      {loading ? <ActivityIndicator style={{marginTop:20}}/> :
      <FlatList data={filtered} keyExtractor={i=>i.id} renderItem={({item}) => (
        <TouchableOpacity style={styles.channelRow} onPress={()=>navigation.navigate("ChannelProfile", { channelId: item.id })}>
          <Text style={{color:"#fff", fontSize:16}}>{item.name}</Text>
          <Text style={{color:"#aaa"}}>ğŸ‘¥ {item.followers} â€¢ ğŸ‘€ {item.views}</Text>
        </TouchableOpacity>
      )} />}
    </View>
  );
}

// ---------- CreateChoice screen (Add Group or Channel UI) ----------
function CreateChoiceScreen({ navigation }) {
  return (
    <View style={styles.center}>
      <View style={{ width:"90%", backgroundColor:"#111", padding:16, borderRadius:8 }}>
        <Text style={{color:"#fff", fontSize:18, marginBottom:12}}>Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†</Text>
        <TouchableOpacity style={styles.primaryBtn} onPress={() => navigation.navigate("CreateGroup")}>
          <Text style={{color:"#fff"}}>Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú¯Ø±ÙˆÙ‡</Text>
        </TouchableOpacity>
        <TouchableOpacity style={[styles.primaryBtn,{marginTop:10}]} onPress={() => navigation.navigate("CreateChannel")}>
          <Text style={{color:"#fff"}}>Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†Ø§Ù„</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}

// ---------- Create Group: picks contacts and sends to API ----------
function CreateGroupScreen({ navigation }) {
  const [selected, setSelected] = useState([]);
  const [contacts, setContacts] = useState([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    (async () => {
      const { status } = await Contacts.requestPermissionsAsync();
      if (status !== 'granted') { Alert.alert("Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø®Ø§Ø·Ø¨ÛŒÙ† Ù„Ø§Ø²Ù… Ø§Ø³Øª"); return; }
      const { data } = await Contacts.getContactsAsync({ fields: [Contacts.Fields.PhoneNumbers] });
      setContacts(data || []);
    })();
  }, []);

  const toggle = (c) => {
    setSelected(prev => prev.some(x=>x.id===c.id) ? prev.filter(x=>x.id!==c.id) : [...prev,c]);
  };

  const create = async () => {
    if (!selected.length) { Alert.alert("Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡"); return; }
    try {
      setLoading(true);
      const headers = await authHeader();
      const members = selected.map(s => s.phoneNumbers?.[0]?.number).filter(Boolean);
      await api.post("/api/groups", { members }, { headers });
      Alert.alert("Ú¯Ø±ÙˆÙ‡ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯");
      navigation.goBack();
    } catch (e) {
      console.error(e);
      Alert.alert("Ø®Ø·Ø§", "Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡ Ù†Ø§Ù…ÙˆÙÙ‚");
    } finally { setLoading(false); }
  };

  return (
    <View style={{flex:1, backgroundColor:"#000"}}>
      <Text style={{color:"#fff", padding:12}}>Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø®Ø§Ø·Ø¨ÛŒÙ† ({selected.length})</Text>
      <FlatList data={contacts} keyExtractor={i=>i.id} renderItem={({item}) => (
        <TouchableOpacity onPress={()=>toggle(item)} style={{padding:12, borderBottomWidth:1, borderColor:"#111"}}>
          <Text style={{color:"#fff"}}>{item.name} {selected.some(s=>s.id===item.id) && <Text style={{color:"#0f0"}}> âœ“</Text>}</Text>
          <Text style={{color:"#aaa"}}>{item.phoneNumbers?.[0]?.number||"Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡"}</Text>
        </TouchableOpacity>
      )} />
      <TouchableOpacity style={[styles.primaryBtn,{margin:12}]} onPress={create} disabled={loading}>
        <Text style={{color:"#fff"}}>{loading?"Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª...":"Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡"}</Text>
      </TouchableOpacity>
    </View>
  );
}

// ---------- Create Channel Screen ----------
function CreateChannelScreen({ navigation }) {
  const [name, setName] = useState("");
  const create = async () => {
    if (!name.trim()) { Alert.alert("Ù†Ø§Ù… Ú©Ø§Ù†Ø§Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"); return; }
    try {
      const headers = await authHeader();
      await api.post("/api/channels", { name }, { headers });
      Alert.alert("Ú©Ø§Ù†Ø§Ù„ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯");
      navigation.goBack();
    } catch (e) { console.error(e); Alert.alert("Ø®Ø·Ø§","Ø³Ø§Ø®Øª Ú©Ø§Ù†Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚"); }
  };
  return (
    <View style={styles.center}>
      <TextInput placeholder="Ù†Ø§Ù… Ú©Ø§Ù†Ø§Ù„" placeholderTextColor="#888" value={name} onChangeText={setName} style={styles.input} />
      <TouchableOpacity style={styles.primaryBtn} onPress={create}><Text style={{color:"#fff"}}>Ø³Ø§Ø®Øª Ú©Ø§Ù†Ø§Ù„</Text></TouchableOpacity>
    </View>
  );
}

// ---------- Channel Profile screen ----------
function ChannelProfileScreen({ route, navigation }) {
  const channelId = route.params?.channelId;
  const [channel, setChannel] = useState(null);
  const [isFollowing, setIsFollowing] = useState(false);

  useEffect(()=> {
    (async ()=>{
      try {
        const headers = await authHeader();
        const res = await api.get(`/api/channels/${channelId}`, { headers });
        setChannel(res.data);
        // optionally fetch follow status
      } catch(e){ console.error(e); Alert.alert("Ø®Ø·Ø§","Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù†Ø§Ù„"); }
    })();
  }, [channelId]);

  if (!channel) return <View style={styles.center}><ActivityIndicator/></View>;

  const follow = async () => {
    try {
      const headers = await authHeader();
      await api.post(`/api/channels/${channelId}/follow`, {}, { headers });
      setIsFollowing(true);
    } catch(e){ console.error(e); Alert.alert("Ø®Ø·Ø§","Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚"); }
  };

  const message = () => { navigation.navigate("Inbox", { startConversationWith: channel.name }); };
  const call = () => { Alert.alert("ØªÙ…Ø§Ø³","Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙ…Ø§Ø³ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)"); };

  return (
    <ScrollView style={{flex:1, backgroundColor:"#000"}}>
      <View style={styles.channelHeader}>
        <View>
          <Text style={styles.channelTitleLarge}>{channel.name}</Text>
          <Text style={{color:"#aaa"}}>ğŸ‘¥ {channel.followers} â€¢ ğŸ‘¤ {channel.following} â€¢ ğŸ‘€ {channel.views}</Text>
        </View>
        <View style={{flexDirection:"row"}}>
          <TouchableOpacity style={[styles.smallBtn,{backgroundColor:isFollowing?"#333":"#0095f6"}]} onPress={follow}><Text style={{color:"#fff"}}>{isFollowing?"Following":"Follow"}</Text></TouchableOpacity>
          <TouchableOpacity style={[styles.smallBtn,{marginLeft:8, backgroundColor:"#444"}]} onPress={message}><Text style={{color:"#fff"}}>Message</Text></TouchableOpacity>
          <TouchableOpacity style={[styles.smallBtn,{marginLeft:8, backgroundColor:"#666"}]} onPress={call}><Text style={{color:"#fff"}}>Call</Text></TouchableOpacity>
        </View>
      </View>
      <FlatList data={channel.videos} keyExtractor={v=>v.id} renderItem={({item})=>(
        <View style={{padding:12}}>
          <Text style={{color:"#fff"}}>{item.title}</Text>
          <Video source={{uri:item.uri}} useNativeControls style={{width:"100%", height:220}} />
        </View>
      )} />
    </ScrollView>
  );
}

// ---------- Inbox / Messages (Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ø®Ø§Ø·Ø¨ÛŒÙ†) ----------
function InboxScreen({ route }) {
  const [convs, setConvs] = useState([]);
  const [loading, setLoading] = useState(false);
  useEffect(()=> {
    (async ()=> {
      setLoading(true);
      try {
        const headers = await authHeader();
        const res = await api.get("/api/conversations", { headers });
        setConvs(res.data || []);
      } catch(e) { console.error(e); Alert.alert("Ø®Ø·Ø§","Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚"); }
      setLoading(false);
    })();
  }, []);

  // Ø§Ú¯Ø± route.params.startConversationWith Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ù‡ØŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¢ØºØ§Ø²ÛŒÙ†
  useEffect(() => {
    if (route?.params?.startConversationWith) {
      const name = route.params.startConversationWith;
      setConvs(prev => [{ id:`tmp-${Date.now()}`, with:name, last:`${name} Ø¨Ù‡ VideoTalk Ù¾ÛŒÙˆØ³Øª` }, ...prev]);
    }
  }, [route?.params?.startConversationWith]);

  if (loading) return <View style={styles.center}><ActivityIndicator/></View>;

  return (
    <FlatList data={convs} keyExtractor={i=>i.id} renderItem={({item})=>(
      <View style={styles.conversationItem}>
        <Text style={{color:"#fff", fontSize:16}}>{item.with}</Text>
        <Text style={{color:"#aaa"}}>{item.last}</Text>
      </View>
    )} />
  );
}

// ---------- Add Post + Filters (ØªØµÙˆÛŒØ± ØªØ³ØªÛŒ + overlay filters) ----------
function AddPostScreen({ navigation, route }) {
  const [image, setImage] = useState(null);
  const [filters, setFilters] = useState([]);

  useEffect(()=> {
    // ØªÙˆÙ„ÛŒØ¯ 150 ÙÛŒÙ„ØªØ± Ø³Ø§Ø¯Ù‡ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡ (tint/opacity)
    const arr = Array.from({length:150}).map((_,i)=> {
      const r = Math.floor((Math.sin(i*0.21)+1)*120)%256;
      const g = Math.floor((Math.cos(i*0.17)+1)*120)%256;
      const b = Math.floor((Math.sin(i*0.13+2)+1)*120)%256;
      const op = 0.05 + (Math.abs(Math.sin(i*0.11))*0.65);
      return { id:`f${i}`, name:`ÙÛŒÙ„ØªØ± ${i+1}`, tint:`rgba(${r},${g},${b},${op.toFixed(2)})`, opacity:op };
    });
    setFilters(arr);
  }, []);

  const pickImage = async () => {
    const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
    if (status !== 'granted') { Alert.alert("Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú¯Ø§Ù„Ø±ÛŒ Ù„Ø§Ø²Ù… Ø§Ø³Øª"); return; }
    const res = await ImagePicker.launchImageLibraryAsync({ mediaTypes: ImagePicker.MediaTypeOptions.Images, quality: 0.7 });
    if (!res.cancelled) setImage(res.uri);
  };

  const takePhoto = async () => {
    const { status } = await ImagePicker.requestCameraPermissionsAsync();
    if (status !== 'granted') { Alert.alert("Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù„Ø§Ø²Ù… Ø§Ø³Øª"); return; }
    const res = await ImagePicker.launchCameraAsync({ quality:0.7 });
    if (!res.cancelled) setImage(res.uri);
  };

  const publish = async (filter) => {
    try {
      const headers = await authHeader();
      const body = new FormData();
      body.append("caption", `Filter: ${filter.name}`);
      if (image) {
        const filename = image.split('/').pop();
        const match = /\.(\w+)$/.exec(filename);
        const type = match ? `image/${match[1]}` : `image`;
        body.append("file", { uri: image, name: filename, type });
      }
      // Example: /api/posts expects multipart
      await api.post("/api/posts", body, { headers: { ...headers, 'Content-Type': 'multipart/form-data' } });
      Alert.alert("Ù…Ù†ØªØ´Ø± Ø´Ø¯", `Ù¾Ø³Øª Ø¨Ø§ ${filter.name} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯`);
      navigation.navigate("HomeMain");
    } catch(e) { console.error(e); Alert.alert("Ø®Ø·Ø§","Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚"); }
  };

  return (
    <View style={{flex:1, backgroundColor:"#000"}}>
      <View style={{flexDirection:"row", justifyContent:"space-around", padding:8}}>
        <TouchableOpacity style={styles.smallBtn} onPress={pickImage}><Text style={{color:"#fff"}}>Ú¯Ø§Ù„Ø±ÛŒ</Text></TouchableOpacity>
        <TouchableOpacity style={styles.smallBtn} onPress={takePhoto}><Text style={{color:"#fff"}}>Ø¯ÙˆØ±Ø¨ÛŒÙ†</Text></TouchableOpacity>
      </View>
      {!image ? <View style={styles.center}><Text style={{color:"#fff"}}>Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</Text></View> :
        <FlatList data={filters} keyExtractor={f=>f.id} numColumns={3} renderItem={({item})=> {
          const size = (windowWidth-48)/3;
          return (
            <TouchableOpacity onPress={()=>publish(item)} style={{margin:6}}>
              <View style={{ width:size, height:size, overflow:"hidden", borderRadius:8 }}>
                <Image source={{uri:image}} style={{width:"100%", height:"100%"}} />
                <View style={{position:"absolute", left:0, top:0, right:0, bottom:0, backgroundColor:item.tint}} />
              </View>
              <Text style={{color:"#fff", textAlign:"center", width:size}} numberOfLines={1}>{item.name}</Text>
            </TouchableOpacity>
          );
        }} />
      }
    </View>
  );
}

// ---------- GPT Chat screen (Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ú©Ù‡ Ø®ÙˆØ¯ Ø³Ø±ÙˆØ± Ø¨Ù‡ OpenAI ÙˆØµÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯) ----------
function GPTScreen() {
  const [messages, setMessages] = useState([{role:"system", text:"Ø´Ù…Ø§ Ø¯Ø³ØªÛŒØ§Ø± VideoTalk Ù‡Ø³ØªÛŒØ¯."}]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);

  const send = async () => {
    if (!input.trim()) return;
    const userMsg = { role:"user", text: input };
    setMessages(prev => [...prev, userMsg]);
    setInput("");
    setLoading(true);
    try {
      const headers = await authHeader();
      const res = await api.post("/api/gpt", { messages: [...messages, userMsg] }, { headers });
      const reply = res.data?.reply || "Ø¨Ø¯ÙˆÙ† Ù¾Ø§Ø³Ø®";
      setMessages(prev => [...prev, { role:"assistant", text: reply }]);
    } catch (e) {
      console.error(e);
      Alert.alert("Ø®Ø·Ø§","Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆÛŒØ³ GPT Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯");
    } finally { setLoading(false); }
  };

  return (
    <View style={{flex:1, backgroundColor:"#000"}}>
      <FlatList data={messages} keyExtractor={(m,i)=>i.toString()} renderItem={({item})=> (
        <View style={{padding:8, alignSelf:item.role==="user"?"flex-end":"flex-start", maxWidth:"80%"}}>
          <View style={{backgroundColor:item.role==="user"?"#0095f6":"#222", padding:10, borderRadius:8}}>
            <Text style={{color:"#fff"}}>{item.text}</Text>
          </View>
        </View>
      )} />
      <View style={{flexDirection:"row", padding:8, alignItems:"center"}}>
        <TextInput placeholder="Ù¾ÛŒØ§Ù…..." placeholderTextColor="#888" value={input} onChangeText={setInput} style={styles.chatInput} />
        <TouchableOpacity style={styles.primaryBtn} onPress={send} disabled={loading}><Text style={{color:"#fff"}}>{loading?"...":"Ø§Ø±Ø³Ø§Ù„"}</Text></TouchableOpacity>
      </View>
    </View>
  );
}

// ---------- Games screen (Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§ WebView) ----------
function GamesScreen() {
  const games = Array.from({length:200}).map((_,i)=>({
    id:`g${i+1}`, title:`Game ${i+1}`, url: `https://example.com/game/${i+1}` // Ø¨Ø§ÛŒØ¯ URL Ù‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø°Ø§Ø±ÛŒ
  }));
  const [selected, setSelected] = useState(null);
  if (selected) {
    return (
      <View style={{flex:1}}>
        <TouchableOpacity style={{padding:10}} onPress={()=>setSelected(null)}><Text style={{color:"#09f"}}>Ø¨Ø§Ø²Ú¯Ø´Øª</Text></TouchableOpacity>
        <WebView source={{ uri: selected.url }} style={{flex:1}} />
      </View>
    );
  }
  return (
    <FlatList data={games} keyExtractor={g=>g.id} renderItem={({item})=>(
      <TouchableOpacity style={{padding:12, borderBottomWidth:1, borderColor:"#111"}} onPress={()=>setSelected(item)}>
        <Text style={{color:"#fff"}}>{item.title}</Text>
      </TouchableOpacity>
    )} />
  );
}

// ---------- Profile screen ----------
function ProfileScreen() {
  const [profile, setProfile] = useState(null);
  useEffect(()=> {
    (async ()=> {
      try {
        const headers = await authHeader();
        const res = await api.get("/api/me", { headers });
        setProfile(res.data);
      } catch(e){ console.error(e); }
    })();
  }, []);
  if (!profile) return <View style={styles.center}><ActivityIndicator/></View>;
  return (
    <View style={styles.center}>
      <Image source={{uri: profile.avatar || SAMPLE_IMAGE}} style={{width:100, height:100, borderRadius:50}} />
      <Text style={{color:"#fff", marginTop:8}}>{profile.username}</Text>
      <Text style={{color:"#aaa"}}>ğŸ‘¥ {profile.followers} â€¢ ğŸ‘¤ {profile.following} â€¢ ğŸ‘€ {profile.views}</Text>
    </View>
  );
}

// ---------- Navigation setup ----------
const Stack = createNativeStackNavigator();
function HomeStack() {
  return (
    <Stack.Navigator>
      <Stack.Screen name="HomeMain" component={HomeShortsScreen} options={{ title: "Shorts" }} />
      <Stack.Screen name="ChannelProfile" component={ChannelProfileScreen} options={{ title: "Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ù†Ø§Ù„" }} />
      <Stack.Screen name="AddFilters" component={AddPostScreen} options={{ title: "Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø³Øª" }} />
      <Stack.Screen name="CreateChoice" component={CreateChoiceScreen} options={{ title: "Ø§ÙØ²ÙˆØ¯Ù†" }} />
      <Stack.Screen name="CreateGroup" component={CreateGroupScreen} options={{ title: "Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡" }} />
      <Stack.Screen name="CreateChannel" component={CreateChannelScreen} options={{ title: "Ø³Ø§Ø®Øª Ú©Ø§Ù†Ø§Ù„" }} />
      <Stack.Screen name="ChannelsList" component={ChannelsScreen} options={{ title: "Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ùˆ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§" }} />
      <Stack.Screen name="Inbox" component={InboxScreen} options={{ title: "Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§" }} />
    </Stack.Navigator>
  );
}

const Tab = createBottomTabNavigator();

// ---------- App main ----------
export default function App() {
  const [ready, setReady] = useState(false);
  const [isLogged, setIsLogged] = useState(false);

  useEffect(()=> {
    (async ()=> {
      const token = await getToken();
      setIsLogged(!!token);
      setReady(true);
    })();
  }, []);

  if (!ready) return <View style={styles.center}><ActivityIndicator/></View>;

  return (
    <NavigationContainer>
      <Stack.Navigator screenOptions={{headerShown:false}}>
        {!isLogged ? (
          <Stack.Screen name="Auth" component={AuthScreen} />
        ) : (
          <Stack.Screen name="MainTabs" component={MainTabs} />
        )}
      </Stack.Navigator>
    </NavigationContainer>
  );
}

// Tabs are defined below separately because MainTabs used above
function MainTabs() {
  return (
    <Tab.Navigator screenOptions={{ headerShown: false }}>
      <Tab.Screen name="Home" component={HomeStack} />
      <Tab.Screen name="Videos" component={VideosScreen} />
      <Tab.Screen name="Channels" component={ChannelsScreen} />
      <Tab.Screen name="GPT" component={GPTScreen} />
      <Tab.Screen name="Games" component={GamesScreen} />
      <Tab.Screen name="Add" component={AddPostScreen} />
      <Tab.Screen name="Inbox" component={InboxScreen} />
      <Tab.Screen name="Profile" component={ProfileScreen} />
    </Tab.Navigator>
  );
}

// ---------- Styles ----------
const styles = StyleSheet.create({
  container:{flex:1, backgroundColor:"#000", alignItems:"center", paddingTop:40},
  h1:{fontSize:32, color:"#fff", fontWeight:"bold"},
  p:{color:"#aaa", marginBottom:12},
  input:{backgroundColor:"#111", color:"#fff", padding:12, borderRadius:8, marginVertical:8},
  primaryBtn:{backgroundColor:"#0095f6", padding:12, borderRadius:8, alignItems:"center"},
  smallBtn:{padding:8, backgroundColor:"#222", borderRadius:8, alignItems:"center"},
  center:{flex:1, justifyContent:"center", alignItems:"center", backgroundColor:"#000"},
  iconCircle:{width:48, height:48, borderRadius:24, backgroundColor:"rgba(0,0,0,0.5)", justifyContent:"center", alignItems:"center"},
  searchRow:{flexDirection:"row", padding:8, backgroundColor:"#000", alignItems:"center"},
  searchInput:{flex:1, backgroundColor:"#111", color:"#fff", padding:8, borderRadius:8},
  channelItem:{padding:12, borderBottomWidth:1, borderBottomColor:"#111"},
  channelRow:{padding:12, borderBottomWidth:1, borderBottomColor:"#111"},
  channelHeader:{padding:12, backgroundColor:"#000", borderBottomWidth:1, borderBottomColor:"#111", flexDirection:"row", justifyContent:"space-between", alignItems:"center"},
  channelTitleLarge:{fontSize:20, fontWeight:"bold", color:"#fff"},
  smallBtn:{padding:8, borderRadius:6, backgroundColor:"#0095f6"},
  conversationItem:{padding:12, borderBottomWidth:1, borderBottomColor:"#222"},
  chatInput:{flex:1, backgroundColor:"#111", color:"#fff", padding:10, borderRadius:8, marginRight:8},
});

// ---------- Ù¾Ø§ÛŒØ§Ù† ÙØ§ÛŒÙ„ ----------
