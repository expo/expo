import React, { useState, useRef, useEffect } from "react";
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  ScrollView,
  StyleSheet,
  Alert,
  SafeAreaView,
  Modal,
  Animated,
  Dimensions,
  Share,
  Image,
} from "react-native";

/*
T·∫∂NG SAO PRO - React Native demo for Snack/Expo
Features:
- Owner: Tr·∫ßn B·∫£o Long (MASTER key: LONG_ADMIN_2025)
- Admin code: ADMIN100K or simulated payment 100k
- Initial users list provided
- Star color thresholds and rainbow
- Progress bar, 7-day bar chart
- Milestone celebration effect (10,30,70,100,500,1000)
- Share button (text share)
- Avatar frames unlocked by milestones; user can change frame
*/

const OWNER_MASTER_KEY = "LONG_ADMIN_2025";
const ADMIN_CODE = "ADMIN100K";
const MILESTONES = [10, 30, 70, 100, 500, 1000];

const DEFAULT_REWARDS = [
  { id: "r10", name: "2 c√¢y k·∫πo", cost: 10, emoji: "üç¨" },
  { id: "r30", name: "B√°nh chu·ªëi", cost: 30, emoji: "üçå" },
  { id: "r70", name: "Tr√† s·ªØa", cost: 70, emoji: "üßã" },
  { id: "r100", name: "M√¨ cay 10k", cost: 100, emoji: "üçú" },
];

const INITIAL_USERS = [
  { id: "u_owner", name: "Tr·∫ßn B·∫£o Long", stars: 250, role: "owner", history: [10, 20, 30, 40, 30, 60, 60], celebrated: [], frame: "gold" },
  { id: "u1", name: "L√™ Ng·ªçc Tr·∫ßm", stars: 12, role: "player", history: [1, 2, 3, 1, 1, 2, 2], celebrated: [], frame: "default" },
  { id: "u2", name: "Th√°i L√Ω Th·ª•y", stars: 5, role: "player", history: [0, 1, 0, 1, 2, 0, 1], celebrated: [], frame: "default" },
  { id: "u3", name: "Hu·ª≥nh Ng·ªçc Ti·∫øn", stars: 35, role: "player", history: [5, 5, 4, 6, 5, 5, 5], celebrated: [], frame: "pink" },
  { id: "u4", name: "L√™ T·∫•m L√¢m", stars: 72, role: "player", history: [10, 0, 10, 20, 10, 10, 12], celebrated: [], frame: "lightblue" },
  { id: "u5", name: "L√™ Minh Tr·ªçng", stars: 90, role: "player", history: [5, 10, 10, 10, 10, 20, 25], celebrated: [], frame: "purple" },
  { id: "u6", name: "Nguy·ªÖn Ph√∫ Sang", stars: 8, role: "player", history: [0, 1, 2, 0, 2, 1, 2], celebrated: [], frame: "default" },
  { id: "u7", name: "L√™ Nguy·ªÖn Ph∆∞·ªõc T∆∞·ªùng", stars: 3, role: "player", history: [0, 0, 0, 1, 1, 1, 0], celebrated: [], frame: "default" },
  { id: "u8", name: "Tr·∫ßn C√¥ng C·∫©n", stars: 500, role: "player", history: [50, 50, 50, 50, 50, 50, 50], celebrated: [], frame: "green" },
  { id: "u9", name: "B·∫°ch Trung Ki√™n", stars: 15, role: "player", history: [2, 2, 3, 3, 2, 1, 2], celebrated: [], frame: "gold" },
  { id: "u10", name: "V√µ T·∫•n ƒê·∫°t", stars: 1050, role: "player", history: [100, 100, 150, 200, 200, 200, 200], celebrated: [], frame: "rainbow" },
];

export default function App() {
  const [users, setUsers] = useState(INITIAL_USERS);
  const [rewards, setRewards] = useState(DEFAULT_REWARDS);

  // UI state
  const [view, setView] = useState("home"); // home / profile / admin
  const [query, setQuery] = useState("");
  const [nameInput, setNameInput] = useState("");
  const [selectedUserId, setSelectedUserId] = useState(null);
  const [sessionAs, setSessionAs] = useState(null); // acting user
  const [ownerKeyInput, setOwnerKeyInput] = useState("");
  const [adminKeyInput, setAdminKeyInput] = useState("");

  // Celebration modal state
  const [celebrationVisible, setCelebrationVisible] = useState(false);
  const [celebrationData, setCelebrationData] = useState({ name: "", milestone: 0, emoji: "üåü" });
  const starAnim = useRef(new Animated.Value(0)).current;
  const overlayAnim = useRef(new Animated.Value(0)).current;

  // Avatar frames available and unlock thresholds
  const FRAMES = [
    { id: "default", name: "Default", unlock: 0, color: "#ccc" },
    { id: "gold", name: "Gold", unlock: 10, color: "#FFD700" },
    { id: "pink", name: "Pink", unlock: 30, color: "#F06292" },
    { id: "lightblue", name: "LightBlue", unlock: 70, color: "#4FC3F7" },
    { id: "purple", name: "Purple", unlock: 100, color: "#8E24AA" },
    { id: "green", name: "Green", unlock: 500, color: "#00C853" },
    { id: "rainbow", name: "Rainbow", unlock: 1000, color: "rainbow" },
  ];

  // Helpers
  const findByName = (n) => users.find((u) => u.name.toLowerCase() === n.trim().toLowerCase());
  const findById = (id) => users.find((u) => u.id === id);

  // color determination
  const getStarColor = (s) => {
    if (s >= 1000) return ["#FF3CAC", "#FF8A00", "#FFD700", "#00C853", "#00B0FF", "#7C4DFF", "#E91E63"]; // rainbow array
    if (s >= 500) return "#00C853";
    if (s >= 100) return "#8E24AA";
    if (s >= 70) return "#4FC3F7";
    if (s >= 30) return "#F06292";
    if (s >= 10) return "#FFD700";
    return "#FFD700"; // you asked 0 sao m√†u v√†ng too
  };

  // open celebration modal if crossing milestone(s)
  const checkCelebration = (oldStars, newStars, user) => {
    // find milestones crossed by this update that are not yet celebrated for this user
    const newly = MILESTONES.filter((m) => oldStars < m && newStars >= m && !(user.celebrated || []).includes(m));
    if (newly.length === 0) return;
    // celebrate the smallest one (first) now
    const milestone = newly[0];
    setCelebrationData({ name: user.name, milestone, emoji: "üåü" });
    // mark celebrated
    setUsers((old) => old.map((u) => (u.id === user.id ? { ...u, celebrated: [...(u.celebrated || []), milestone] } : u)));
    showCelebrationModal(user.name, milestone);
  };

  // animate and show modal
  const showCelebrationModal = (name, milestone) => {
    setCelebrationVisible(true);
    overlayAnim.setValue(0);
    starAnim.setValue(0);
    Animated.sequence([
      Animated.timing(overlayAnim, { toValue: 1, duration: 200, useNativeDriver: true }),
      Animated.spring(starAnim, { toValue: 1, friction: 4, useNativeDriver: true }),
    ]).start();
  };

  const hideCelebration = () => {
    Animated.timing(overlayAnim, { toValue: 0, duration: 200, useNativeDriver: true }).start(() => {
      setCelebrationVisible(false);
    });
  };

  // update stars and history; triggers checkCelebration
  const updateStars = (userId, delta) => {
    setUsers((old) =>
      old.map((u) => {
        if (u.id !== userId) return u;
        const oldStars = u.stars;
        const newStars = Math.max(0, oldStars + delta);
        const h = [...u.history];
        h[h.length - 1] = Math.max(0, (h[h.length - 1] || 0) + delta);
        // schedule check after state update via closure: we'll handle below by returning new state and then check separately
        return { ...u, stars: newStars, history: h };
      })
    );
    // after state update, run check via timeout to read updated state
    setTimeout(() => {
      const u = findById(userId);
      if (!u) return;
      const oldStars = u.stars - delta;
      checkCelebration(oldStars, u.stars, u);
    }, 50);
  };

  // promote functions
  const appointByOwner = (targetName, ownerName) => {
    const owner = findByName(ownerName);
    if (!owner || owner.role !== "owner") return Alert.alert("L·ªói", "Ch·ªâ Ch·ªß c√≥ quy·ªÅn b·ªï nhi·ªám mi·ªÖn ph√≠.");
    const target = findByName(targetName);
    if (!target) return Alert.alert("Kh√¥ng t√¨m th·∫•y", "Ng∆∞·ªùi ƒë∆∞·ª£c b·ªï nhi·ªám kh√¥ng t·ªìn t·∫°i.");
    if (target.role === "admin" || target.role === "owner") return Alert.alert("Info", "Ng∆∞·ªùi n√†y ƒë√£ l√† Ph√≥/Ch·ªß.");
    setUsers((old) => old.map((u) => (u.id === target.id ? { ...u, role: "admin" } : u)));
    Alert.alert("B·ªï nhi·ªám", `${target.name} ƒë√£ ƒë∆∞·ª£c Ch·ªß ${owner.name} b·ªï nhi·ªám l√†m PH√ì mi·ªÖn ph√≠.`);
  };

  const appointByCodeOrPayment = (targetName, code) => {
    const target = findByName(targetName);
    if (!target) return Alert.alert("Kh√¥ng t√¨m th·∫•y", "Ng∆∞·ªùi c·∫ßn n√¢ng c·∫•p kh√¥ng t·ªìn t·∫°i.");
    if (target.role === "admin" || target.role === "owner") return Alert.alert("Info", "Ng∆∞·ªùi n√†y ƒë√£ l√† Ph√≥/Ch·ªß.");
    if (code === ADMIN_CODE) {
      setUsers((old) => old.map((u) => (u.id === target.id ? { ...u, role: "admin" } : u)));
      return Alert.alert("N√¢ng c·∫•p", `${target.name} ƒë√£ tr·ªü th√†nh PH√ì b·∫±ng m√£.`);
    }
    Alert.alert("Thanh to√°n 100.000 VNƒê (Gi·∫£ l·∫≠p)", `X√°c nh·∫≠n n·∫°p 100.000 VNƒê cho ${target.name}?`, [
      { text: "Hu·ª∑" },
      {
        text: "ƒê·ªìng √Ω",
        onPress: () => {
          setUsers((old) => old.map((u) => (u.id === target.id ? { ...u, role: "admin" } : u)));
          Alert.alert("Ho√†n t·∫•t", `${target.name} ƒë√£ tr·ªü th√†nh PH√ì (qua thanh to√°n gi·∫£ l·∫≠p).`);
        },
      },
    ]);
  };

  const setOwnerByKey = (targetName, key) => {
    if (key !== OWNER_MASTER_KEY) return Alert.alert("Key sai", "M√£ ch·ªß kh√¥ng ƒë√∫ng.");
    const target = findByName(targetName);
    if (!target) return Alert.alert("Kh√¥ng t√¨m th·∫•y", "Ng∆∞·ªùi n√†y ch∆∞a t·ªìn t·∫°i.");
    setUsers((old) =>
      old.map((u) => {
        if (u.id === target.id) return { ...u, role: "owner" };
        if (u.role === "owner") return { ...u, role: "player" };
        return u;
      })
    );
    Alert.alert("G√°n ch·ªß", `${target.name} l√† Ch·ªß m·ªõi.`);
  };

  const addReward = (name, cost) => {
    if (!name || !cost) return Alert.alert("Nh·∫Øc", "Nh·∫≠p t√™n v√† s·ªë sao.");
    const r = { id: "r" + Date.now(), name, cost: Number(cost), emoji: "üéÅ" };
    setRewards((s) => [r, ...s]);
    Alert.alert("ƒê√£ th√™m qu√†", `${name} (${cost} sao).`);
  };

  // avatar frame change
  const changeFrame = (userId, frameId) => {
    const frame = FRAMES.find((f) => f.id === frameId);
    if (!frame) return;
    setUsers((old) => old.map((u) => (u.id === userId ? { ...u, frame: frameId } : u)));
    Alert.alert("Khung ·∫£nh", `ƒê√£ ƒë·ªïi khung th√†nh ${frame.name}`);
  };

  // share function
  const shareMilestone = async (name, milestone) => {
    try {
      const message = `üéâ ${name} v·ª´a ƒë·∫°t ${milestone} sao tr√™n ·ª®ng d·ª•ng T·∫∑ng Sao! C√πng ch√∫c m·ª´ng nh√© üéâ`;
      await Share.share({ message });
    } catch (e) {
      Alert.alert("L·ªói", "Kh√¥ng th·ªÉ chia s·∫ª l√∫c n√†y.");
    }
  };

  // progress percent helper
  const progressPercent = (s) => {
    const sorted = [...rewards].sort((a, b) => a.cost - b.cost);
    const next = sorted.find((r) => r.cost > s);
    if (!next) return 100;
    const prev = sorted.reduce((acc, r) => (r.cost < next.cost && r.cost > acc ? r.cost : acc), 0);
    const span = next.cost - prev || 1;
    return Math.round(((s - prev) / span) * 100);
  };

  const listFiltered = users.filter((u) => u.name.toLowerCase().includes(query.trim().toLowerCase()));

  // celebration modal render
  const CelebrationModal = () => {
    const { width, height } = Dimensions.get("window");
    const scale = starAnim.interpolate({ inputRange: [0, 1], outputRange: [0.2, 1.4] });
    const rotate = starAnim.interpolate({ inputRange: [0, 1], outputRange: ["0deg", "360deg"] });
    const opacity = overlayAnim.interpolate({ inputRange: [0, 1], outputRange: [0, 0.9] });

    if (!celebrationVisible) return null;
    const { name, milestone } = celebrationData;
    const frameEmoji = milestone >= 1000 ? "üåà" : "üåü";

    return (
      <Modal transparent visible={celebrationVisible} animationType="none">
        <View style={{ flex: 1 }}>
          <Animated.View style={[styles.overlay, { opacity }]} />
          <View style={styles.celebrationCenter}>
            <Animated.View style={{ transform: [{ scale }, { rotate }] }}>
              <View style={styles.starCircle}>
                <Text style={{ fontSize: 56 }}>{frameEmoji}</Text>
              </View>
            </Animated.View>

            <Text style={styles.celebrationText}>üéâ Ch√∫c m·ª´ng {name} ƒë·∫°t {milestone} sao! üéâ</Text>

            <View style={{ flexDirection: "row", gap: 12, marginTop: 12 }}>
              <TouchableOpacity style={[styles.btn, { backgroundColor: "#ff8a65" }]} onPress={() => { shareMilestone(name, milestone); }}>
                <Text style={{ color: "#fff" }}>Chia s·∫ª</Text>
              </TouchableOpacity>
              <TouchableOpacity style={[styles.btn, { backgroundColor: "#777" }]} onPress={() => hideCelebration()}>
                <Text style={{ color: "#fff" }}>ƒê√≥ng</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    );
  };

  // Subcomponents for profile view: star color preview & chart
  function StarColorPreview({ value = 0 }) {
    const get = (s) => {
      if (s >= 1000) return ["#FF3CAC", "#FF8A00", "#FFD700", "#00C853", "#00B0FF", "#7C4DFF", "#E91E63"];
      if (s >= 500) return "#00C853";
      if (s >= 100) return "#8E24AA";
      if (s >= 70) return "#4FC3F7";
      if (s >= 30) return "#F06292";
      if (s >= 10) return "#FFD700";
      return "#FFD700"; // 0 sao is yellow as requested
    };
    const col = get(value);
    if (Array.isArray(col)) {
      return (
        <View style={{ flexDirection: "row", alignItems: "center" }}>
          {col.map((c, i) => <View key={i} style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: c, marginRight: 4 }} />)}
        </View>
      );
    }
    return <View style={{ width: 18, height: 18, borderRadius: 9, backgroundColor: col }} />;
  }

  function ProgressBar({ percent = 0, color = "#FFD700", rainbow = false }) {
    if (rainbow) {
      return (
        <View style={{ height: 18, width: "100%", borderRadius: 12, backgroundColor: "#eee", overflow: "hidden" }}>
          <View style={{ height: "100%", width: `${Math.max(0, Math.min(100, percent))}%`, flexDirection: "row" }}>
            <View style={{ flex: 1, backgroundColor: "#FF3CAC" }} />
            <View style={{ flex: 1, backgroundColor: "#FF8A00" }} />
            <View style={{ flex: 1, backgroundColor: "#FFD700" }} />
            <View style={{ flex: 1, backgroundColor: "#00C853" }} />
            <View style={{ flex: 1, backgroundColor: "#00B0FF" }} />
            <View style={{ flex: 1, backgroundColor: "#7C4DFF" }} />
            <View style={{ flex: 1, backgroundColor: "#E91E63" }} />
          </View>
        </View>
      );
    }
    return (
      <View style={{ height: 18, width: "100%", borderRadius: 12, backgroundColor: "#eee" }}>
        <View style={{ height: "100%", width: `${Math.max(0, Math.min(100, percent))}%`, backgroundColor: color, borderRadius: 12 }} />
      </View>
    );
  }

  function SimpleBarChart({ values = [0, 0, 0, 0, 0, 0, 0] }) {
    const max = Math.max(...values, 1);
    return (
      <View style={{ flexDirection: "row", alignItems: "flex-end", height: 120, gap: 6 }}>
        {values.map((v, i) => (
          <View key={i} style={{ alignItems: "center", width: 28 }}>
            <View style={{ height: (v / max) * 100 + 10, width: 20, backgroundColor: "#4FC3F7", borderRadius: 4 }} />
            <Text style={{ fontSize: 10 }}>{v}</Text>
          </View>
        ))}
      </View>
    );
  }

  function AggregateChart({ users = [] }) {
    const days = 7;
    const sums = Array(days).fill(0);
    users.forEach((u) => {
      for (let i = 0; i < days; i++) sums[i] += (u.history && u.history[i]) || 0;
    });
    return <SimpleBarChart values={sums} />;
  }

  // Profile view
  if (view === "profile" && selectedUserId) {
    const u = findById(selectedUserId);
    if (!u) {
      setView("home");
      return null;
    }
    const color = getStarColor(u.stars);
    const isRainbow = u.stars >= 1000;
    const next = rewards.slice().sort((a, b) => a.cost - b.cost).find((r) => r.cost > u.stars);

    return (
      <SafeAreaView style={styles.safe}>
        <ScrollView style={styles.container}>
          <Text style={styles.header}>üë§ H·ªì s∆°: {u.name}</Text>
          <Text style={styles.small}>Vai tr√≤: {u.role}</Text>

          <View style={styles.card}>
            <View style={{ flexDirection: "row", alignItems: "center", gap: 12 }}>
              <AvatarWithFrame frameId={u.frame} />
              <View style={{ flex: 1 }}>
                <Text style={{ fontSize: 20, fontWeight: "700" }}>{isRainbow ? "üåà " : ""}{u.stars} sao</Text>
                <View style={{ width: "100%", marginTop: 8 }}>
                  <ProgressBar percent={progressPercent(u.stars)} color={Array.isArray(color) ? "#FFD700" : color} rainbow={Array.isArray(color)} />
                </View>
                <View style={{ marginTop: 8, flexDirection: "row", alignItems: "center" }}>
                  <Text style={{ marginRight: 8 }}>M√†u c·∫•p:</Text>
                  <StarColorPreview value={u.stars} />
                </View>
              </View>
            </View>

            <Text style={{ marginTop: 10 }}>{next ? `Ti·∫øn t·ªõi: ${next.name} (${next.cost} sao)` : "B·∫°n ƒë√£ ƒë·∫°t t·∫•t c·∫£ ph·∫ßn qu√† hi·ªán c√≥!"}</Text>
          </View>

          <View style={styles.section}>
            <Text style={styles.sectionTitle}>L·ªãch s·ª≠ 7 ng√†y</Text>
            <SimpleBarChart values={u.history || [0, 0, 0, 0, 0, 0, 0]} />
          </View>

          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Khung ·∫£nh (avatar)</Text>
            <Text style={{ fontSize: 12, color: "#666" }}>M·ªü kh√≥a theo sao: 10,30,70,100,500,1000</Text>
            <View style={{ flexDirection: "row", flexWrap: "wrap", marginTop: 8 }}>
              {FRAMES.map((f) => {
                const unlocked = u.stars >= f.unlock;
                return (
                  <TouchableOpacity key={f.id} style={[styles.frameBtn, { borderColor: unlocked ? f.color === "rainbow" ? "#000" : f.color : "#ddd" }]} onPress={() => {
                    if (!unlocked) return Alert.alert("Kh√≥a", `C·∫ßn ${f.unlock} sao ƒë·ªÉ m·ªü khung n√†y.`);
                    changeFrame(u.id, f.id);
                  }}>
                    <View style={{ width: 48, height: 48, borderRadius: 8, backgroundColor: f.id === "rainbow" ? undefined : (unlocked ? f.color : "#fff"), justifyContent: "center", alignItems: "center" }}>
                      <Text>{f.id === "rainbow" ? "üåà" : "üñºÔ∏è"}</Text>
                    </View>
                    <Text style={{ fontSize: 12, marginTop: 4, textAlign: "center" }}>{f.name}</Text>
                  </TouchableOpacity>
                );
              })}
            </View>
          </View>

          <View style={styles.section}>
            <Text style={styles.sectionTitle}>ƒê·ªïi qu√†</Text>
            {rewards.map((r) => (
              <View key={r.id} style={styles.rewardRow}>
                <Text style={{ fontSize: 16 }}>{r.emoji} {r.name}</Text>
                <Text>{r.cost} ‚≠ê</Text>
                <TouchableOpacity style={styles.smallAction} onPress={() => {
                  if (u.stars >= r.cost) {
                    updateStars(u.id, -r.cost);
                    Alert.alert("ƒê·ªïi qu√†", `ƒê√£ ƒë·ªïi ${r.name}`);
                  } else {
                    Alert.alert("Ch∆∞a ƒë·ªß sao", `C·∫ßn th√™m ${r.cost - u.stars} sao.`);
                  }
                }}>
                  <Text>ƒê·ªïi</Text>
                </TouchableOpacity>
              </View>
            ))}
          </View>

          <View style={styles.section}>
            <Text style={styles.sectionTitle}>N√¢ng c·∫•p / B·ªï nhi·ªám</Text>
            <TextInput placeholder="Nh·∫≠p t√™n c·∫ßn n√¢ng c·∫•p / b·ªï nhi·ªám" style={styles.input} value={nameInput} onChangeText={setNameInput} />
            <TextInput placeholder="M√£ n√¢ng c·∫•p (ADMIN100K) (n·∫øu c√≥)" style={styles.input} value={adminKeyInput} onChangeText={setAdminKeyInput} />
            <View style={{ flexDirection: "row", gap: 8 }}>
              <TouchableOpacity style={styles.btn} onPress={() => {
                if (!nameInput) return Alert.alert("Nh·∫Øc", "Nh·∫≠p t√™n.");
                appointByCodeOrPayment(nameInput, adminKeyInput);
              }}>
                <Text style={{ color: "#fff" }}>N√¢ng c·∫•p Ph√≥ (100k / m√£)</Text>
              </TouchableOpacity>

              <TouchableOpacity style={[styles.btn, { backgroundColor: "#444" }]} onPress={() => {
                if (!sessionAs) return Alert.alert("ƒêƒÉng nh·∫≠p", "Login-as 1 t√†i kho·∫£n Ch·ªß ƒë·ªÉ b·ªï nhi·ªám mi·ªÖn ph√≠.");
                appointByOwner(u.name, sessionAs);
              }}>
                <Text style={{ color: "#fff" }}>Ch·ªß b·ªï nhi·ªám Ph√≥ mi·ªÖn ph√≠</Text>
              </TouchableOpacity>
            </View>
            <Text style={{ marginTop: 8, fontSize: 12, color: "#666" }}>ƒê·ªÉ b·ªï nhi·ªám mi·ªÖn ph√≠: Login-as t√†i kho·∫£n Ch·ªß tr∆∞·ªõc.</Text>
          </View>

          <TouchableOpacity style={[styles.btn, { marginTop: 12 }]} onPress={() => { setSelectedUserId(null); setView("home"); }}>
            <Text style={{ color: "#fff" }}>Quay l·∫°i</Text>
          </TouchableOpacity>
        </ScrollView>
        <CelebrationModal />
      </SafeAreaView>
    );
  }

  // Admin dashboard view
  if (view === "admin") {
    const me = sessionAs ? findByName(sessionAs) : null;
    const isOwner = me && me.role === "owner";
    const isAdmin = me && (me.role === "admin" || isOwner);
    return (
      <SafeAreaView style={styles.safe}>
        <ScrollView style={styles.container}>
          <Text style={styles.header}>üõ† B·∫¢NG ƒêI·ªÄU KHI·ªÇN</Text>
          <Text style={styles.small}>B·∫°n ƒëang h√†nh ƒë·ªông: {sessionAs || "Ch∆∞a ƒëƒÉng nh·∫≠p"}</Text>
          {!isAdmin && <Text style={styles.warning}>Ch·ªâ PH√ì/CH·ª¶ m·ªõi thao t√°c ƒë∆∞·ª£c ·ªü ƒë√¢y.</Text>}

          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Danh s√°ch ng∆∞·ªùi ch∆°i</Text>
            {users.map((u) => (
              <View key={u.id} style={styles.row}>
                <View>
                  <Text style={{ fontWeight: "700" }}>{u.name}</Text>
                  <Text>{u.stars} ‚≠ê ‚Ä¢ {u.role}</Text>
                </View>

                {isAdmin && (
                  <View style={{ flexDirection: "row" }}>
                    <TouchableOpacity style={styles.smallBtn} onPress={() => updateStars(u.id, 10)}>+10</TouchableOpacity>
                    <TouchableOpacity style={styles.smallBtn} onPress={() => updateStars(u.id, -10)}>-10</TouchableOpacity>
                  </View>
                )}

                {isOwner && (
                  <TouchableOpacity style={[styles.smallBtn, { backgroundColor: "#FFD700" }]} onPress={() => appointByOwner(u.name, sessionAs)}>
                    <Text>‚öë B·ªï nhi·ªám Ph√≥ mi·ªÖn ph√≠</Text>
                  </TouchableOpacity>
                )}
              </View>
            ))}
          </View>

          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Th√™m ph·∫ßn qu√†</Text>
            <AddRewardForm onAdd={addReward} />
          </View>

          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Bi·ªÉu ƒë·ªì t·ªïng (7 ng√†y)</Text>
            <AggregateChart users={users} />
          </View>

          <TouchableOpacity style={[styles.btn, { backgroundColor: "#444" }]} onPress={() => setView("home")}>
            <Text style={{ color: "#fff" }}>Quay v·ªÅ Home</Text>
          </TouchableOpacity>
        </ScrollView>
      </SafeAreaView>
    );
  }

  // Home view
  return (
    <SafeAreaView style={styles.safe}>
      <ScrollView style={styles.container}>
        <Text style={styles.header}>üåü ·ª®NG D·ª§NG T·∫∂NG SAO PRO</Text>
        <Text style={styles.small}>Ch·ªß hi·ªán t·∫°i: {users.find((u) => u.role === "owner")?.name || "Ch∆∞a c√≥"}</Text>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>1) T·∫°o t√†i kho·∫£n</Text>
          <TextInput placeholder="Nh·∫≠p h·ªç t√™n..." style={styles.input} value={nameInput} onChangeText={setNameInput} />
          <TouchableOpacity style={styles.btn} onPress={() => createUser(nameInput)}>
            <Text style={{ color: "#fff" }}>T·∫°o t√†i kho·∫£n</Text>
          </TouchableOpacity>
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>2) T√¨m / M·ªü t√†i kho·∫£n</Text>
          <TextInput placeholder="Nh·∫≠p t√™n ƒë·ªÉ t√¨m..." style={styles.input} value={query} onChangeText={setQuery} />
          <View style={{ flexDirection: "row", gap: 8 }}>
            <TouchableOpacity style={styles.btn} onPress={() => openUserByName(query)}>
              <Text style={{ color: "#fff" }}>M·ªü t√†i kho·∫£n</Text>
            </TouchableOpacity>
            <TouchableOpacity style={[styles.btn, { backgroundColor: "#6B46C1" }]} onPress={() => {
              if (!query) return Alert.alert("Nh·∫Øc", "Nh·∫≠p t√™n ƒë·ªÉ login as.");
              loginAs(query);
            }}>
              <Text style={{ color: "#fff" }}>Login as (t·∫°m)</Text>
            </TouchableOpacity>
          </View>

          <Text style={{ marginTop: 10, fontWeight: "700" }}>K·∫øt qu·∫£</Text>
          {listFiltered.map(u => (
            <TouchableOpacity key={u.id} style={styles.listItem} onPress={() => openUser(u.id)}>
              <View>
                <Text style={{ fontWeight: "800" }}>{u.name}</Text>
                <Text>{u.stars} ‚≠ê ‚Ä¢ {u.role}</Text>
              </View>
            </TouchableOpacity>
          ))}
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>3) G√°n Ch·ªß m·ªõi (b√≠ m·∫≠t)</Text>
          <TextInput placeholder="T√™n ng∆∞·ªùi mu·ªën g√°n l√†m Ch·ªß" style={styles.input} value={nameInput} onChangeText={setNameInput} />
          <TextInput placeholder="M√£ ch·ªß (LONG_ADMIN_2025)" style={styles.input} value={ownerKeyInput} onChangeText={setOwnerKeyInput} />
          <TouchableOpacity style={styles.btn} onPress={() => { if (!nameInput || !ownerKeyInput) return Alert.alert("Nh·∫Øc", "Nh·∫≠p t√™n & m√£ ch·ªß"); setOwnerByKey(nameInput, ownerKeyInput); }}>
            <Text style={{ color: "#fff" }}>G√°n Ch·ªß (b√≠ m·∫≠t)</Text>
          </TouchableOpacity>
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>4) Rewards hi·ªán c√≥</Text>
          {rewards.map(r => (
            <View key={r.id} style={styles.rewardRow}>
              <Text style={{ fontSize: 16 }}>{r.emoji} {r.name}</Text>
              <Text>{r.cost} ‚≠ê</Text>
            </View>
          ))}
        </View>

        <TouchableOpacity style={[styles.btn, { backgroundColor: "#2b6cb0" }]} onPress={() => {
          if (!sessionAs) return Alert.alert("ƒêƒÉng nh·∫≠p", "H√£y Login as m·ªôt t√†i kho·∫£n (t·∫°m) ƒë·ªÉ v√†o B·∫£ng ƒêi·ªÅu Khi·ªÉn.");
          const me = findByName(sessionAs);
          if (!me || (me.role !== "admin" && me.role !== "owner")) return Alert.alert("Quy·ªÅn", "C·∫ßn l√† Ph√≥/Ch·ªß ƒë·ªÉ truy c·∫≠p b·∫£ng ƒëi·ªÅu khi·ªÉn.");
          setView("admin");
        }}>
          <Text style={{ color: "#fff" }}>M·ªü B·∫£ng ƒêi·ªÅu Khi·ªÉn (Ph√≥/Ch·ªß)</Text>
        </TouchableOpacity>

        <View style={{ height: 40 }} />

        <CelebrationModal />
      </ScrollView>
    </SafeAreaView>
  );
}

/* Small helper components */

function AvatarWithFrame({ frameId = "default" }) {
  const frame = FRAMES.find((f) => f.id === frameId) || FRAMES[0];
  const styleFrame = frame.id === "rainbow" ? { borderWidth: 3, borderRadius: 12, padding: 2, borderColor: "#000" } : { borderWidth: 3, borderColor: frame.color, borderRadius: 12, padding: 2 };
  return (
    <View style={styleFrame}>
      <View style={{ width: 64, height: 64, borderRadius: 8, backgroundColor: "#eee", justifyContent: "center", alignItems: "center" }}>
        <Text style={{ fontSize: 24 }}>üôÇ</Text>
      </View>
    </View>
  );
}

function AddRewardForm({ onAdd }) {
  const [n, setN] = useState("");
  const [c, setC] = useState("");
  return (
    <View style={{ marginTop: 8 }}>
      <TextInput placeholder="T√™n qu√†" style={styles.input} value={n} onChangeText={setN} />
      <TextInput placeholder="C·∫ßn bao nhi√™u sao?" style={styles.input} value={c} onChangeText={setC} keyboardType="number-pad" />
      <TouchableOpacity style={styles.btn} onPress={() => { if (!n || !c) return Alert.alert("Nh·∫Øc", "Nh·∫≠p ƒë·∫ßy ƒë·ªß"); onAdd(n, c); setN(""); setC(""); }}>
        <Text style={{ color: "#fff" }}>Th√™m qu√†</Text>
      </TouchableOpacity>
    </View>
  );
}

/* Styles */
const styles = StyleSheet.create({
  safe: { flex: 1, backgroundColor: "#fff" },
  container: { padding: 16, backgroundColor: "#fff" },
  header: { fontSize: 22, fontWeight: "800", marginBottom: 8 },
  small: { fontSize: 12, color: "#444", marginBottom: 6 },
  section: { marginTop: 12, paddingVertical: 12, borderTopWidth: 0.5, borderColor: "#eee" },
  sectionTitle: { fontWeight: "700", marginBottom: 8 },
  input: { borderWidth: 1, borderColor: "#ddd", padding: 10, borderRadius: 8, marginBottom: 8 },
  btn: { backgroundColor: "#2f855a", padding: 12, borderRadius: 10, alignItems: "center", marginTop: 8 },
  listItem: { padding: 12, borderWidth: 1, borderColor: "#eee", borderRadius: 10, marginBottom: 8 },
  rewardRow: { flexDirection: "row", justifyContent: "space-between", alignItems: "center", paddingVertical: 8 },
  row: { flexDirection: "row", justifyContent: "space-between", alignItems: "center", paddingVertical: 8 },
  smallBtn: { borderWidth: 1, borderColor: "#ccc", padding: 6, borderRadius: 8, marginLeft: 8, marginRight: 6 },
  card: { padding: 12, borderWidth: 1, borderColor: "#eee", borderRadius: 10, marginTop: 8, width: "100%" },
  rewardItem: { flexDirection: "row", alignItems: "center", marginBottom: 8 },
  smallAction: { padding: 8, borderWidth: 1, borderRadius: 8 },
  warning: { color: "#B02323", marginBottom: 8 },
  overlay: { position: "absolute", backgroundColor: "#000", top: 0, left: 0, right: 0, bottom: 0 },
  celebrationCenter: { position: "absolute", top: "30%", left: 0, right: 0, alignItems: "center" },
  starCircle: { width: 140, height: 140, borderRadius: 70, backgroundColor: "#fff", justifyContent: "center", alignItems: "center", shadowColor: "#000", shadowOpacity: 0.2, shadowRadius: 10 },
  celebrationText: { marginTop: 16, fontSize: 18, fontWeight: "700", color: "#fff", textAlign: "center" },
  frameBtn: { width: 80, marginRight: 12, marginBottom: 12, alignItems: "center" },
  rewardRowSmall: { flexDirection: "row", alignItems: "center", gap: 8 },
});
