import React, { useState, useCallback, useMemo } from 'react';
import {
  SafeAreaView,
  View,
  Text,
  FlatList,
  TouchableOpacity,
  StyleSheet,
  Animated,
} from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import Icon from 'react-native-vector-icons/MaterialIcons';

// Datos base
const MUSIC_GENRES = [
  {
    id: 'trap',
    name: 'Trap',
    color: '#ff6b6b',
    icon: 'graphic-eq',
    items: [
      { task: '808: EQ + sidechain kick', priority: 'Alta' },
      { task: 'Kick: compresiÃ³n pegada', priority: 'Alta' },
      { task: 'Hi-hats: paneo y swing', priority: 'Media' },
    ],
  },
  {
    id: 'reggaeton',
    name: 'ReggaetÃ³n',
    color: '#4ecdc4',
    icon: 'music-note',
    items: [
      { task: 'Kick + bajo: revisar mezcla mono', priority: 'Alta' },
      { task: 'Clap/snare: EQ y reverb corta', priority: 'Alta' },
      { task: 'Voz principal: comp + EQ brillante', priority: 'Alta' },
    ],
  },
];

// AnimaciÃ³n personalizada
const AnimatedTouchable = Animated.createAnimatedComponent(TouchableOpacity);
const useSpringAnimation = (initialValue = 1) => {
  const animatedValue = useMemo(() => new Animated.Value(initialValue), []);
  const springTo = useCallback(
    (toValue) => {
      Animated.spring(animatedValue, {
        toValue,
        useNativeDriver: true,
        tension: 100,
        friction: 8,
      }).start();
    },
    [animatedValue]
  );
  return [animatedValue, springTo];
};

// Tarjeta de estadÃ­sticas
const StatsCard = ({ title, value, subtitle, color, icon }) => {
  const [scaleAnim] = useSpringAnimation(1);

  return (
    <AnimatedTouchable
      style={[
        styles.statsCard,
        { transform: [{ scale: scaleAnim }] },
      ]}
      onPressIn={() => scaleAnim.setValue(0.95)}
      onPressOut={() => scaleAnim.setValue(1)}
    >
      <View style={[styles.statsIconContainer, { backgroundColor: color }]}>
        <Icon name={icon} size={28} color="#fff" />
      </View>
      <View style={styles.statsTextContainer}>
        <Text style={styles.statsValue}>{value}</Text>
        <Text style={styles.statsTitle}>{title}</Text>
        {subtitle ? <Text style={styles.statsSubtitle}>{subtitle}</Text> : null}
      </View>
    </AnimatedTouchable>
  );
};

// Pantalla principal
const App = () => {
  const [completedTasks, setCompletedTasks] = useState({});

  // Cambiar estado de tarea
  const toggleTask = async (genreId, taskIndex) => {
    const updated = { ...completedTasks };
    updated[genreId] = updated[genreId] || [];
    if (updated[genreId].includes(taskIndex)) {
      updated[genreId] = updated[genreId].filter((i) => i !== taskIndex);
    } else {
      updated[genreId].push(taskIndex);
    }
    setCompletedTasks(updated);
    await AsyncStorage.setItem('completedTasks', JSON.stringify(updated));
  };

  // Progreso general
  const totalTasks = MUSIC_GENRES.reduce(
    (sum, g) => sum + g.items.length,
    0
  );
  const totalCompleted = Object.values(completedTasks).reduce(
    (sum, arr) => sum + arr.length,
    0
  );
  const progress = ((totalCompleted / totalTasks) * 100).toFixed(0);

  return (
    <SafeAreaView style={styles.container}>
      <Text style={styles.header}>ðŸŽ¶ Checklist Estudio Recnovatio</Text>

      {/* Stats */}
      <View style={styles.statsRow}>
        <StatsCard
          title="Completadas"
          value={`${totalCompleted}`}
          subtitle="Tareas hechas"
          color="#6c5ce7"
          icon="check-circle"
        />
        <StatsCard
          title="Progreso"
          value={`${progress}%`}
          subtitle="General"
          color="#00b894"
          icon="bar-chart"
        />
      </View>

      {/* Listado de gÃ©neros */}
      <FlatList
        data={MUSIC_GENRES}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => (
          <View style={styles.genreCard}>
            <View style={[styles.genreHeader, { backgroundColor: item.color }]}>
              <Icon name={item.icon} size={24} color="#fff" />
              <Text style={styles.genreTitle}>{item.name}</Text>
            </View>
            {item.items.map((task, index) => {
              const done =
                completedTasks[item.id]?.includes(index) || false;
              return (
                <TouchableOpacity
                  key={index}
                  style={styles.taskRow}
                  onPress={() => toggleTask(item.id, index)}
                >
                  <Icon
                    name={done ? 'check-box' : 'check-box-outline-blank'}
                    size={22}
                    color={done ? '#00b894' : '#555'}
                  />
                  <Text
                    style={[
                      styles.taskText,
                      done && { textDecorationLine: 'line-through', color: '#888' },
                    ]}
                  >
                    {task.task}
                  </Text>
                  <Text style={styles.priority}>[{task.priority}]</Text>
                </TouchableOpacity>
              );
            })}
          </View>
        )}
      />
    </SafeAreaView>
  );
};

// Estilos
const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f6fa',
    padding: 12,
  },
  header: {
    fontSize: 22,
    fontWeight: 'bold',
    marginBottom: 16,
    textAlign: 'center',
    color: '#2d3436',
  },
  statsRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  statsCard: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#fff',
    borderRadius: 16,
    padding: 14,
    margin: 6,
    elevation: 3,
  },
  statsIconContainer: {
    width: 48,
    height: 48,
    borderRadius: 24,
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: 12,
  },
  statsTextContainer: {
    flex: 1,
  },
  statsValue: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#2d3436',
  },
  statsTitle: {
    fontSize: 14,
    color: '#636e72',
  },
  statsSubtitle: {
    fontSize: 12,
    color: '#b2bec3',
  },
  genreCard: {
    backgroundColor: '#fff',
    borderRadius: 14,
    marginVertical: 8,
    padding: 8,
    elevation: 2,
  },
  genreHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 8,
    borderRadius: 10,
  },
  genreTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#fff',
    marginLeft: 8,
  },
  taskRow: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 6,
    paddingHorizontal: 10,
  },
  taskText: {
    flex: 1,
    fontSize: 15,
    marginLeft: 8,
    color: '#2d3436',
  },
  priority: {
    fontSize: 12,
    color: '#636e72',
  },
});

export default App;
