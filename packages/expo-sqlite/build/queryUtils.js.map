{"version":3,"file":"queryUtils.js","sourceRoot":"","sources":["../src/queryUtils.ts"],"names":[],"mappings":"AAOA,MAAM,oBAAoB,GAAG,iBAAiB,CAAC;AAC/C,MAAM,oBAAoB,GAAG,iBAAiB,CAAC;AAC/C,MAAM,iBAAiB,GAAG,gBAAgB,CAAC;AAC3C,MAAM,iBAAiB,GAAG,+CAA+C,CAAC;AAC1E,MAAM,cAAc,GAAG,mCAAmC,CAAC;AAE3D;;;;;;;;;;;;;;;;;GAiBG;AACH,MAAM,UAAU,aAAa,CAAC,KAAa;IACzC,iDAAiD;IACjD,qEAAqE;IACrE,MAAM,OAAO,GAAG,KAAK;SAClB,OAAO,CAAC,oBAAoB,EAAE,IAAI,CAAC,CAAC,+BAA+B;SACnE,OAAO,CAAC,oBAAoB,EAAE,IAAI,CAAC,CAAC,CAAC,+BAA+B;IAEvE,mFAAmF;IACnF,IAAI,iBAAiB,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC;QACpC,OAAO,EAAE,aAAa,EAAE,IAAI,EAAE,CAAC;IACjC,CAAC;IAED,uFAAuF;IACvF,IAAI,iBAAiB,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC;QACpC,OAAO,EAAE,aAAa,EAAE,KAAK,EAAE,CAAC;IAClC,CAAC;IAED,oDAAoD;IACpD,IAAI,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC;QACjC,OAAO,EAAE,aAAa,EAAE,IAAI,EAAE,CAAC;IACjC,CAAC;IAED,+BAA+B;IAC/B,OAAO,EAAE,aAAa,EAAE,KAAK,EAAE,CAAC;AAClC,CAAC","sourcesContent":["/**\n * Information about a parsed SQL query\n */\nexport interface SQLParsedInfo {\n  canReturnRows: boolean;\n}\n\nconst SINGLE_QUOTED_STRING = /'(?:[^']|'')*'/g;\nconst DOUBLE_QUOTED_STRING = /\"(?:[^\"]|\"\")*\"/g;\nconst RETURNING_KEYWORD = /\\bRETURNING\\b/i;\nconst MUTATION_KEYWORDS = /\\b(INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)\\b/i;\nconst QUERY_KEYWORDS = /\\b(SELECT|PRAGMA|WITH|EXPLAIN)\\b/i;\n\n/**\n * Parse SQL query to determine if it can return rows\n * Uses a priority-based approach for accurate detection\n *\n * A reimplementation of Bun's SQLite query parser.\n * https://github.com/oven-sh/bun/blob/e0aae8adc1ca0d84046f973e563387d0a0abeb4e/src/js/internal/sql/sqlite.ts#L53-L207\n *\n * @param query - The SQL query to parse\n * @returns Information about whether the query can return rows\n *\n * @example\n * ```ts\n * parseSQLQuery('SELECT * FROM users') // { canReturnRows: true }\n * parseSQLQuery('INSERT INTO users VALUES (1)') // { canReturnRows: false }\n * parseSQLQuery('INSERT INTO users VALUES (1) RETURNING *') // { canReturnRows: true }\n * parseSQLQuery('INSERT INTO users SELECT * FROM temp') // { canReturnRows: false }\n * ```\n */\nexport function parseSQLQuery(query: string): SQLParsedInfo {\n  // Remove quoted strings to avoid false positives\n  // SQLite uses doubled quotes for escaping: 'don''t' or \"test\"\"quote\"\n  const cleaned = query\n    .replace(SINGLE_QUOTED_STRING, \"''\") // Remove single-quoted strings\n    .replace(DOUBLE_QUOTED_STRING, '\"\"'); // Remove double-quoted strings\n\n  // Priority 1: Check for RETURNING (highest priority - makes any query return rows)\n  if (RETURNING_KEYWORD.test(cleaned)) {\n    return { canReturnRows: true };\n  }\n\n  // Priority 2: Check for mutations (these don't return rows unless they have RETURNING)\n  if (MUTATION_KEYWORDS.test(cleaned)) {\n    return { canReturnRows: false };\n  }\n\n  // Priority 3: Check for queries (these return rows)\n  if (QUERY_KEYWORDS.test(cleaned)) {\n    return { canReturnRows: true };\n  }\n\n  // Default: doesn't return rows\n  return { canReturnRows: false };\n}\n"]}