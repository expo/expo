{"version":3,"file":"utils.js","sourceRoot":"","sources":["../../src/dependencies/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import path from 'path';\n\nimport { taskAll } from '../concurrency';\nimport {\n  DependencyResolutionSource,\n  type DependencyResolution,\n  type ResolutionResult,\n} from './types';\n\nconst NODE_MODULES_PATTERN = `${path.sep}node_modules${path.sep}`;\n\n// The default dependencies we exclude don't contain dependency chains leading to autolinked modules\nexport function defaultShouldIncludeDependency(dependencyName: string): boolean {\n  const scopeName =\n    dependencyName[0] === '@' ? dependencyName.slice(1, dependencyName.indexOf('/')) : null;\n  if (\n    scopeName === 'babel' ||\n    scopeName === 'types' ||\n    scopeName === 'eslint' ||\n    scopeName === 'typescript-eslint' ||\n    scopeName === 'testing-library' ||\n    scopeName === 'aws-crypto' ||\n    scopeName === 'aws-sdk'\n  ) {\n    return false;\n  }\n  switch (dependencyName) {\n    case '@expo/cli':\n    case '@expo/config':\n    case '@expo/metro-config':\n    case '@expo/package-manager':\n    case '@expo/prebuild-config':\n    case '@expo/webpack-config':\n    case '@expo/env':\n    case '@react-native/codegen':\n    case '@react-native/community-cli-plugin':\n    case 'eslint':\n    case 'eslint-config-expo':\n    case 'eslint-plugin-expo':\n    case 'eslint-plugin-import':\n    case 'jest-expo':\n    case 'jest':\n    case 'metro':\n    case 'ts-node':\n    case 'typescript':\n    case 'webpack':\n      return false;\n    default:\n      return true;\n  }\n}\n\nexport function mergeWithDuplicate(\n  a: DependencyResolution,\n  b: DependencyResolution\n): DependencyResolution {\n  let target: DependencyResolution;\n  let duplicate: DependencyResolution;\n  if (a.depth < b.depth) {\n    target = a;\n    duplicate = b;\n  } else if (b.depth < a.depth) {\n    target = b;\n    duplicate = a;\n  } else {\n    // If both are equal, then the shallowest path wins\n    const pathDepthA = a.originPath.split(NODE_MODULES_PATTERN).length;\n    const pathDepthB = b.originPath.split(NODE_MODULES_PATTERN).length;\n    if (pathDepthA < pathDepthB) {\n      target = a;\n      duplicate = b;\n    } else if (pathDepthB < pathDepthA) {\n      target = b;\n      duplicate = a;\n    } else {\n      target = a;\n      duplicate = b;\n    }\n  }\n  const duplicates = target.duplicates || (target.duplicates = []);\n  if (target.path !== duplicate.path) {\n    if (duplicates.every((parent) => parent.path !== duplicate.path)) {\n      duplicates.push({\n        name: duplicate.name,\n        version: duplicate.version,\n        path: duplicate.path,\n        originPath: duplicate.originPath,\n      });\n    }\n  } else if (!target.version && duplicate.version) {\n    target.version = duplicate.version;\n  }\n  if (duplicate.duplicates?.length) {\n    duplicates.push(\n      ...duplicate.duplicates.filter((child) =>\n        duplicates.every((parent) => parent.path !== child.path)\n      )\n    );\n  }\n  return target;\n}\n\nexport async function filterMapResolutionResult<T extends { name: string }>(\n  results: ResolutionResult,\n  filterMap: (resolution: DependencyResolution) => Promise<T | null> | T | null\n): Promise<Record<string, T>> {\n  const resolutions = await taskAll(Object.keys(results), async (key) => {\n    const resolution = results[key];\n    const result = resolution ? await filterMap(resolution) : null;\n    // If we failed to find a matching resolution from `searchPaths`, also try the other duplicates\n    // to see if the `searchPaths` result is not a module but another is\n    if (resolution?.source === DependencyResolutionSource.SEARCH_PATH && !result) {\n      for (let idx = 0; resolution.duplicates && idx < resolution.duplicates.length; idx++) {\n        const duplicate = resolution.duplicates[idx];\n        const duplicateResult = await filterMap({ ...resolution, ...duplicate });\n        if (duplicateResult != null) {\n          return duplicateResult;\n        }\n      }\n    }\n    return result;\n  });\n  const output: Record<string, T> = Object.create(null);\n  for (let idx = 0; idx < resolutions.length; idx++) {\n    const resolution = resolutions[idx];\n    if (resolution != null) {\n      output[resolution.name] = resolution;\n    }\n  }\n  return output;\n}\n\nexport function mergeResolutionResults(\n  results: ResolutionResult[],\n  base?: ResolutionResult\n): ResolutionResult {\n  if (base == null && results.length === 1) {\n    return results[0];\n  }\n  const output: ResolutionResult = base == null ? Object.create(null) : base;\n  for (let idx = 0; idx < results.length; idx++) {\n    for (const key in results[idx]) {\n      const resolution = results[idx][key]!;\n      const prevResolution = output[key];\n      if (prevResolution != null) {\n        output[key] = mergeWithDuplicate(prevResolution, resolution);\n      } else {\n        output[key] = resolution;\n      }\n    }\n  }\n  return output;\n}\n"]}