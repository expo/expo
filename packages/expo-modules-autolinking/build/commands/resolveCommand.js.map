{"version":3,"file":"resolveCommand.js","sourceRoot":"","sources":["../../src/commands/resolveCommand.ts"],"names":[],"mappings":";;AAgCA,wCAuEC;AArGD,6DAI8B;AAC9B,4DAA8D;AAC9D,sEAAmE;AACnE,kEAGuC;AACvC,wCAA4C;AAQ5C,SAAS,eAAe,CACtB,MAAwB;IAExB,OAAQ,MAAuC,CAAC,YAAY,KAAK,SAAS,CAAC;AAC7E,CAAC;AAMD,uFAAuF;AACvF,SAAgB,cAAc,CAAC,GAA8B;IAC3D,OAAO,IAAA,iDAA4B,EAAC,GAAG,CAAC,OAAO,CAAC,0BAA0B,CAAC,CAAC;SACzE,MAAM,CAAC,YAAY,EAAE,0CAA0C,EAAE,GAAG,EAAE,CAAC,IAAI,EAAE,KAAK,CAAC;SACnF,MAAM,CAAC,KAAK,EAAE,WAA4B,EAAE,gBAAkC,EAAE,EAAE;QACjF,MAAM,QAAQ,GAAG,gBAAgB,CAAC,QAAQ,IAAI,OAAO,CAAC;QACtD,MAAM,wBAAwB,GAAG,IAAA,mDAA8B,EAAC;YAC9D,GAAG,gBAAgB;YACnB,WAAW;SACZ,CAAC,CAAC;QAEH,MAAM,IAAA,wBAAc,GAAE,CAAC,YAAY,CAAC,KAAK,IAAI,EAAE;YAC7C,MAAM,kBAAkB,GAAG,MAAM,wBAAwB,CAAC,kBAAkB,CAAC,QAAQ,CAAC,CAAC;YACvF,MAAM,OAAO,GAAG,MAAM,wBAAwB,CAAC,UAAU,EAAE,CAAC;YAE5D,MAAM,wBAAwB,GAAG,MAAM,IAAA,8BAAgB,EAAC;gBACtD,kBAAkB;gBAClB,OAAO;aACR,CAAC,CAAC;YAEH,MAAM,yBAAyB,GAAG,MAAM,IAAA,oCAAmB,EACzD,wBAAwB,EACxB,kBAAkB,CACnB,CAAC;YAEF,MAAM,iBAAiB,GAAG,MAAM,IAAA,mDAAkC,EAAC;gBACjE,WAAW,EAAE,wBAAwB,CAAC,cAAc,EAAE;gBACtD,QAAQ;aACT,CAAC,CAAC;YAEH,MAAM,aAAa,GAAG,IAAA,mCAAgB,EAAC,EAAE,kBAAkB,EAAE,CAAC,CAAC;YAE/D,MAAM,YAAY,GAAG;gBACnB,GAAG,yBAAyB,CAAC,MAAM,CAAc,CAAC,GAAG,EAAE,MAAM,EAAE,EAAE;oBAC/D,IAAI,eAAe,CAAC,MAAM,CAAC,EAAE,CAAC;wBAC5B,MAAM,QAAQ,GAAG,MAAM,CAAC,YAAY,IAAI,EAAE,CAAC;wBAC3C,KAAK,MAAM,OAAO,IAAI,QAAQ,EAAE,CAAC;4BAC/B,GAAG,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;wBACnB,CAAC;wBACD,OAAO,GAAG,CAAC;oBACb,CAAC;oBAED,OAAO,GAAG,CAAC;gBACb,CAAC,EAAE,IAAI,GAAG,EAAE,CAAC;aACd,CAAC;YAEF,IAAI,gBAAgB,CAAC,IAAI,EAAE,CAAC;gBAC1B,OAAO,CAAC,GAAG,CACT,IAAI,CAAC,SAAS,CAAC;oBACb,iBAAiB;oBACjB,YAAY;oBACZ,OAAO,EAAE,yBAAyB;oBAClC,GAAG,CAAC,aAAa,CAAC,CAAC,CAAC,EAAE,aAAa,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;iBAC5C,CAAC,CACH,CAAC;YACJ,CAAC;iBAAM,CAAC;gBACN,OAAO,CAAC,GAAG,CACT,OAAO,CAAC,MAAM,CAAC,CAAC,OAAO,CACrB;oBACE,iBAAiB;oBACjB,YAAY;oBACZ,OAAO,EAAE,yBAAyB;oBAClC,GAAG,CAAC,aAAa,CAAC,CAAC,CAAC,EAAE,aAAa,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;iBAC5C,EACD,KAAK,EACL,IAAI,EACJ,IAAI,CACL,CACF,CAAC;YACJ,CAAC;QACH,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACP,CAAC","sourcesContent":["import commander from 'commander';\n\nimport {\n  AutolinkingCommonArguments,\n  createAutolinkingOptionsLoader,\n  registerAutolinkingArguments,\n} from './autolinkingOptions';\nimport { findModulesAsync } from '../autolinking/findModules';\nimport { getConfiguration } from '../autolinking/getConfiguration';\nimport {\n  resolveModulesAsync,\n  resolveExtraBuildDependenciesAsync,\n} from '../autolinking/resolveModules';\nimport { createMemoizer } from '../memoize';\nimport type {\n  ModuleDescriptor,\n  CommonNativeModuleDescriptor,\n  ModuleDescriptorAndroid,\n  ModuleDescriptorIos,\n} from '../types';\n\nfunction hasCoreFeatures(\n  module: ModuleDescriptor\n): module is ModuleDescriptorAndroid | ModuleDescriptorIos {\n  return (module as CommonNativeModuleDescriptor).coreFeatures !== undefined;\n}\n\ninterface ResolveArguments extends AutolinkingCommonArguments {\n  json?: boolean | null;\n}\n\n/** Searches for available expo modules and resolves the results for given platform. */\nexport function resolveCommand(cli: commander.CommanderStatic) {\n  return registerAutolinkingArguments(cli.command('resolve [searchPaths...]'))\n    .option('-j, --json', 'Output results in the plain JSON format.', () => true, false)\n    .action(async (searchPaths: string[] | null, commandArguments: ResolveArguments) => {\n      const platform = commandArguments.platform ?? 'apple';\n      const autolinkingOptionsLoader = createAutolinkingOptionsLoader({\n        ...commandArguments,\n        searchPaths,\n      });\n\n      await createMemoizer().withMemoizer(async () => {\n        const autolinkingOptions = await autolinkingOptionsLoader.getPlatformOptions(platform);\n        const appRoot = await autolinkingOptionsLoader.getAppRoot();\n\n        const expoModulesSearchResults = await findModulesAsync({\n          autolinkingOptions,\n          appRoot,\n        });\n\n        const expoModulesResolveResults = await resolveModulesAsync(\n          expoModulesSearchResults,\n          autolinkingOptions\n        );\n\n        const extraDependencies = await resolveExtraBuildDependenciesAsync({\n          commandRoot: autolinkingOptionsLoader.getCommandRoot(),\n          platform,\n        });\n\n        const configuration = getConfiguration({ autolinkingOptions });\n\n        const coreFeatures = [\n          ...expoModulesResolveResults.reduce<Set<string>>((acc, module) => {\n            if (hasCoreFeatures(module)) {\n              const features = module.coreFeatures ?? [];\n              for (const feature of features) {\n                acc.add(feature);\n              }\n              return acc;\n            }\n\n            return acc;\n          }, new Set()),\n        ];\n\n        if (commandArguments.json) {\n          console.log(\n            JSON.stringify({\n              extraDependencies,\n              coreFeatures,\n              modules: expoModulesResolveResults,\n              ...(configuration ? { configuration } : {}),\n            })\n          );\n        } else {\n          console.log(\n            require('util').inspect(\n              {\n                extraDependencies,\n                coreFeatures,\n                modules: expoModulesResolveResults,\n                ...(configuration ? { configuration } : {}),\n              },\n              false,\n              null,\n              true\n            )\n          );\n        }\n      });\n    });\n}\n"]}