{"version":3,"file":"generateModulesProviderCommand.js","sourceRoot":"","sources":["../../src/commands/generateModulesProviderCommand.ts"],"names":[],"mappings":";;;;;AAwBA,wEA+DC;AAtFD,4CAAoB;AAEpB,6DAI8B;AAC9B,4DAA8D;AAC9D,4EAAkF;AAClF,kEAAoE;AAapE,0EAA0E;AAC1E,SAAgB,8BAA8B,CAAC,GAA8B;IAC3E,OAAO,IAAA,iDAA4B,EACjC,GAAG,CAAC,OAAO,CAAC,wEAAwE,CAAC,CACtF;SACE,MAAM,CACL,qBAAqB,EACrB,uEAAuE,CACxE;SACA,MAAM,CAAC,sBAAsB,EAAE,mDAAmD,CAAC;SACnF,MAAM,CACL,8BAA8B,EAC9B,qEAAqE,CACtE;SACA,MAAM,CAAC,mBAAmB,EAAE,iCAAiC,CAAC;SAC9D,MAAM,CACL,KAAK,EACH,yBAAiC,EACjC,WAA4B,EAC5B,gBAAkD,EAClD,EAAE;QACF,MAAM,QAAQ,GAAG,gBAAgB,CAAC,QAAQ,IAAI,OAAO,CAAC;QACtD,MAAM,wBAAwB,GAAG,IAAA,mDAA8B,EAAC;YAC9D,GAAG,gBAAgB;YACnB,WAAW;SACZ,CAAC,CAAC;QACH,MAAM,kBAAkB,GAAG,MAAM,wBAAwB,CAAC,kBAAkB,CAAC,QAAQ,CAAC,CAAC;QAEvF,MAAM,wBAAwB,GAAG,MAAM,IAAA,8BAAgB,EAAC;YACtD,kBAAkB,EAAE,MAAM,wBAAwB,CAAC,kBAAkB,CAAC,QAAQ,CAAC;YAC/E,OAAO,EAAE,gBAAgB,CAAC,OAAO,IAAI,CAAC,MAAM,wBAAwB,CAAC,UAAU,EAAE,CAAC;SACnF,CAAC,CAAC;QACH,MAAM,yBAAyB,GAAG,MAAM,IAAA,oCAAmB,EACzD,wBAAwB,EACxB,kBAAkB,CACnB,CAAC;QAEF,MAAM,cAAc,GAAG,IAAI,GAAG,CAAC,gBAAgB,CAAC,QAAQ,IAAI,EAAE,CAAC,CAAC;QAChE,MAAM,eAAe,GAAG,yBAAyB,CAAC,MAAM,CAAC,CAAC,MAAM,EAAE,EAAE,CAClE,cAAc,CAAC,GAAG,CAAC,MAAM,CAAC,WAAW,CAAC,CACvC,CAAC;QAEF,MAAM,iBAAiB,GAA6B,MAAM,YAAE,CAAC,QAAQ;aAClE,QAAQ,CAAC,yBAAyB,EAAE;YACnC,QAAQ,EAAE,MAAM;SACjB,CAAC;aACD,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;aAChC,KAAK,CAAC,GAAG,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QAErB,MAAM,kBAAkB,GAAG,IAAI,CAAC,KAAK,CACnC,iBAAiB,CAAC,uCAAuC,CAAC,IAAI,IAAI,CACnE,CAAC;QAEF,MAAM,IAAA,kDAA4B,EAChC,eAAe,EACf;YACE,QAAQ;YACR,UAAU,EAAE,gBAAgB,CAAC,MAAM;YACnC,eAAe,EAAE,gBAAgB,CAAC,WAAW,IAAI,IAAI;SACtD,EACD,kBAAkB,CACnB,CAAC;IACJ,CAAC,CACF,CAAC;AACN,CAAC","sourcesContent":["import commander from 'commander';\nimport fs from 'fs';\n\nimport {\n  AutolinkingCommonArguments,\n  createAutolinkingOptionsLoader,\n  registerAutolinkingArguments,\n} from './autolinkingOptions';\nimport { findModulesAsync } from '../autolinking/findModules';\nimport { generateModulesProviderAsync } from '../autolinking/generatePackageList';\nimport { resolveModulesAsync } from '../autolinking/resolveModules';\n\ninterface GenerateModulesProviderArguments extends AutolinkingCommonArguments {\n  target: string;\n  entitlement?: string;\n  packages?: string[] | null;\n  appRoot?: string;\n}\n\ntype PartialPodfileProperties = {\n  'expo.inlineModules.watchedDirectories'?: string;\n};\n\n/** Generates a source file listing all packages to link in the runtime */\nexport function generateModulesProviderCommand(cli: commander.CommanderStatic) {\n  return registerAutolinkingArguments(\n    cli.command('generate-modules-provider <podfilePropertiesFilePath> [searchPaths...]')\n  )\n    .option(\n      '-t, --target <path>',\n      'Path to the target file, where the package list should be written to.'\n    )\n    .option('--entitlement <path>', 'Path to the Apple code signing entitlements file.')\n    .option(\n      '-p, --packages <packages...>',\n      'Names of the packages to include in the generated modules provider.'\n    )\n    .option('--app-root <path>', 'Path to the app root directory.')\n    .action(\n      async (\n        podfilePropertiesFilePath: string,\n        searchPaths: string[] | null,\n        commandArguments: GenerateModulesProviderArguments\n      ) => {\n        const platform = commandArguments.platform ?? 'apple';\n        const autolinkingOptionsLoader = createAutolinkingOptionsLoader({\n          ...commandArguments,\n          searchPaths,\n        });\n        const autolinkingOptions = await autolinkingOptionsLoader.getPlatformOptions(platform);\n\n        const expoModulesSearchResults = await findModulesAsync({\n          autolinkingOptions: await autolinkingOptionsLoader.getPlatformOptions(platform),\n          appRoot: commandArguments.appRoot ?? (await autolinkingOptionsLoader.getAppRoot()),\n        });\n        const expoModulesResolveResults = await resolveModulesAsync(\n          expoModulesSearchResults,\n          autolinkingOptions\n        );\n\n        const includeModules = new Set(commandArguments.packages ?? []);\n        const filteredModules = expoModulesResolveResults.filter((module) =>\n          includeModules.has(module.packageName)\n        );\n\n        const podfileProperties: PartialPodfileProperties = await fs.promises\n          .readFile(podfilePropertiesFilePath, {\n            encoding: 'utf8',\n          })\n          .then((file) => JSON.parse(file))\n          .catch(() => ({}));\n\n        const watchedDirectories = JSON.parse(\n          podfileProperties['expo.inlineModules.watchedDirectories'] ?? '[]'\n        );\n\n        await generateModulesProviderAsync(\n          filteredModules,\n          {\n            platform,\n            targetPath: commandArguments.target,\n            entitlementPath: commandArguments.entitlement ?? null,\n          },\n          watchedDirectories\n        );\n      }\n    );\n}\n"]}