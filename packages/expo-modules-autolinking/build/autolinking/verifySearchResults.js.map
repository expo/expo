{"version":3,"file":"verifySearchResults.js","sourceRoot":"","sources":["../../src/autolinking/verifySearchResults.ts"],"names":[],"mappings":"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","sourcesContent":["import chalk from 'chalk';\nimport fs from 'fs';\nimport path from 'path';\n\nimport {\n  BaseDependencyResolution,\n  DependencyResolution,\n  DependencyResolutionSource,\n  ResolutionResult,\n} from '../dependencies';\n\ninterface VerifyOptions {\n  projectRoot: string;\n  verbose?: boolean;\n  json?: boolean;\n}\n\ninterface VerifyGroups {\n  reactNativeProjectConfig: DependencyResolution[];\n  searchPaths: DependencyResolution[];\n  dependencies: DependencyResolution[];\n  duplicates: DependencyResolution[];\n}\n\n/**\n * Verifies the search results by checking whether there are no duplicates.\n */\nexport async function verifySearchResults(\n  results: ResolutionResult,\n  options: VerifyOptions\n): Promise<void> {\n  const { projectRoot } = options;\n\n  async function getHumanReadableDependency(dependency: BaseDependencyResolution): Promise<string> {\n    let version = dependency.version || null;\n    if (!version) {\n      try {\n        const pkgContents = await fs.promises.readFile(\n          path.join(dependency.path, 'package.json'),\n          'utf8'\n        );\n        const pkg: unknown = JSON.parse(pkgContents);\n        if (pkg && typeof pkg === 'object' && 'version' in pkg && typeof pkg.version === 'string') {\n          version = pkg.version;\n        }\n      } catch (error) {\n        version = null;\n      }\n    }\n    const relative = path.relative(projectRoot, dependency.originPath);\n    return version\n      ? `${dependency.name}@${version} (at: ${relative})`\n      : `${dependency.name} at: ${relative}`;\n  }\n\n  const groups: VerifyGroups = {\n    reactNativeProjectConfig: [],\n    searchPaths: [],\n    dependencies: [],\n    duplicates: [],\n  };\n\n  for (const moduleName in results) {\n    const revision = results[moduleName];\n    if (!revision) {\n      continue;\n    } else if (revision.duplicates?.length) {\n      groups.duplicates.push(revision);\n    } else {\n      switch (revision.source) {\n        case DependencyResolutionSource.RN_CLI_LOCAL:\n          groups.reactNativeProjectConfig.push(revision);\n          break;\n        case DependencyResolutionSource.SEARCH_PATH:\n          groups.searchPaths.push(revision);\n          break;\n        case DependencyResolutionSource.RECURSIVE_RESOLUTION:\n          groups.dependencies.push(revision);\n          break;\n      }\n    }\n  }\n\n  if (options.json) {\n    console.log(JSON.stringify(groups));\n    return;\n  }\n\n  if (options.verbose) {\n    if (groups.reactNativeProjectConfig.length) {\n      console.log(\n        `üîé  Found ${groups.reactNativeProjectConfig.length} modules from React Native project config`\n      );\n      for (const revision of groups.reactNativeProjectConfig) {\n        console.log(` - ${await getHumanReadableDependency(revision)}`);\n      }\n    }\n\n    if (groups.searchPaths.length) {\n      console.log(`üîé  Found ${groups.searchPaths.length} modules in search paths`);\n      for (const revision of groups.searchPaths) {\n        console.log(` - ${await getHumanReadableDependency(revision)}`);\n      }\n    }\n\n    console.log(`üîé  Found ${groups.dependencies.length} modules in dependencies`);\n    for (const revision of groups.dependencies) {\n      console.log(` - ${await getHumanReadableDependency(revision)}`);\n    }\n  }\n\n  if (groups.duplicates.length) {\n    for (const revision of groups.duplicates) {\n      console.warn(`‚ö†Ô∏è  Found duplicate installations for ${chalk.green(revision.name)}`);\n      const revisions = [revision, ...(revision.duplicates ?? [])];\n      for (let idx = 0; idx < revisions.length; idx++) {\n        const prefix = idx !== revisions.length - 1 ? '‚îú‚îÄ' : '‚îî‚îÄ';\n        const duplicate = revisions[idx];\n        console.log(`  ${prefix} ${await getHumanReadableDependency(duplicate)}`);\n      }\n    }\n\n    console.warn(\n      '‚ö†Ô∏è  Multiple versions of the same module may introduce some side effects or compatibility issues.\\n' +\n        `Resolve your dependency issues and deduplicate your dependencies. Learn more: https://expo.fyi/resolving-dependency-issues`\n    );\n  } else {\n    console.log('‚úÖ Everything is fine!');\n  }\n}\n"]}