{"version":3,"file":"defineRouter.js","sourceRoot":"","sources":["../../../src/rsc/router/defineRouter.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Copyright © 2024 650 Industries.\n * Copyright © 2024 2023 Daishi Kato\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { createElement } from 'react';\nimport type { ComponentProps, FunctionComponent, ReactNode } from 'react';\n\nimport { ServerRouter } from './client';\nimport {\n  getComponentIds,\n  getInputString,\n  parseInputString,\n  PARAM_KEY_SKIP,\n  SHOULD_SKIP_ID,\n  LOCATION_ID,\n} from './common';\nimport type { RouteProps, ShouldSkip } from './common';\nimport { Children, Slot } from './host';\nimport { getPathMapping } from '../path';\nimport type { PathSpec } from '../path';\nimport { defineEntries, rerender } from '../server';\nimport type { BuildConfig, RenderEntries, GetBuildConfig, GetSsrConfig } from '../server';\n\ntype RoutePropsForLayout = Omit<RouteProps, 'searchParams'> & {\n  children: ReactNode;\n};\n\ntype ShouldSkipValue = ShouldSkip[number][1];\n\nexport function unstable_defineRouter(\n  getPathConfig: () => Promise<\n    Iterable<{\n      path: PathSpec;\n      isStatic?: boolean;\n      noSsr?: boolean;\n      data?: unknown; // For build: put in customData\n    }>\n  >,\n  getComponent: (\n    componentId: string, // \"**/layout\" or \"**/page\"\n    options: {\n      // TODO setShouldSkip API is too hard to understand\n      unstable_setShouldSkip: (val?: ShouldSkipValue) => void;\n      unstable_buildConfig: BuildConfig | undefined;\n    }\n  ) => Promise<FunctionComponent<RouteProps> | FunctionComponent<RoutePropsForLayout> | null>\n): ReturnType<typeof defineEntries> {\n  type MyPathConfig = {\n    pathname: PathSpec;\n    isStatic?: boolean | undefined;\n    customData: { noSsr?: boolean; data: unknown };\n  }[];\n  let cachedPathConfig: MyPathConfig | undefined;\n  const getMyPathConfig = async (buildConfig?: BuildConfig): Promise<MyPathConfig> => {\n    if (buildConfig) {\n      return buildConfig as MyPathConfig;\n    }\n    if (!cachedPathConfig) {\n      cachedPathConfig = Array.from(await getPathConfig()).map((item) => {\n        return {\n          pathname: item.path,\n          isStatic: item.isStatic,\n          customData: { noSsr: !!item.noSsr, data: item.data },\n        };\n      });\n    }\n    return cachedPathConfig;\n  };\n  const existsPath = async (\n    pathname: string,\n    buildConfig: BuildConfig | undefined\n  ): Promise<['FOUND', 'NO_SSR'?] | ['NOT_FOUND']> => {\n    const pathConfig = await getMyPathConfig(buildConfig);\n    const found = pathConfig.find(({ pathname: pathSpec }) => getPathMapping(pathSpec, pathname));\n    return found ? (found.customData.noSsr ? ['FOUND', 'NO_SSR'] : ['FOUND']) : ['NOT_FOUND'];\n  };\n  const shouldSkipObj: {\n    [componentId: ShouldSkip[number][0]]: ShouldSkip[number][1];\n  } = {};\n\n  const renderEntries: RenderEntries = async (input, { searchParams, buildConfig }) => {\n    const pathname = parseInputString(input);\n    if ((await existsPath(pathname, buildConfig))[0] === 'NOT_FOUND') {\n      return null;\n    }\n    const skip = searchParams.getAll(PARAM_KEY_SKIP) || [];\n    searchParams.delete(PARAM_KEY_SKIP); // delete all\n    const componentIds = getComponentIds(pathname);\n    const entries: (readonly [string, ReactNode])[] = (\n      await Promise.all(\n        componentIds.map(async (id) => {\n          if (skip?.includes(id)) {\n            return [];\n          }\n          const setShoudSkip = (val?: ShouldSkipValue) => {\n            if (val) {\n              shouldSkipObj[id] = val;\n            } else {\n              delete shouldSkipObj[id];\n            }\n          };\n          const component = await getComponent(id, {\n            unstable_setShouldSkip: setShoudSkip,\n            unstable_buildConfig: buildConfig,\n          });\n          if (!component) {\n            return [];\n          }\n\n          const element = createElement(\n            component as FunctionComponent<{\n              path: string;\n              searchParams?: URLSearchParams;\n            }>,\n            id.endsWith('/layout') ? { path: pathname } : { path: pathname, searchParams },\n            createElement(Children)\n          );\n          return [[id, element]] as const;\n        })\n      )\n    ).flat();\n    entries.push([SHOULD_SKIP_ID, Object.entries(shouldSkipObj)]);\n    entries.push([LOCATION_ID, [pathname, searchParams.toString()]]);\n    return Object.fromEntries(entries);\n  };\n\n  const getBuildConfig: GetBuildConfig = async (unstable_collectClientModules) => {\n    const pathConfig = await getMyPathConfig();\n    const path2moduleIds: Record<string, string[]> = {};\n    for (const { pathname: pathSpec } of pathConfig) {\n      if (pathSpec.some(({ type }) => type !== 'literal')) {\n        continue;\n      }\n      const pathname = '/' + pathSpec.map(({ name }) => name).join('/');\n      const input = getInputString(pathname);\n      const moduleIds = await unstable_collectClientModules(input);\n      path2moduleIds[pathname] = moduleIds;\n    }\n    const customCode = `\nglobalThis.__EXPO_ROUTER_PREFETCH__ = (path) => {\n  const path2ids = ${JSON.stringify(path2moduleIds)};\n  for (const id of path2ids[path] || []) {\n    import(id);\n  }\n};`;\n    const buildConfig: BuildConfig = [];\n    for (const { pathname: pathSpec, isStatic, customData } of pathConfig) {\n      const entries: BuildConfig[number]['entries'] = [];\n      if (pathSpec.every(({ type }) => type === 'literal')) {\n        const pathname = '/' + pathSpec.map(({ name }) => name).join('/');\n        const input = getInputString(pathname);\n        entries.push({ input, isStatic });\n      }\n      buildConfig.push({\n        pathname: pathSpec,\n        isStatic,\n        entries,\n        customCode,\n        customData,\n      });\n    }\n    return buildConfig;\n  };\n\n  const getSsrConfig: GetSsrConfig = async (pathname, { searchParams, buildConfig }) => {\n    const pathStatus = await existsPath(pathname, buildConfig);\n    if (pathStatus[1] === 'NO_SSR') {\n      return null;\n    }\n    if (pathStatus[0] === 'NOT_FOUND') {\n      return null;\n    }\n    const componentIds = getComponentIds(pathname);\n    const input = getInputString(pathname);\n    const body = createElement(\n      ServerRouter as FunctionComponent<Omit<ComponentProps<typeof ServerRouter>, 'children'>>,\n      { route: { path: pathname, searchParams } },\n      componentIds.reduceRight(\n        (acc: ReactNode, id) => createElement(Slot, { id, fallback: acc }, acc),\n        null\n      )\n    );\n    return { input, body };\n  };\n\n  return { renderEntries, getBuildConfig, getSsrConfig };\n}\n\nexport function unstable_redirect(\n  pathname: string,\n  searchParams?: URLSearchParams,\n  skip?: string[]\n) {\n  if (skip) {\n    searchParams = new URLSearchParams(searchParams);\n    for (const id of skip) {\n      searchParams.append(PARAM_KEY_SKIP, id);\n    }\n  }\n  const input = getInputString(pathname);\n  rerender(input, searchParams);\n}\n"]}