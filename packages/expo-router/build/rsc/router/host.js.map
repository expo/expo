{"version":3,"file":"host.js","sourceRoot":"","sources":["../../../src/rsc/router/host.tsx"],"names":[],"mappings":"AAAA;;;;;;;;GAQG;AAEH,uCAAuC;AACvC,YAAY,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEb,qDAAuC;AACvC,iCASe;AAEf,6EAAyD;AAEzD,qCAA8D;AAC9D,mCAAgC;AAChC,qDAAkD;AAElD,MAAM,EAAE,eAAe,EAAE,WAAW,EAAE,GAAG,gBAAU,CAAC;AAEpD,mCAAmC;AACnC,MAAM,QAAQ,GAAG,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,6BAA6B;AAEjF,IAAI,SAAS,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC,aAAa,GAAG,QAAQ,EAAE,CAAC;AAE1D,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;IAC9B,SAAS,GAAG,GAAG,GAAG,SAAS,CAAC;CAC7B;AAED,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;IAC5B,SAAS,IAAI,GAAG,CAAC;CAClB;AAED,IAAI,SAAS,KAAK,GAAG,EAAE;IACrB,MAAM,IAAI,KAAK,CACb,8BAA8B,SAAS,oFACrC,IAAA,2BAAY,GAAE,CAAC,aACjB,EAAE,CACH,CAAC;CACH;AAED,MAAM,WAAW,GAAG,KAAK,EAAE,eAAkC,EAAqB,EAAE;IAClF,8CAA8C;IAC9C,MAAM,QAAQ,GAAG,MAAM,eAAe,CAAC;IACvC,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE;QAChB,qGAAqG;QACrG,yEAAyE;QACzE,IAAI,QAAQ,CAAC,MAAM,KAAK,GAAG,EAAE;YAC3B,MAAM,SAAS,GAAG,MAAM,QAAQ,CAAC,IAAI,EAAE,CAAC;YACxC,IAAI,SAAS,CAAC;YACd,IAAI;gBACF,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;aACnC;YAAC,MAAM;gBACN,MAAM,IAAI,yBAAgB,CAAC,SAAS,EAAE,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,MAAM,CAAC,CAAC;aACtE;YACD,iFAAiF;YACjF,MAAM,IAAI,yBAAgB,CAAC,SAAS,EAAE,QAAQ,CAAC,GAAG,CAAC,CAAC;SACrD;QAED,IAAI,YAAY,CAAC;QACjB,IAAI;YACF,YAAY,GAAG,MAAM,QAAQ,CAAC,IAAI,EAAE,CAAC;SACtC;QAAC,MAAM;YACN,MAAM,IAAI,yBAAgB,CAAC,QAAQ,CAAC,UAAU,EAAE,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,MAAM,CAAC,CAAC;SAChF;QACD,MAAM,IAAI,yBAAgB,CAAC,YAAY,EAAE,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,MAAM,CAAC,CAAC;KACzE;IACD,OAAO,CAAC,GAAG,CAAC,kBAAkB,EAAE,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,MAAM,CAAC,CAAC;IAE/D,OAAO,QAAQ,CAAC;AAClB,CAAC,CAAC;AAIF,SAAS,SAAS,CAAI,CAAU,EAAE,CAAqB,EAAE,CAAS;IAChE,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAM,CAAC;AACpD,CAAC;AAED,MAAM,MAAM,GAAG,IAAI,OAAO,EAAE,CAAC;AAC7B,MAAM,aAAa,GAAG,CAAC,CAAW,EAAE,CAA+B,EAAY,EAAE;IAC/E,MAAM,SAAS,GAAG,KAAK,IAAI,EAAE;QAC3B,MAAM,YAAY,GAAG,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC;QACpD,OAAO,YAAY,CAAC,MAAM,CAAC;QAC3B,OAAO,YAAY,CAAC;IACtB,CAAC,CAAC;IACF,MAAM,MAAM,GAAG,SAAS,CAAC,GAAG,EAAE,CAAC,IAAI,OAAO,EAAE,EAAE,MAAM,EAAE,CAAC,CAAC,CAAC;IACzD,OAAO,SAAS,CAAC,SAAS,EAAE,MAAM,EAAE,CAAC,CAAC,CAAC;AACzC,CAAC,CAAC;AAUF,MAAM,UAAU,GAAkB,EAAE,CAAC;AAErC,MAAM,gBAAgB,GAAG,kBAAkB,CAAC;AAErC,MAAM,QAAQ,GAAG,CACtB,KAAa,EACb,kBAA0B,EAC1B,WAAwB,EACxB,KAAK,GAAG,UAAU,EAClB,oBAA8C,EAC9C,YAAkC,EACxB,EAAE;IACZ,mCAAmC;IACnC,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,aAAa,EAAE;QAC1C,MAAM,UAAU,GAAG,GAAG,EAAE;YACtB,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;YAChB,MAAM,IAAI,GAAG,IAAA,gBAAQ,EAAC,KAAK,EAAE,kBAAkB,EAAE,WAAW,EAAE,KAAK,EAAE,oBAAoB,EAAE;gBACzF,MAAM,EAAE,IAAI;aACb,CAAC,CAAC;YACH,WAAW,CAAC,IAAI,CAAC,CAAC;QACpB,CAAC,CAAC;QACF,UAAU,CAAC,6BAA6B,KAAK,EAAE,CAAC;QAChD,MAAM,KAAK,GAAG,UAAU,CAAC,6BAA6B,CAAC,OAAO,CAAC,UAAU,CAAC,oBAAoB,CAAC,CAAC;QAChG,IAAI,KAAK,KAAK,CAAC,CAAC,EAAE;YAChB,UAAU,CAAC,6BAA6B,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,EAAE,UAAU,CAAC,CAAC;SACvE;aAAM;YACL,UAAU,CAAC,6BAA6B,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;SAC3D;QACD,UAAU,CAAC,oBAAoB,GAAG,UAAU,CAAC;KAC9C;IAED,IAAI,KAAK,GAA2B,KAAK,CAAC,CAAC,CAAC,CAAC;IAC7C,IAAI,KAAK,IAAI,KAAK,CAAC,CAAC,CAAC,KAAK,KAAK,IAAI,KAAK,CAAC,CAAC,CAAC,KAAK,kBAAkB,EAAE;QAClE,KAAK,CAAC,CAAC,CAAC,GAAG,WAAW,CAAC;QACvB,OAAO,KAAK,CAAC,CAAC,CAAC,CAAC;KACjB;IACD,MAAM,OAAO,GAAG;QACd,KAAK,CAAC,UAAU,CAAC,QAAgB,EAAE,IAAe;YAChD,OAAO,CAAC,GAAG,CAAC,iCAAiC,EAAE,QAAQ,CAAC,CAAC;YACzD,MAAM,OAAO,GAAG,yBAAyB,CACvC,SAAS,GAAG,WAAW,CAAC,kBAAkB,CAAC,QAAQ,CAAC,CAAC,CACtD,CAAC;YAEF,IAAI,WAAkD,CAAC;YACvD,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,YAAY,QAAQ,CAAC,EAAE;gBACnE,WAAW,GAAG;oBACZ,OAAO,EAAE,EAAE,MAAM,EAAE,gBAAgB,EAAE;oBACrC,IAAI,EAAE,MAAM,WAAW,CAAC,IAAI,CAAC;iBAC9B,CAAC;aACH;iBAAM;gBACL,WAAW,GAAG;oBACZ,OAAO,EAAE;wBACP,MAAM,EAAE,gBAAgB;wBACxB,cAAc,EAAE,kBAAkB;qBACnC;oBACD,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC;iBAC3B,CAAC;aACH;YAED,MAAM,QAAQ,GAAG,IAAA,aAAK,EAAC,OAAO,EAAE;gBAC9B,MAAM,EAAE,MAAM;gBACd,wDAAwD;gBACxD,MAAM,EAAE,MAAM;gBACd,GAAG,WAAW;gBACd,OAAO,EAAE;oBACP,GAAG,WAAW,CAAC,OAAO;oBACtB,eAAe,EAAE,OAAO,CAAC,GAAG,CAAC,OAAQ;iBACtC;aACF,CAAC,CAAC;YACH,MAAM,IAAI,GAAG,eAAe,CAAoB,WAAW,CAAC,QAAQ,CAAC,EAAE,OAAO,CAAC,CAAC;YAChF,MAAM,WAAW,GAAG,KAAM,CAAC,CAAC,CAAC,CAAC;YAC9B,IAAA,uBAAe,EAAC,GAAG,EAAE;gBACnB,oDAAoD;gBACpD,WAAW,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,aAAa,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;YACnD,CAAC,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC;YAC3B,OAAO,CAAC,GAAG,CAAC,kCAAkC,EAAE,OAAO,CAAC,MAAM,CAAC,CAAC;YAEhE,OAAO,OAAO,CAAC,MAAM,CAAC;QACxB,CAAC;KACF,CAAC;IACF,2CAA2C;IAC3C,MAAM,UAAU,GAAG,CAAE,UAAkB,CAAC,mBAAmB,KAAK,EAAE,CAAC,CAAC;IACpE,MAAM,GAAG,GAAG,SAAS,GAAG,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,CAAC,GAAG,GAAG,kBAAkB,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;IAClG,MAAM,OAAO,GAAG,YAAY,EAAE,MAAM,CAAC,CAAC,CAAC,yBAAyB,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,mBAAmB,CAAC,GAAG,CAAC,CAAC;IACjG,OAAO,CAAC,GAAG,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;IAC9B,MAAM,QAAQ,GACZ,UAAU,CAAC,GAAG,CAAC;QACf,IAAA,aAAK,EAAC,OAAO,EAAE;YACb,OAAO,EAAE;gBACP,eAAe,EAAE,OAAO,CAAC,GAAG,CAAC,OAAQ;aACtC;SACF,CAAC,CAAC;IACL,OAAO,UAAU,CAAC,GAAG,CAAC,CAAC;IACvB,MAAM,IAAI,GAAG,eAAe,CAAoB,WAAW,CAAC,QAAQ,CAAC,EAAE,OAAO,CAAC,CAAC;IAChF,oBAAoB,EAAE,CAAC,IAAI,CAAC,CAAC;IAE7B,2CAA2C;IAC3C,KAAK,CAAC,CAAC,CAAC,GAAG,KAAK,GAAG,CAAC,KAAK,EAAE,kBAAkB,EAAE,WAAW,EAAE,IAAI,CAAC,CAAC;IAClE,OAAO,IAAI,CAAC;AACd,CAAC,CAAC;AAjGW,QAAA,QAAQ,YAiGnB;AAEF,SAAS,yBAAyB,CAAC,IAAY;IAC7C,IAAI,OAAO,CAAC,GAAG,CAAC,OAAO,KAAK,KAAK,EAAE;QACjC,OAAO,IAAI,CAAC;KACb;IAED,OAAO,IAAI,GAAG,CAAC,IAAI,EAAE,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,QAAQ,EAAE,CAAC;AACxD,CAAC;AAED,SAAS,mBAAmB,CAAC,IAAY;IACvC,IAAI,OAAO,CAAC,GAAG,CAAC,OAAO,KAAK,KAAK,EAAE;QACjC,OAAO,IAAI,CAAC;KACb;IAED,+DAA+D;IAC/D,IAAI,IAAI,CAAC,KAAK,CAAC,gBAAgB,CAAC,EAAE;QAChC,OAAO,yBAAyB,CAAC,IAAI,CAAC,CAAC;KACxC;IAED,IAAI,IAAA,2BAAY,GAAE,CAAC,sBAAsB,EAAE;QACzC,OAAO,yBAAyB,CAAC,IAAI,CAAC,CAAC;KACxC;IAED,IAAI,OAAO,CAAC,GAAG,CAAC,OAAO,KAAK,SAAS,EAAE;QACrC,OAAO,uBAAuB,GAAG,IAAI,CAAC;KACvC;IAED,OAAO,SAAS,GAAG,EAAE,CAAC,eAAe,GAAG,IAAI,CAAC;AAC/C,CAAC;AAEM,MAAM,WAAW,GAAG,CAAC,KAAa,EAAE,kBAA0B,EAAQ,EAAE;IAC7E,2CAA2C;IAC3C,MAAM,UAAU,GAAG,CAAE,UAAkB,CAAC,mBAAmB,KAAK,EAAE,CAAC,CAAC;IACpE,MAAM,GAAG,GAAG,mBAAmB,CAC7B,SAAS,GAAG,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC,CAAC,GAAG,GAAG,kBAAkB,CAAC,CAAC,CAAC,EAAE,CAAC,CACtF,CAAC;IACF,IAAI,CAAC,CAAC,GAAG,IAAI,UAAU,CAAC,EAAE;QACxB,UAAU,CAAC,GAAG,CAAC,GAAG,IAAA,aAAK,EAAC,GAAG,EAAE;YAC3B,OAAO,EAAE;gBACP,eAAe,EAAE,OAAO,CAAC,GAAG,CAAC,OAAQ;aACtC;SACF,CAAC,CAAC;KACJ;AACH,CAAC,CAAC;AAbW,QAAA,WAAW,eAatB;AAEF,MAAM,cAAc,GAAG,IAAA,qBAAa,EAClC,GAAG,EAAE;IACH,MAAM,IAAI,KAAK,CAAC,wBAAwB,CAAC,CAAC;AAC5C,CAAC,CACF,CAAC;AACF,MAAM,eAAe,GAAG,IAAA,qBAAa,EAAkB,IAAI,CAAC,CAAC;AAEtD,MAAM,IAAI,GAAG,CAAC,EACnB,YAAY,EACZ,yBAAyB,EACzB,KAAK,EACL,oBAAoB,EACpB,QAAQ,GAOT,EAAE,EAAE;IACH,MAAM,CAAC,QAAQ,EAAE,WAAW,CAAC,GAAG,IAAA,gBAAQ,EAAC,GAAG,EAAE,CAC5C,IAAA,gBAAQ,EACN,YAAY,IAAI,EAAE,EAClB,yBAAyB,IAAI,EAAE,EAC/B,CAAC,EAAE,EAAE,EAAE,CAAC,WAAW,CAAC,EAAE,CAAC,EACvB,KAAK,EACL,oBAAoB,CACrB,CACF,CAAC;IACF,MAAM,OAAO,GAAG,IAAA,mBAAW,EACzB,CAAC,KAAa,EAAE,YAA8B,EAAE,EAAE;QAChD,CAAC,KAAK,IAAI,UAAU,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,8BAA8B;QAC/D,MAAM,IAAI,GAAG,IAAA,gBAAQ,EACnB,KAAK,EACL,YAAY,EAAE,QAAQ,EAAE,IAAI,EAAE,EAC9B,WAAW,EACX,KAAK,EACL,oBAAoB,EACpB,EAAE,MAAM,EAAE,IAAI,EAAE,CACjB,CAAC;QACF,WAAW,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,aAAa,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;IACnD,CAAC,EACD,CAAC,KAAK,EAAE,oBAAoB,CAAC,CAC9B,CAAC;IACF,OAAO,IAAA,qBAAa,EAClB,cAAc,CAAC,QAAQ,EACvB,EAAE,KAAK,EAAE,OAAO,EAAE,EAClB,IAAA,qBAAa,EAAC,eAAe,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,QAAQ,EAAE,EAAE,QAAQ,CAAC,CACvE,CAAC;AACJ,CAAC,CAAC;AA1CW,QAAA,IAAI,QA0Cf;AAEK,MAAM,UAAU,GAAG,GAAG,EAAE,CAAC,IAAA,WAAG,EAAC,cAAc,CAAC,CAAC;AAAvC,QAAA,UAAU,cAA6B;AAEpD,MAAM,eAAe,GAAG,IAAA,qBAAa,EAAY,SAAS,CAAC,CAAC;AAC5D,MAAM,uBAAuB,GAAG,IAAA,YAAI,EAAC,eAAe,CAAC,QAAQ,CAAC,CAAC;AAExD,MAAM,IAAI,GAAG,CAAC,EACnB,EAAE,EACF,QAAQ,EACR,QAAQ,GAKT,EAAE,EAAE;IACH,MAAM,eAAe,GAAG,IAAA,WAAG,EAAC,eAAe,CAAC,CAAC;IAC7C,IAAI,CAAC,eAAe,EAAE;QACpB,MAAM,IAAI,KAAK,CAAC,wBAAwB,CAAC,CAAC;KAC3C;IACD,MAAM,QAAQ,GAAG,IAAA,WAAG,EAAC,eAAe,CAAC,CAAC;IACtC,IAAI,CAAC,CAAC,EAAE,IAAI,QAAQ,CAAC,EAAE;QACrB,IAAI,QAAQ,EAAE;YACZ,OAAO,QAAQ,CAAC;SACjB;QACD,MAAM,IAAI,KAAK,CAAC,aAAa,GAAG,EAAE,GAAG,cAAc,GAAG,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;KACzF;IACD,OAAO,IAAA,qBAAa,EAAC,uBAAuB,EAAE,EAAE,KAAK,EAAE,QAAQ,EAAE,EAAE,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;AACnF,CAAC,CAAC;AArBW,QAAA,IAAI,QAqBf;AAEK,MAAM,QAAQ,GAAG,GAAG,EAAE,CAAC,IAAA,WAAG,EAAC,eAAe,CAAC,CAAC;AAAtC,QAAA,QAAQ,YAA8B;AAEnD;;;GAGG;AACI,MAAM,UAAU,GAAG,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAA+C,EAAE,EAAE,CAChG,IAAA,qBAAa,EAAC,eAAe,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,QAAQ,EAAE,EAAE,QAAQ,CAAC,CAAC;AAD5D,QAAA,UAAU,cACkD;AAEzE,MAAM,WAAW,GAAG,CAAC,KAAa,EAAE,EAAE;IACpC,IAAI,KAAK,KAAK,EAAE,EAAE;QAChB,OAAO,WAAW,CAAC;KACpB;IACD,IAAI,KAAK,KAAK,OAAO,EAAE;QACrB,MAAM,IAAI,KAAK,CAAC,6BAA6B,CAAC,CAAC;KAChD;IACD,IAAI,KAAK,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;QACzB,MAAM,IAAI,KAAK,CAAC,iCAAiC,CAAC,CAAC;KACpD;IACD,IAAI,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;QACvB,MAAM,IAAI,KAAK,CAAC,+BAA+B,CAAC,CAAC;KAClD;IACD,OAAO,KAAK,GAAG,MAAM,CAAC;AACxB,CAAC,CAAC","sourcesContent":["/**\n * Copyright © 2024 650 Industries.\n * Copyright © 2024 2023 Daishi Kato\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * https://github.com/dai-shi/waku/blob/32d52242c1450b5f5965860e671ff73c42da8bd0/packages/waku/src/client.ts#L1\n */\n\n//// <reference types=\"react/canary\" />\n'use client';\n\nimport * as FS from 'expo-file-system';\nimport {\n  createContext,\n  createElement,\n  memo,\n  useCallback,\n  useState,\n  startTransition,\n  // @ts-expect-error\n  use,\n} from 'react';\nimport type { ReactNode } from 'react';\nimport RSDWClient from 'react-server-dom-webpack/client';\n\nimport { MetroServerError, ReactServerError } from './errors';\nimport { fetch } from './fetch';\nimport { getDevServer } from '../../getDevServer';\n\nconst { createFromFetch, encodeReply } = RSDWClient;\n\n// NOTE: Ensured to start with `/`.\nconst RSC_PATH = '/_flight/' + process.env.EXPO_OS; // process.env.EXPO_RSC_PATH;\n\nlet BASE_PATH = `${process.env.EXPO_BASE_URL}${RSC_PATH}`;\n\nif (!BASE_PATH.startsWith('/')) {\n  BASE_PATH = '/' + BASE_PATH;\n}\n\nif (!BASE_PATH.endsWith('/')) {\n  BASE_PATH += '/';\n}\n\nif (BASE_PATH === '/') {\n  throw new Error(\n    `Invalid React Flight path \"${BASE_PATH}\". The path should not live at the project root, e.g. /_flight/. Dev server URL: ${\n      getDevServer().fullBundleUrl\n    }`\n  );\n}\n\nconst checkStatus = async (responsePromise: Promise<Response>): Promise<Response> => {\n  // TODO: Combine with metro async fetch logic.\n  const response = await responsePromise;\n  if (!response.ok) {\n    // NOTE(EvanBacon): Transform the Metro development error into a JS error that can be used by LogBox.\n    // This was tested against using a Class component in a server component.\n    if (response.status === 500) {\n      const errorText = await response.text();\n      let errorJson;\n      try {\n        errorJson = JSON.parse(errorText);\n      } catch {\n        throw new ReactServerError(errorText, response.url, response.status);\n      }\n      // TODO: This should be a dev-only error. Add handling for production equivalent.\n      throw new MetroServerError(errorJson, response.url);\n    }\n\n    let responseText;\n    try {\n      responseText = await response.text();\n    } catch {\n      throw new ReactServerError(response.statusText, response.url, response.status);\n    }\n    throw new ReactServerError(responseText, response.url, response.status);\n  }\n  console.log('[Router] Fetched', response.url, response.status);\n\n  return response;\n};\n\ntype Elements = Promise<Record<string, ReactNode>>;\n\nfunction getCached<T>(c: () => T, m: WeakMap<object, T>, k: object): T {\n  return (m.has(k) ? m : m.set(k, c())).get(k) as T;\n}\n\nconst cache1 = new WeakMap();\nconst mergeElements = (a: Elements, b: Elements | Awaited<Elements>): Elements => {\n  const getResult = async () => {\n    const nextElements = { ...(await a), ...(await b) };\n    delete nextElements._value;\n    return nextElements;\n  };\n  const cache2 = getCached(() => new WeakMap(), cache1, a);\n  return getCached(getResult, cache2, b);\n};\n\ntype SetElements = (updater: Elements | ((prev: Elements) => Elements)) => void;\ntype CacheEntry = [\n  input: string,\n  searchParamsString: string,\n  setElements: SetElements,\n  elements: Elements,\n];\n\nconst fetchCache: [CacheEntry?] = [];\n\nconst RSC_CONTENT_TYPE = 'text/x-component';\n\nexport const fetchRSC = (\n  input: string,\n  searchParamsString: string,\n  setElements: SetElements,\n  cache = fetchCache,\n  unstable_onFetchData?: (data: unknown) => void,\n  fetchOptions?: { remote: boolean }\n): Elements => {\n  // TODO: strip when \"is exporting\".\n  if (process.env.NODE_ENV === 'development') {\n    const refetchRsc = () => {\n      cache.splice(0);\n      const data = fetchRSC(input, searchParamsString, setElements, cache, unstable_onFetchData, {\n        remote: true,\n      });\n      setElements(data);\n    };\n    globalThis.__EXPO_RSC_RELOAD_LISTENERS__ ||= [];\n    const index = globalThis.__EXPO_RSC_RELOAD_LISTENERS__.indexOf(globalThis.__EXPO_REFETCH_RSC__);\n    if (index !== -1) {\n      globalThis.__EXPO_RSC_RELOAD_LISTENERS__.splice(index, 1, refetchRsc);\n    } else {\n      globalThis.__EXPO_RSC_RELOAD_LISTENERS__.push(refetchRsc);\n    }\n    globalThis.__EXPO_REFETCH_RSC__ = refetchRsc;\n  }\n\n  let entry: CacheEntry | undefined = cache[0];\n  if (entry && entry[0] === input && entry[1] === searchParamsString) {\n    entry[2] = setElements;\n    return entry[3];\n  }\n  const options = {\n    async callServer(actionId: string, args: unknown[]) {\n      console.log('[Router] Server Action invoked:', actionId);\n      const reqPath = getAdjustedRemoteFilePath(\n        BASE_PATH + encodeInput(encodeURIComponent(actionId))\n      );\n\n      let requestOpts: Pick<RequestInit, 'headers' | 'body'>;\n      if (!Array.isArray(args) || args.some((a) => a instanceof FormData)) {\n        requestOpts = {\n          headers: { accept: RSC_CONTENT_TYPE },\n          body: await encodeReply(args),\n        };\n      } else {\n        requestOpts = {\n          headers: {\n            accept: RSC_CONTENT_TYPE,\n            'content-type': 'application/json',\n          },\n          body: JSON.stringify(args),\n        };\n      }\n\n      const response = fetch(reqPath, {\n        method: 'POST',\n        // @ts-expect-error: non-standard feature for streaming.\n        duplex: 'half',\n        ...requestOpts,\n        headers: {\n          ...requestOpts.headers,\n          'expo-platform': process.env.EXPO_OS!,\n        },\n      });\n      const data = createFromFetch<Awaited<Elements>>(checkStatus(response), options);\n      const setElements = entry![2];\n      startTransition(() => {\n        // FIXME this causes rerenders even if data is empty\n        setElements((prev) => mergeElements(prev, data));\n      });\n\n      const fullRes = await data;\n      console.log('[Router] Server Action resolved:', fullRes._value);\n\n      return fullRes._value;\n    },\n  };\n  // eslint-disable-next-line no-multi-assign\n  const prefetched = ((globalThis as any).__EXPO_PREFETCHED__ ||= {});\n  const url = BASE_PATH + encodeInput(input) + (searchParamsString ? '?' + searchParamsString : '');\n  const reqPath = fetchOptions?.remote ? getAdjustedRemoteFilePath(url) : getAdjustedFilePath(url);\n  console.log('fetch', reqPath);\n  const response =\n    prefetched[url] ||\n    fetch(reqPath, {\n      headers: {\n        'expo-platform': process.env.EXPO_OS!,\n      },\n    });\n  delete prefetched[url];\n  const data = createFromFetch<Awaited<Elements>>(checkStatus(response), options);\n  unstable_onFetchData?.(data);\n\n  // eslint-disable-next-line no-multi-assign\n  cache[0] = entry = [input, searchParamsString, setElements, data];\n  return data;\n};\n\nfunction getAdjustedRemoteFilePath(path: string): string {\n  if (process.env.EXPO_OS === 'web') {\n    return path;\n  }\n\n  return new URL(path, window.location.href).toString();\n}\n\nfunction getAdjustedFilePath(path: string): string {\n  if (process.env.EXPO_OS === 'web') {\n    return path;\n  }\n\n  // Server actions should be fetched from the server every time.\n  if (path.match(/[0-9a-z]{40}#/i)) {\n    return getAdjustedRemoteFilePath(path);\n  }\n\n  if (getDevServer().bundleLoadedFromServer) {\n    return getAdjustedRemoteFilePath(path);\n  }\n\n  if (process.env.EXPO_OS === 'android') {\n    return 'file:///android_asset' + path;\n  }\n\n  return 'file://' + FS.bundleDirectory + path;\n}\n\nexport const prefetchRSC = (input: string, searchParamsString: string): void => {\n  // eslint-disable-next-line no-multi-assign\n  const prefetched = ((globalThis as any).__EXPO_PREFETCHED__ ||= {});\n  const url = getAdjustedFilePath(\n    BASE_PATH + encodeInput(input) + (searchParamsString ? '?' + searchParamsString : '')\n  );\n  if (!(url in prefetched)) {\n    prefetched[url] = fetch(url, {\n      headers: {\n        'expo-platform': process.env.EXPO_OS!,\n      },\n    });\n  }\n};\n\nconst RefetchContext = createContext<(input: string, searchParams?: URLSearchParams) => void>(\n  () => {\n    throw new Error('Missing Root component');\n  }\n);\nconst ElementsContext = createContext<Elements | null>(null);\n\nexport const Root = ({\n  initialInput,\n  initialSearchParamsString,\n  cache,\n  unstable_onFetchData,\n  children,\n}: {\n  initialInput?: string;\n  initialSearchParamsString?: string;\n  cache?: typeof fetchCache;\n  unstable_onFetchData?: (data: unknown) => void;\n  children: ReactNode;\n}) => {\n  const [elements, setElements] = useState(() =>\n    fetchRSC(\n      initialInput || '',\n      initialSearchParamsString || '',\n      (fn) => setElements(fn),\n      cache,\n      unstable_onFetchData\n    )\n  );\n  const refetch = useCallback(\n    (input: string, searchParams?: URLSearchParams) => {\n      (cache || fetchCache).splice(0); // clear cache before fetching\n      const data = fetchRSC(\n        input,\n        searchParams?.toString() || '',\n        setElements,\n        cache,\n        unstable_onFetchData,\n        { remote: true }\n      );\n      setElements((prev) => mergeElements(prev, data));\n    },\n    [cache, unstable_onFetchData]\n  );\n  return createElement(\n    RefetchContext.Provider,\n    { value: refetch },\n    createElement(ElementsContext.Provider, { value: elements }, children)\n  );\n};\n\nexport const useRefetch = () => use(RefetchContext);\n\nconst ChildrenContext = createContext<ReactNode>(undefined);\nconst ChildrenContextProvider = memo(ChildrenContext.Provider);\n\nexport const Slot = ({\n  id,\n  children,\n  fallback,\n}: {\n  id: string;\n  children?: ReactNode;\n  fallback?: ReactNode;\n}) => {\n  const elementsPromise = use(ElementsContext);\n  if (!elementsPromise) {\n    throw new Error('Missing Root component');\n  }\n  const elements = use(elementsPromise);\n  if (!(id in elements)) {\n    if (fallback) {\n      return fallback;\n    }\n    throw new Error('Not found: ' + id + '. Expected: ' + Object.keys(elements).join(', '));\n  }\n  return createElement(ChildrenContextProvider, { value: children }, elements[id]);\n};\n\nexport const Children = () => use(ChildrenContext);\n\n/**\n * ServerRoot for SSR\n * This is not a public API.\n */\nexport const ServerRoot = ({ elements, children }: { elements: Elements; children: ReactNode }) =>\n  createElement(ElementsContext.Provider, { value: elements }, children);\n\nconst encodeInput = (input: string) => {\n  if (input === '') {\n    return 'index.txt';\n  }\n  if (input === 'index') {\n    throw new Error('Input should not be `index`');\n  }\n  if (input.startsWith('/')) {\n    throw new Error('Input should not start with `/`');\n  }\n  if (input.endsWith('/')) {\n    throw new Error('Input should not end with `/`');\n  }\n  return input + '.txt';\n};\n"]}