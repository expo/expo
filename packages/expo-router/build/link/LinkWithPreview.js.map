{"version":3,"file":"LinkWithPreview.js","sourceRoot":"","sources":["../../src/link/LinkWithPreview.tsx"],"names":[],"mappings":"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","sourcesContent":["'use client';\n\nimport React, {\n  createContext,\n  isValidElement,\n  use,\n  useEffect,\n  useRef,\n  useState,\n  type PropsWithChildren,\n  type ReactElement,\n} from 'react';\n\nimport { useRouter } from '../hooks';\nimport { BaseExpoRouterLink } from './BaseExpoRouterLink';\nimport { HrefPreview } from './preview/HrefPreview';\nimport { useLinkPreviewContext } from './preview/LinkPreviewContext';\nimport {\n  NativeLinkPreview,\n  NativeLinkPreviewAction,\n  NativeLinkPreviewContent,\n  NativeLinkPreviewTrigger,\n} from './preview/native';\nimport { useNextScreenId } from './preview/useNextScreenId';\nimport { LinkProps } from './useLinkHooks';\nimport { shouldLinkExternally } from '../utils/url';\nimport { useIsPreview } from './preview/PreviewRouteContext';\nimport { Slot } from '../ui/Slot';\n\nconst InternalLinkPreviewContext = createContext<\n  { isVisible: boolean; href: LinkProps['href'] } | undefined\n>(undefined);\n\nexport function LinkWithPreview({ children, ...rest }: LinkProps) {\n  const router = useRouter();\n  const { setIsPreviewOpen } = useLinkPreviewContext();\n  const [isCurrentPreviewOpen, setIsCurrenPreviewOpen] = useState(false);\n\n  const hrefWithoutQuery = String(rest.href).split('?')[0];\n  const prevHrefWithoutQuery = useRef(hrefWithoutQuery);\n\n  useEffect(() => {\n    if (isCurrentPreviewOpen) {\n      if (prevHrefWithoutQuery.current !== hrefWithoutQuery) {\n        throw new Error(\n          'Link does not support changing the href prop after the preview has been opened. Please ensure that the href prop is stable and does not change between renders.'\n        );\n      }\n    } else {\n      prevHrefWithoutQuery.current = hrefWithoutQuery;\n    }\n  }, [hrefWithoutQuery]);\n\n  const [nextScreenId, updateNextScreenId] = useNextScreenId();\n\n  useEffect(() => {\n    if (shouldLinkExternally(String(rest.href))) {\n      if (process.env.NODE_ENV !== 'production') {\n        throw new Error('External links previews are not supported');\n      } else {\n        console.warn('External links previews are not supported');\n      }\n    }\n    if (rest.replace) {\n      if (process.env.NODE_ENV !== 'production') {\n        throw new Error('Using replace links with preview is not supported');\n      } else {\n        console.warn('Using replace links with preview is not supported');\n      }\n    }\n  }, [rest.href, rest.replace]);\n\n  const triggerElement = React.useMemo(\n    () => getFirstChildOfType(children, LinkTrigger),\n    [children]\n  );\n  const menuElement = React.useMemo(() => getFirstChildOfType(children, LinkMenu), [children]);\n  const previewElement = React.useMemo(\n    () => getFirstChildOfType(children, LinkPreview),\n    [children]\n  );\n\n  if (previewElement && !triggerElement) {\n    if (process.env.NODE_ENV !== 'production') {\n      throw new Error(\n        'When you use Link.Preview, you must use Link.Trigger to specify the trigger element.'\n      );\n    } else {\n      console.warn(\n        'When you use Link.Preview, you must use Link.Trigger to specify the trigger element.'\n      );\n    }\n  }\n\n  const trigger = React.useMemo(\n    () => triggerElement ?? <LinkTrigger>{children}</LinkTrigger>,\n    [triggerElement, children]\n  );\n\n  const actionsHandlers = React.useMemo(\n    () =>\n      convertActionsToActionsHandlers(\n        convertChildrenArrayToActions(React.Children.toArray(menuElement?.props.children))\n      ),\n    [menuElement]\n  );\n  const preview = React.useMemo(\n    () => previewElement ?? <LinkPreview />,\n    [previewElement, rest.href]\n  );\n\n  if (shouldLinkExternally(String(rest.href)) || rest.replace) {\n    return <BaseExpoRouterLink children={children} {...rest} />;\n  }\n\n  return (\n    <NativeLinkPreview\n      nextScreenId={nextScreenId}\n      onActionSelected={({ nativeEvent: { id } }) => {\n        actionsHandlers[id]?.();\n      }}\n      onWillPreviewOpen={() => {\n        router.prefetch(rest.href);\n        setIsPreviewOpen(true);\n        setIsCurrenPreviewOpen(true);\n      }}\n      onDidPreviewOpen={() => {\n        updateNextScreenId(rest.href);\n      }}\n      onPreviewDidClose={() => {\n        setIsPreviewOpen(false);\n        setIsCurrenPreviewOpen(false);\n      }}\n      onPreviewTapped={() => {\n        router.navigate(rest.href, { __internal__PreviewKey: nextScreenId });\n      }}>\n      <InternalLinkPreviewContext value={{ isVisible: isCurrentPreviewOpen, href: rest.href }}>\n        <NativeLinkPreviewTrigger>\n          <BaseExpoRouterLink {...rest} children={trigger} ref={rest.ref} />\n        </NativeLinkPreviewTrigger>\n        {preview}\n        {menuElement}\n      </InternalLinkPreviewContext>\n    </NativeLinkPreview>\n  );\n}\n\ninterface LinkMenuAction {\n  /**\n   * The title of the menu item.\n   */\n  title: string;\n  onPress: () => void;\n}\n\nexport function LinkMenuAction(_: LinkMenuAction) {\n  return null;\n}\ninterface LinkMenuProps {\n  children: ReactElement<LinkMenuAction> | ReactElement<LinkMenuAction>[];\n}\n\nexport function LinkMenu({ children }: LinkMenuProps) {\n  if (useIsPreview() || !use(InternalLinkPreviewContext)) {\n    return null;\n  }\n  return convertChildrenArrayToActions(React.Children.toArray(children)).map((action) => {\n    return <NativeLinkPreviewAction key={action.id} title={action.title} id={action.id} />;\n  });\n}\n\ninterface LinkPreviewProps {\n  /**\n   * Sets the preferred width of the preview.\n   * If not set, full width of the screen will be used.\n   *\n   * This is only **preferred** width, the actual width may be different\n   */\n  width?: number;\n\n  /**\n   * Sets the preferred height of the preview.\n   * If not set, full height of the screen will be used.\n   *\n   * This is only **preferred** height, the actual height may be different\n   */\n  height?: number;\n  children?: React.ReactNode;\n}\n\nexport function LinkPreview({ children, width, height }: LinkPreviewProps) {\n  const internalPreviewContext = use(InternalLinkPreviewContext);\n  if (useIsPreview() || !internalPreviewContext) {\n    return null;\n  }\n  const { isVisible, href } = internalPreviewContext;\n  const contentSize = {\n    width: width ?? 0,\n    height: height ?? 0,\n  };\n  let content: React.ReactNode;\n  if (children) {\n    content = isVisible ? children : null;\n  } else {\n    content = isVisible ? <HrefPreview href={href} /> : null;\n  }\n\n  return (\n    <NativeLinkPreviewContent\n      style={{\n        /* Setting default background here, so that the preview is not transparent */\n        backgroundColor: '#fff',\n      }}\n      preferredContentSize={contentSize}>\n      {content}\n    </NativeLinkPreviewContent>\n  );\n}\n\nexport function LinkTrigger(props: PropsWithChildren) {\n  if (React.Children.toArray(props.children).every((child) => !isValidElement(child))) {\n    return props.children;\n  }\n  return <Slot {...props} />;\n}\n\nfunction getFirstChildOfType<PropsT>(\n  children: React.ReactNode | React.ReactNode[],\n  type: (props: PropsT) => unknown\n) {\n  return React.Children.toArray(children).find(\n    (child): child is ReactElement<PropsT> => isValidElement(child) && child.type === type\n  );\n}\n\nfunction convertActionsToActionsHandlers(\n  items: { id: string; title: string; onPress: () => void }[] | undefined\n) {\n  return (items ?? []).reduce(\n    (acc, item) => ({\n      ...acc,\n      [item.id]: item.onPress,\n    }),\n    {} as Record<string, () => void>\n  );\n}\n\nfunction convertChildrenArrayToActions(children: ReturnType<typeof React.Children.toArray>) {\n  return children\n    .filter(\n      (item): item is ReactElement<LinkMenuAction> =>\n        isValidElement(item) && item.type === LinkMenuAction\n    )\n    .map((child, index) => ({\n      id: `${child.props.title}-${index}`,\n      title: child.props.title,\n      onPress: child.props.onPress,\n    }));\n}\n"]}