#!/usr/bin/env node

import path from 'node:path';
import { fileURLToPath } from 'node:url';

import { commandRunner } from '../utils/commandUtils.js';
import { directoryExistsAsync } from '../utils/fileUtils.js';

const dirname = path.dirname(fileURLToPath(import.meta.url));

process.env.EXPO_NONINTERACTIVE = 1;

async function runAsync() {
  console.log('Configuring module');
  await commandRunner(path.join(dirname, 'expo-module-clean'));
  await commandRunner(path.join(dirname, 'expo-module-configure'));
  await commandRunner(path.join(dirname, 'expo-module-build'));

  for (const target of ['plugin', 'cli', 'utils', 'scripts']) {
    if (await directoryExistsAsync(path.join(process.cwd(), target))) {
      console.log(`Configuring ${target}`);
      await commandRunner(path.join(dirname, 'expo-module-clean'), [target]);
      await commandRunner(path.join(dirname, 'expo-module-build'), [target]);
    }
  }
}

(async () => {
  try {
    await runAsync();
  } catch (error) {
    console.error(error);
    process.exit(error.status || error.code || 1);
  }
})();
