#!/usr/bin/env node
'use strict';

import fs from 'node:fs';
import path from 'node:path';
import { commandRunner, getArgs } from "../util/commandUtils.js";
import { fileURLToPath } from 'node:url';

export const dirname = path.dirname(fileURLToPath(import.meta.url));

const VALID_TARGETS = ["plugin", "cli", "utils", "scripts"];

let args = getArgs();

if (VALID_TARGETS.includes(args[0])) {
  const targetDir = path.join(process.cwd(), args[0]);

  if (!fs.existsSync(path.join(targetDir, 'tsconfig.json'))) {
    console.error(`tsconfig.json not found in ${targetDir}, skipping build!`)
    process.exit(0)
  }

  args = ['-p', targetDir, ...args.splice(1)];
}

if (
  process.stdout.isTTY &&
  !process.env.CI &&
  !process.env.EXPO_NONINTERACTIVE
) {
  args.push('--watch')
}

await commandRunner(path.join(dirname, 'expo-module-tsc'), args);
