#!/usr/bin/env node
'use strict';

import process from 'node:process';
import fs from 'node:fs';

import { getExtraModuleBuildTypes, isInteractiveSession } from './expo-module-utils.js';
import { expoModuleTsc } from './expo-module-tsc';

function hasTypeScriptConfig(buildType) {
  const tsconfigPath = `../${buildType}/tsconfig.json`;
  return fs.existsSync(tsconfigPath);
}

export function expoModuleBuild(args) {
  const maybeBuildType = args[1];
  let tscArgs = [...args];

  if (getExtraModuleBuildTypes().includes(maybeBuildType)) {
    if (!hasTypeScriptConfig(maybeBuildType)) {
      console.log(`tsconfig.json not found in ${args}, skipping build for ${args}/`);
      process.exit(1)
    }

    tscArgs = ['--build', `../${maybeBuildType}`, ...(args.slice(2))]
  }

  if (isInteractiveSession()) {
    tscArgs.push('--watch');
  }

  expoModuleTsc(tscArgs)
}

if (import.meta.main) {
  expoModuleBuild()
}