#!/usr/bin/env node

import process from 'node:process';
import fs from 'node:fs';
import path from 'node:path';

const OPTIONAL_TEMPLATE_FILES = [
  'eslint.config.js',
  'scripts/with-node.sh'
];

function getTemplateFiles() {
  const files = fs.readdirSync(`${__dirname}/../templates/`, { recursive: true, withFileTypes: true });

  return files
    .filter(f => f.isFile)
    .map(f => path.join(f.parentPath, f.name));
}

function isGeneratedFile(file) {
  const contents = fs.readFileSync(file, { encoding: 'utf8 '});
  return contents.includes('@generated');
}

function syncFileIfMissing(templateFile, targetFile) {
  if (!fs.existsSync(targetFile) || isGeneratedFile(targetFile)) {
    fs.copyFileSync(templateFile, targetFile);
  }
}

function syncFileIfPresent(templateFile, targetFile) {
  if (fs.existsSync(targetFile) && isGeneratedFile(targetFile)) {
    fs.copyFileSync(templateFile, targetFile);
  }
}

export function expoModuleConfigure() {
  npx([`${__dirname}/expo-module-readme`]);

  const templateFiles = getTemplateFiles();

  for (const templateFile of templateFiles) {
    const templateSource = `${__dirname}/../templates/${templateFile}`;

    if (OPTIONAL_TEMPLATE_FILES.includes(templateFile)) {
      syncFileIfPresent(templateSource, templateFile);
    } else {
      syncFileIfMissing(templateSource, templateFile);
    }
  }
}

if (import.meta.main) {
  expoModuleConfigure(process.argv)
}