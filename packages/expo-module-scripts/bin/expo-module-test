#!/usr/bin/env node

import fs from 'node:fs';
import { createRequire } from 'node:module';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

import { commandRunner, getArgs, addWatchFlagIfNeeded } from '../utils/commandUtils.js';

const dirname = path.dirname(fileURLToPath(import.meta.url));
const require = createRequire(import.meta.url);

const EXTRA_MODULE_BUILD_TARGETS = ['plugin', 'cli', 'utils', 'scripts'];

let args = getArgs();

// If the command is used like `yarn test plugin`, set the --rootDir option to the `plugin` directory
if (EXTRA_MODULE_BUILD_TARGETS.includes(args[0])) {
  const target = args[0];
  const targetDir = path.join(process.cwd(), target);
  const restArgs = args.slice(1);
  args = ['--rootDir', target];

  if (fs.existsSync(path.join(targetDir, 'jest.config.js'))) {
    args.push('--config', `${target}/jest.config.js`);
  } else {
    const jestConfigPath = require.resolve(`expo-module-scripts/jest-preset-${target}.js`);
    args.push('--config', jestConfigPath);
  }
  // Push the rest of the arguments minus the `plugin` arg
  args.push(...restArgs);
}

args = addWatchFlagIfNeeded(args);

await commandRunner(path.join(dirname, 'expo-module-jest'), args);
