{"version":3,"file":"createExampleApp.js","sourceRoot":"","sources":["../src/createExampleApp.ts"],"names":[],"mappings":"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","sourcesContent":["import spawnAsync from '@expo/spawn-async';\nimport fs from 'fs';\nimport getenv from 'getenv';\nimport os from 'os';\nimport path from 'path';\n\nimport { installDependencies } from './packageManager';\nimport { PackageManagerName } from './resolvePackageManager';\nimport { SubstitutionData } from './types';\nimport { newStep } from './utils/ora';\n\nconst debug = require('debug')('create-expo-module:createExampleApp') as typeof console.log;\n\n// These dependencies will be removed from the example app (`expo init` adds them)\nconst DEPENDENCIES_TO_REMOVE = ['expo-status-bar', 'expo-splash-screen'];\nconst EXPO_BETA = getenv.boolish('EXPO_BETA', false);\n\n/**\n * Initializes a new Expo project as an example app.\n */\nexport async function createExampleApp(\n  data: SubstitutionData,\n  targetDir: string,\n  packageManager: PackageManagerName\n): Promise<void> {\n  // Package name for the example app\n  const exampleProjectSlug = `${data.project.slug}-example`;\n\n  // `expo init` creates a new folder with the same name as the project slug\n  const appTmpPath = path.join(targetDir, exampleProjectSlug);\n\n  // Path to the target example dir\n  const appTargetPath = path.join(targetDir, 'example');\n\n  if (!fs.existsSync(appTargetPath)) {\n    // The template doesn't include the example app, so just skip this phase\n    return;\n  }\n\n  await newStep('Initializing the example app', async (step) => {\n    const templateVersion = EXPO_BETA ? 'next' : 'latest';\n    const template = `expo-template-blank-typescript@${templateVersion}`;\n    debug(`Using example template: ${template}`);\n    const command = createCommand(packageManager, exampleProjectSlug, template);\n    try {\n      await spawnAsync(packageManager, command, {\n        cwd: targetDir,\n      });\n    } catch (error: any) {\n      throw new Error(\n        `${command.join(' ')} failed with exit code: ${error?.status}.\\n\\nError stack:\\n${error?.stderr}`\n      );\n    }\n\n    step.succeed('Initialized the example app');\n  });\n\n  await newStep('Configuring the example app', async (step) => {\n    // \"example\" folder already exists and contains template files,\n    // that should replace these created by `expo init`.\n    await moveFiles(appTargetPath, appTmpPath);\n\n    // Cleanup the \"example\" dir\n    await fs.promises.rm(appTargetPath, { recursive: true, force: true });\n\n    // Clean up the \".git\" from example app\n    // note, this directory has contents, rmdir will throw\n    await fs.promises.rm(path.join(appTmpPath, '.git'), { recursive: true, force: true });\n\n    // Move the temporary example app to \"example\" dir\n    await fs.promises.rename(appTmpPath, appTargetPath);\n\n    await addMissingAppConfigFields(appTargetPath, data);\n\n    step.succeed('Configured the example app');\n  });\n\n  await prebuildExampleApp(appTargetPath);\n\n  await modifyPackageJson(appTargetPath);\n\n  await newStep('Installing dependencies in the example app', async (step) => {\n    await installDependencies(packageManager, appTargetPath);\n    if (os.platform() === 'darwin') {\n      await podInstall(appTargetPath);\n      step.succeed('Installed dependencies in the example app');\n    } else {\n      step.succeed('Installed dependencies in the example app (skipped installing CocoaPods)');\n    }\n  });\n}\n\nfunction createCommand(\n  packageManager: PackageManagerName,\n  exampleProjectSlug: string,\n  template: string\n): string[] {\n  const command = ['create', 'expo-app'];\n  if (packageManager === 'npm') {\n    command.push('--');\n  }\n  return command.concat([exampleProjectSlug, '--template', template, '--yes']);\n}\n\n/**\n * Moves files from one directory to another.\n */\nasync function moveFiles(fromPath: string, toPath: string): Promise<void> {\n  // Make sure that the target directory exists\n  await fs.promises.mkdir(toPath, { recursive: true });\n  for (const file of await fs.promises.readdir(fromPath)) {\n    // First, remove target, so there are no conflicts (explicit overwrite)\n    await fs.promises.rm(path.join(toPath, file), { force: true, recursive: true });\n    try {\n      // Then, rename the file to move it to the destination\n      await fs.promises.rename(path.join(fromPath, file), path.join(toPath, file));\n    } catch (error: any) {\n      if (error.code === 'EXDEV') {\n        // If the file is on a different device/disk, copy it instead and delete the original\n        await fs.promises.cp(fromPath, toPath, { errorOnExist: true, recursive: true });\n        await fs.promises.rm(fromPath, { recursive: true, force: true });\n      } else {\n        throw error;\n      }\n    }\n  }\n}\n\n/**\n * Adds missing configuration that are required to run `npx expo prebuild`.\n */\nasync function addMissingAppConfigFields(appPath: string, data: SubstitutionData): Promise<void> {\n  const appConfigPath = path.join(appPath, 'app.json');\n  const appConfigContent = await fs.promises.readFile(appConfigPath, 'utf8');\n  const appConfig = JSON.parse(appConfigContent);\n  const appId = `${data.project.package}.example`;\n\n  // Android package name needs to be added to app.json\n  if (!appConfig.expo.android) {\n    appConfig.expo.android = {};\n  }\n  appConfig.expo.android.package = appId;\n\n  // Specify iOS bundle identifier\n  if (!appConfig.expo.ios) {\n    appConfig.expo.ios = {};\n  }\n  appConfig.expo.ios.bundleIdentifier = appId;\n\n  await fs.promises.writeFile(appConfigPath, JSON.stringify(appConfig, null, 2), 'utf8');\n}\n\n/**\n * Applies necessary changes to **package.json** of the example app.\n * It means setting the autolinking config and removing unnecessary dependencies.\n */\nasync function modifyPackageJson(appPath: string): Promise<void> {\n  const packageJsonPath = path.join(appPath, 'package.json');\n  const packageJsonContent = await fs.promises.readFile(packageJsonPath, 'utf8');\n  const packageJson = JSON.parse(packageJsonContent);\n\n  if (!packageJson.expo) {\n    packageJson.expo = {};\n  }\n\n  // Set the native modules dir to the root folder,\n  // so that the autolinking can detect and link the module.\n  packageJson.expo.autolinking = {\n    nativeModulesDir: '..',\n  };\n\n  // Remove unnecessary dependencies\n  for (const dependencyToRemove of DEPENDENCIES_TO_REMOVE) {\n    delete packageJson.dependencies[dependencyToRemove];\n  }\n\n  await fs.promises.writeFile(packageJsonPath, JSON.stringify(packageJson, null, 2), 'utf8');\n}\n\n/**\n * Runs `npx expo prebuild` in the example app.\n */\nasync function prebuildExampleApp(exampleAppPath: string): Promise<void> {\n  await newStep('Prebuilding the example app', async (step) => {\n    await spawnAsync('npx', ['expo', 'prebuild', '--no-install'], {\n      cwd: exampleAppPath,\n      stdio: ['ignore', 'ignore', 'pipe'],\n    });\n    step.succeed('Prebuilt the example app');\n  });\n}\n\n/**\n * Runs `pod install` in the iOS project at the given path.\n */\nasync function podInstall(appPath: string): Promise<void> {\n  await spawnAsync('pod', ['install'], {\n    cwd: path.join(appPath, 'ios'),\n    stdio: ['ignore', 'ignore', 'pipe'],\n  });\n}\n"]}