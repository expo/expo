{"version":3,"file":"ExponentFacebook.web.js","sourceRoot":"","sources":["../src/ExponentFacebook.web.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,UAAU,EAAE,MAAM,kBAAkB,CAAC;AAY9C,MAAM,SAAS,GAAG,sCAAsC,CAAC;AAEzD,IAAI,mBAA+C,CAAC;AAEpD,IAAI,gBAAgB,GAAY,IAAI,CAAC;AACrC,IAAI,SAAiB,CAAC;AAEtB,iBAAiB;AAEjB,SAAS,mBAAmB;IAC1B,OAAO,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,MAAM,CAAC,EAAE,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC,CAAC;AACnE,CAAC;AACD,SAAS,WAAW;IAClB,OAAO,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC;AAC3D,CAAC;AACD,SAAS,UAAU,CAAC,OAAyB;IAC3C,OAAO,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC,CAAC;AACnE,CAAC;AAED,SAAS;AAET,SAAS,oBAAoB;IAC3B,IAAI,CAAC,MAAM,IAAI,CAAC,MAAM,CAAC,EAAE;QACvB,MAAM,IAAI,UAAU,CAClB,aAAa,EACb,kHAAkH,CACnH,CAAC;AACN,CAAC;AAED,SAAS,gBAAgB,CAAC,EACxB,MAAM,GAAG,sBAAsB,EAC/B,QAAQ,GAAG,OAAO,EAClB,4BAA4B,GAAG,KAAK,EACpC,cAAc,GAAG,KAAK,GACF;IACpB,MAAM,SAAS,GAAG,WAAW,MAAM,IAAI,QAAQ,OAC7C,4BAA4B,CAAC,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,EACzD,GAAG,cAAc,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC;IAEvC,MAAM,aAAa,GAAG,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;IACvD,aAAa,CAAC,KAAK,GAAG,IAAI,CAAC;IAC3B,aAAa,CAAC,KAAK,GAAG,IAAI,CAAC;IAC3B,aAAa,CAAC,EAAE,GAAG,SAAS,CAAC;IAC7B,aAAa,CAAC,GAAG,GAAG,SAAS,CAAC;IAC9B,OAAO,aAAa,CAAC;AACvB,CAAC;AAED,SAAS,yBAAyB,CAAC,WAA+B;IAChE,IAAI,CAAC,WAAW;QAAE,OAAO,EAAE,CAAC;IAE5B,IAAI,KAAK,CAAC,OAAO,CAAC,WAAW,CAAC,EAAE;QAC9B,OAAO,WAAW,CAAC;KACpB;IACD,OAAO,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;AAChC,CAAC;AAED,eAAe;IACb,IAAI,IAAI;QACN,OAAO,kBAAkB,CAAC;IAC5B,CAAC;IACD,KAAK,CAAC,eAAe,CAAC,EACpB,KAAK,EACL,OAAO,GAAG,MAAM,EAChB,KAAK,GAAG,IAAI,EACZ,GAAG,OAAO,EACE;QACZ,IAAI,CAAC,KAAK,EAAE;YACV,MAAM,IAAI,UAAU,CAClB,aAAa,EACb,6DAA6D,CAC9D,CAAC;SACH;QACD,IAAI,mBAAmB,EAAE;YACvB,OAAO,mBAAmB,CAAC;SAC5B;QAED,mBAAmB,GAAG,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE;YAC1C,SAAS,GAAG,KAAK,CAAC;YAClB,+FAA+F;YAC/F,6HAA6H;YAC7H,+FAA+F;YAC/F,MAAM,CAAC,WAAW,GAAG,GAAG,EAAE;gBACxB,yEAAyE;gBACzE,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC;oBACb,KAAK;oBACL,gBAAgB,EACd,OAAO,CAAC,gBAAgB,KAAK,SAAS,CAAC,CAAC,CAAC,gBAAgB,CAAC,CAAC,CAAC,OAAO,CAAC,gBAAgB;oBACtF,KAAK;oBACL,OAAO;iBACR,CAAC,CAAC;gBAEH,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;YACrB,CAAC,CAAC;YAEF,oEAAoE;YACpE,MAAM,OAAO,GAAG,QAAQ,CAAC,cAAc,CAAC,SAAS,CAAC,CAAC;YACnD,IAAI,OAAO,EAAE;gBACX,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;aACpB;YAED,QAAQ,CAAC,IAAI,CAAC,WAAW,CACvB,gBAAgB,CAAC;gBACf,MAAM,EAAE,OAAO,CAAC,MAAM;gBACtB,QAAQ,EAAE,OAAO,CAAC,QAAQ;gBAC1B,cAAc,EAAE,OAAO,CAAC,cAAc;gBACtC,4BAA4B,EAAE,OAAO,CAAC,4BAA4B;aACnE,CAAC,CACH,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,OAAO,mBAAmB,CAAC;IAC7B,CAAC;IACD;;;;OAIG;IACH,KAAK,CAAC,6BAA6B,CAAC,OAAwB;QAC1D,oBAAoB,EAAE,CAAC;QAEvB,MAAM,EAAE,WAAW,GAAG,CAAC,gBAAgB,EAAE,OAAO,CAAC,EAAE,GAAG,OAAO,CAAC;QAE9D,MAAM,YAAY,GAAoB;YACpC,KAAK,EAAE,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC;YAC5B,aAAa,EAAE,IAAI;SACpB,CAAC;QAEF,MAAM,QAAQ,GAAG,MAAM,UAAU,CAAC,YAAY,CAAC,CAAC;QAEhD,IAAI,QAAQ,CAAC,YAAY,EAAE;YACzB,MAAM,YAAY,GAAG,QAAQ,CAAC,YAG7B,CAAC;YAEF,OAAO;gBACL,IAAI,EAAE,SAAS;gBACf,KAAK,EAAE,SAAS;gBAChB,OAAO,EAAE,YAAY,CAAC,SAAS;gBAC/B,KAAK,EAAE,YAAY,CAAC,WAAW;gBAC/B,MAAM,EAAE,YAAY,CAAC,MAAM;gBAC3B,aAAa,EAAE,YAAY,CAAC,aAAa;gBACzC,WAAW,EAAE,YAAY,CAAC,WAAW;gBACrC,iBAAiB,EAAE,YAAY,CAAC,2BAA2B;gBAC3D,WAAW,EAAE,yBAAyB,CAAC,YAAY,CAAC,aAAa,CAAC;aACnE,CAAC;SACH;QAED,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,CAAC;IAC5B,CAAC;IAED,KAAK,CAAC,mBAAmB;QACvB,oBAAoB,EAAE,CAAC;QAEvB,MAAM,QAAQ,GAAG,MAAM,mBAAmB,EAAE,CAAC;QAC7C,IAAI,CAAC,QAAQ,CAAC,YAAY,EAAE;YAC1B,OAAO,IAAI,CAAC;SACb;QAED,MAAM,YAAY,GAAG,QAAQ,CAAC,YAG7B,CAAC;QAEF,OAAO;YACL,KAAK,EAAE,SAAS;YAChB,kEAAkE;YAClE,OAAO,EAAE,YAAY,CAAC,SAAS;YAC/B,KAAK,EAAE,YAAY,CAAC,WAAW;YAC/B,MAAM,EAAE,YAAY,CAAC,MAAM;YAC3B,aAAa,EAAE,YAAY,CAAC,aAAa;YACzC,WAAW,EAAE,YAAY,CAAC,WAAW;YACrC,iBAAiB,EAAE,YAAY,CAAC,2BAA2B;YAC3D,WAAW,EAAE,yBAAyB,CAAC,YAAY,CAAC,aAAa,CAAC;SACnE,CAAC;IACJ,CAAC;IACD,KAAK,CAAC,WAAW;QACf,oBAAoB,EAAE,CAAC;QAEvB,2EAA2E;QAC3E,iGAAiG;QACjG,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,mBAAmB,EAAE,CAAC;QAC9C,IAAI,CAAC,IAAI;YAAE,OAAO;QAElB,MAAM,WAAW,EAAE,CAAC;IACtB,CAAC;IACD,+BAA+B,CAAC,OAAgB;QAC9C,gBAAgB,GAAG,OAAO,CAAC;IAC7B,CAAC;CACF,CAAC","sourcesContent":["import { CodedError } from '@unimodules/core';\n\nimport { FacebookAuth } from './Facebook';\nimport {\n  FacebookLoginResult,\n  FacebookOptions,\n  InitOptions,\n  SDKScriptURLOptions,\n} from './Facebook.types';\n\ndeclare var window: Window & { FB: fb.FacebookStatic; fbAsyncInit?: () => void };\n\nconst SCRIPT_ID = 'expo-facebook-generated-fbsdk-script';\n\nlet loadingFBSDKPromise: Promise<fb.FacebookStatic>;\n\nlet autoLogAppEvents: boolean = true;\nlet lastAppId: string;\n\n// FBSDK promises\n\nfunction getLoginStatusAsync(): Promise<fb.StatusResponse> {\n  return new Promise(resolve => window.FB.getLoginStatus(resolve));\n}\nfunction logoutAsync(): Promise<fb.StatusResponse> {\n  return new Promise(resolve => window.FB.logout(resolve));\n}\nfunction loginAsync(options?: fb.LoginOptions): Promise<fb.StatusResponse> {\n  return new Promise(resolve => window.FB.login(resolve, options));\n}\n\n// Helper\n\nfunction throwIfUninitialized() {\n  if (!window || !window.FB)\n    throw new CodedError(\n      'ERR_FB_INIT',\n      'FBSDK is not initialized. Ensure `initializeAsync` has successfully resolved before attempting to use the FBSDK.'\n    );\n}\n\nfunction getScriptElement({\n  domain = 'connect.facebook.net',\n  language = 'en_US',\n  isCustomerSupportChatEnabled = false,\n  isDebugEnabled = false,\n}: SDKScriptURLOptions): HTMLScriptElement {\n  const scriptUrl = `https://${domain}/${language}/sdk${\n    isCustomerSupportChatEnabled ? '/xfbml.customerchat' : ''\n  }${isDebugEnabled ? '/debug' : ''}.js`;\n\n  const scriptElement = document.createElement('script');\n  scriptElement.async = true;\n  scriptElement.defer = true;\n  scriptElement.id = SCRIPT_ID;\n  scriptElement.src = scriptUrl;\n  return scriptElement;\n}\n\nfunction ensurePermissionsAreArray(permissions?: string | string[]): string[] {\n  if (!permissions) return [];\n\n  if (Array.isArray(permissions)) {\n    return permissions;\n  }\n  return permissions.split(',');\n}\n\nexport default {\n  get name(): string {\n    return 'ExponentFacebook';\n  },\n  async initializeAsync({\n    appId,\n    version = 'v5.0',\n    xfbml = true,\n    ...options\n  }: InitOptions): Promise<fb.FacebookStatic> {\n    if (!appId) {\n      throw new CodedError(\n        'ERR_FB_CONF',\n        `Failed to initialize app because the appId wasn't provided.`\n      );\n    }\n    if (loadingFBSDKPromise) {\n      return loadingFBSDKPromise;\n    }\n\n    loadingFBSDKPromise = new Promise(resolve => {\n      lastAppId = appId;\n      // The function assigned to window.fbAsyncInit is run as soon as the SDK has completed loading.\n      // Any code that you want to run after the SDK is loaded should be placed within this function and after the call to FB.init.\n      // Any kind of JavaScript can be used here, but any SDK functions must be called after FB.init.\n      window.fbAsyncInit = () => {\n        // https://developers.facebook.com/docs/javascript/reference/FB.init/v5.0\n        window.FB.init({\n          appId,\n          autoLogAppEvents:\n            options.autoLogAppEvents === undefined ? autoLogAppEvents : options.autoLogAppEvents,\n          xfbml,\n          version,\n        });\n\n        resolve(window.FB);\n      };\n\n      // If the script tag exists then resolve without creating a new one.\n      const element = document.getElementById(SCRIPT_ID);\n      if (element) {\n        resolve(window.FB);\n      }\n\n      document.body.appendChild(\n        getScriptElement({\n          domain: options.domain,\n          language: options.language,\n          isDebugEnabled: options.isDebugEnabled,\n          isCustomerSupportChatEnabled: options.isCustomerSupportChatEnabled,\n        })\n      );\n    });\n\n    return loadingFBSDKPromise;\n  },\n  /**\n   * https://developers.facebook.com/docs/reference/javascript/FB.login/v5.0\n   *\n   * @param options\n   */\n  async logInWithReadPermissionsAsync(options: FacebookOptions): Promise<FacebookLoginResult> {\n    throwIfUninitialized();\n\n    const { permissions = ['public_profile', 'email'] } = options;\n\n    const loginOptions: fb.LoginOptions = {\n      scope: permissions.join(','),\n      return_scopes: true,\n    };\n\n    const response = await loginAsync(loginOptions);\n\n    if (response.authResponse) {\n      const authResponse = response.authResponse as fb.AuthResponse & {\n        graphDomain: string;\n        data_access_expiration_time: number;\n      };\n\n      return {\n        type: 'success',\n        appID: lastAppId,\n        expires: authResponse.expiresIn,\n        token: authResponse.accessToken,\n        userID: authResponse.userID,\n        signedRequest: authResponse.signedRequest,\n        graphDomain: authResponse.graphDomain,\n        dataAccessExpires: authResponse.data_access_expiration_time,\n        permissions: ensurePermissionsAreArray(authResponse.grantedScopes),\n      };\n    }\n\n    return { type: 'cancel' };\n  },\n\n  async getAccessTokenAsync(): Promise<FacebookAuth | null> {\n    throwIfUninitialized();\n\n    const response = await getLoginStatusAsync();\n    if (!response.authResponse) {\n      return null;\n    }\n\n    const authResponse = response.authResponse as fb.AuthResponse & {\n      graphDomain: string;\n      data_access_expiration_time: number;\n    };\n\n    return {\n      appID: lastAppId,\n      // TODO: Bacon: Ensure expiresIn is returned in the correct format\n      expires: authResponse.expiresIn,\n      token: authResponse.accessToken,\n      userID: authResponse.userID,\n      signedRequest: authResponse.signedRequest,\n      graphDomain: authResponse.graphDomain,\n      dataAccessExpires: authResponse.data_access_expiration_time,\n      permissions: ensurePermissionsAreArray(authResponse.grantedScopes),\n    };\n  },\n  async logOutAsync(): Promise<void> {\n    throwIfUninitialized();\n\n    // Check if the user is already authenticated before attempting to log out.\n    // This will prevent the FBSDK from throwing a cryptic error message about not providing a token.\n    const auth = await this.getAccessTokenAsync();\n    if (!auth) return;\n\n    await logoutAsync();\n  },\n  setAutoLogAppEventsEnabledAsync(enabled: boolean) {\n    autoLogAppEvents = enabled;\n  },\n};\n"]}