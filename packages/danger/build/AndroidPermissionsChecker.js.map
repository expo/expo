{"version":3,"file":"AndroidPermissionsChecker.js","sourceRoot":"","sources":["../src/AndroidPermissionsChecker.ts"],"names":[],"mappings":";;;AAAA,mCAA8B;AAE9B,MAAM,wBAAwB,GAAG,IAAI,MAAM,CACzC,uDAAuD,EACvD,GAAG,CACJ,CAAC;AAEF;;;;;;GAMG;AACI,KAAK,UAAU,uBAAuB;IAC3C,MAAM,SAAS,GAAG,mBAAmB,EAAE,CAAC;IACxC,IAAI,SAAS,CAAC,MAAM,KAAK,CAAC,EAAE;QAC1B,OAAO,CAAC,GAAG,CAAC,qBAAqB,CAAC,CAAC;QACnC,OAAO;KACR;IAED,MAAM,OAAO,GAAG,MAAM,OAAO,CAAC,GAAG,CAC/B,SAAS,CAAC,GAAG,CAAC,KAAK,EAAC,QAAQ,EAAC,EAAE,CAAC,CAAC;QAC/B,QAAQ;QACR,WAAW,EAAE,MAAM,2BAA2B,CAAC,QAAQ,CAAC;KACzD,CAAC,CAAC,CACJ,CAAC;IAEF,YAAY,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;AACxE,CAAC;AAfD,0DAeC;AAED;;;GAGG;AACH,SAAS,mBAAmB;IAC1B,MAAM,YAAY,GAAG,CAAC,GAAG,MAAM,CAAC,GAAG,CAAC,cAAc,EAAE,GAAG,MAAM,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;IACjF,OAAO,aAAI,CACT,YAAY,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,IAAI,IAAI,CAAC,QAAQ,CAAC,qBAAqB,CAAC,CAAC,CACjG,CAAC;AACJ,CAAC;AAED;;GAEG;AACH,KAAK,UAAU,2BAA2B,CAAC,QAAgB;IACzD,MAAM,MAAM,GAAG,MAAM,MAAM,CAAC,GAAG,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;IACtD,IAAI,CAAC,MAAM,EAAE;QACX,OAAO,EAAE,CAAC;KACX;IAED,OAAO,MAAM,CAAC,IAAI;SACf,KAAK,CAAC,IAAI,CAAC;SACX,GAAG,CAAC,IAAI,CAAC,EAAE,eAAC,OAAA,aAAA,IAAI,CAAC,KAAK,CAAC,wBAAwB,CAAC,0CAAG,CAAC,2CAAG,IAAI,OAAM,EAAE,CAAA,EAAA,CAAC;SACpE,MAAM,CAAC,OAAO,CAAC,CAAC;AACrB,CAAC;AAED;;GAEG;AACH,SAAS,YAAY,CAAC,OAAsD;IAC1E,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE;QACxB,OAAO;KACR;IAED,MAAM,IAAI,GAAG,OAAO,CAAC,GAAG,CACtB,MAAM,CAAC,EAAE,CACP,SAAS,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,KAAK,CAAC;EACpE,MAAM,CAAC,WAAW,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,CAAC,SAAS,UAAU,IAAI,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CACzE,CAAC;IAEF,IAAI,CACF;;EAEF,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC;CAC1B,CACE,CAAC;IAEF,QAAQ,CACN;;;;;;;;;;;;CAYH,CAAC,IAAI,EAAE,CACL,CAAC;AACJ,CAAC","sourcesContent":["import { uniq } from 'lodash';\n\nconst TOUCHED_PERMISSION_REGEX = new RegExp(\n  /\\+\\s+<uses-permission*.+android:name=\"([a-zA-Z._-]+)\"/,\n  'i'\n);\n\n/**\n * This function checks if the Android Permissions was modified, using the following steps:\n * - Check if there was a change made in the `AndroidManifest.xml`.\n * - Check if a new `use-permissions` tag was added.\n * - Warn about also adding new permissions to the XDL blacklist.\n * - _Never_ fail CI, but add a warning to the PR as a reminder.\n */\nexport async function checkAndroidPermissions(): Promise<void> {\n  const manifests = getTouchedManifests();\n  if (manifests.length === 0) {\n    console.log('Everything is ok üéâ');\n    return;\n  }\n\n  const results = await Promise.all(\n    manifests.map(async manifest => ({\n      manifest,\n      permissions: await getAddedManifestPermissions(manifest),\n    }))\n  );\n\n  outputResult(results.filter(result => result.permissions.length > 0));\n}\n\n/**\n * Get a list of modified or created Android manifests, from danger's git.\n * This only returns `AndroidManifest.xml` files within the `packages/` folder.\n */\nfunction getTouchedManifests(): string[] {\n  const touchedFiles = [...danger.git.modified_files, ...danger.git.created_files];\n  return uniq(\n    touchedFiles.filter(file => file.startsWith('packages') && file.endsWith('AndroidManifest.xml'))\n  );\n}\n\n/**\n * Determine if the Android manifest file has an added `use-permission` tag.\n */\nasync function getAddedManifestPermissions(filePath: string): Promise<string[]> {\n  const result = await danger.git.diffForFile(filePath);\n  if (!result) {\n    return [];\n  }\n\n  return result.diff\n    .split('\\n')\n    .map(line => line.match(TOUCHED_PERMISSION_REGEX)?.[1]?.trim() || '')\n    .filter(Boolean);\n}\n\n/**\n * Generate a report and output a message warning for the added permissions in the Android manifest.\n */\nfunction outputResult(results: { manifest: string; permissions: string[] }[]): void {\n  if (results.length === 0) {\n    return;\n  }\n\n  const info = results.map(\n    result =>\n      `<code>${danger.github.utils.fileLinks([result.manifest], false)}</code>\n${result.permissions.map(permission => `\\\\- \\`${permission}\\``).join('\\n')}`\n  );\n\n  warn(\n    `**Manifests with new permissions**\n------\n${info.join('<br /><br />')}\n`\n  );\n\n  markdown(\n    `### ‚ö†Ô∏è  Android permissions added\nPlease make sure these permissions are absolutely required for the core functionality of the modules. All permissions added in the Android Manifests are included, by default, in the standalone builds.\n\n<details>\n  <summary>What can I do?</summary>\n\n  - Reconsider if the permission is required, and remove it from the \\`AndroidManifest.xml\\`.\n  _or_\n  - Keep it in when you are confident it's required for the primary functionality of the API, and add it to [the XDL schema](https://github.com/expo/universe/blob/5c84d1b6e82ba3eca483170be72deee49d29d916/server/www/xdl-schemas/UNVERSIONED-schema.json#L686).\n    - Make sure to add the permission to the [XDL blacklist](https://github.com/expo/expo-cli/blob/d75089b2e9f11b36f936967313d847fcc45f4e76/packages/xdl/src/detach/AndroidShellApp.js#L780) to allow users to opt-out of the permissions, by excluding it from the \\`android.permissions\\` manifest property.\n    - Also double-check if the permission needs to be added to the [bare template](https://github.com/expo/expo/tree/master/templates) Android manifests.\n</details>\n`.trim()\n  );\n}\n"]}