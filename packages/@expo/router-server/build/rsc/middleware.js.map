{"version":3,"file":"middleware.js","sourceRoot":"","sources":["../../src/rsc/middleware.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Copyright Â© 2024 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n */\n// This module is bundled with Metro in web/react-server mode and redirects to platform specific renderers.\nimport Constants from 'expo-constants';\nimport type { RenderRscArgs } from 'expo-server/private';\nimport path from 'node:path';\n\nimport { renderRsc } from './rsc-renderer';\nimport { createDebug } from '../utils/debug';\n\n/** Convert Windows paths to POSIX format for consistent path operations. */\nfunction toPosixPath(filePath: string): string {\n  return filePath.replace(/\\\\/g, '/');\n}\n\ndeclare const $$require_external: typeof require;\n\nconst debug = createDebug('expo:router:server:rsc-renderer');\n\n// Tracking the implementation in expo/cli's MetroBundlerDevServer\nconst rscRenderContext = new Map<string, any>();\n\nfunction serverRequire<T = any>(...targetOutputModulePath: string[]): T {\n  // NOTE(@kitten): This `__dirname` will be located in the output file system, e.g. `dist/server/*`\n  const filePath = path.join(__dirname, ...targetOutputModulePath);\n  return $$require_external(filePath);\n}\n\nfunction getRscRenderContext(platform: string) {\n  // NOTE(EvanBacon): We memoize this now that there's a persistent server storage cache for Server Actions.\n  if (rscRenderContext.has(platform)) {\n    return rscRenderContext.get(platform)!;\n  }\n\n  const context = {};\n\n  rscRenderContext.set(platform, context);\n  return context;\n}\n\nfunction getServerActionManifest(\n  _distFolder: string,\n  platform: string\n): Record<\n  // Input ID\n  string,\n  [\n    // Metro ID\n    string,\n    // Chunk location.\n    string,\n  ]\n> {\n  const filePath = `../../rsc/${platform}/action-manifest.js`;\n  return serverRequire(filePath);\n}\n\ntype ManifestType = Record<\n  // Input ID\n  string,\n  [\n    // Metro ID\n    string,\n    // Chunk location.\n    string | null,\n  ]\n>;\n\nfunction getSSRManifest(_distFolder: string, platform: string): ManifestType {\n  const filePath = `../../rsc/${platform}/ssr-manifest.js`;\n  return serverRequire(filePath);\n}\n\n/**\n * Convert an absolute file path to a manifest key.\n *\n * Manifest keys can be:\n * - node_modules paths: \"react-native-web/dist/exports/View/index.js\"\n * - relative paths: \"./__e2e__/01-rsc/components/counter.tsx\"\n * - package paths: \"./../../packages/expo-router/build/rsc/router/client.js\"\n *\n * Bundle paths are relative to projectRoot (app directory), while manifest paths\n * are relative to serverRoot (monorepo root). This function handles the mapping.\n */\nfunction resolveManifestKey(filePath: string, manifest: ManifestType): string | null {\n  // Normalize to POSIX for consistent path operations across platforms (Windows uses backslashes)\n  const posixFilePath = toPosixPath(filePath);\n\n  // Fast path: already a manifest key\n  if (posixFilePath in manifest) {\n    return posixFilePath;\n  }\n\n  // node_modules files: extract path after last /node_modules/\n  if (posixFilePath.includes('/node_modules/')) {\n    const idx = posixFilePath.lastIndexOf('/node_modules/');\n    const nodeModulesPath = posixFilePath.slice(idx + '/node_modules/'.length);\n    if (nodeModulesPath in manifest) {\n      return nodeModulesPath;\n    }\n  }\n\n  // Fallback: search manifest values for matching path suffix\n  for (const [key, [actualPath]] of Object.entries(manifest)) {\n    if (posixFilePath.endsWith(actualPath) || posixFilePath.endsWith('/' + actualPath)) {\n      return key;\n    }\n  }\n\n  // For app-local files: the bundle path is relative to projectRoot (e.g., \"./__e2e__/...\")\n  // but the manifest key is relative to serverRoot (e.g., \"./apps/router-e2e/__e2e__/...\")\n  // Try to match by checking if the manifest key ends with the input path (minus ./ prefix)\n  const pathWithoutDotSlash = posixFilePath.replace(/^\\.\\//, '');\n  for (const key of Object.keys(manifest)) {\n    const keyWithoutDotSlash = key.replace(/^\\.\\//, '');\n    if (keyWithoutDotSlash.endsWith('/' + pathWithoutDotSlash) || keyWithoutDotSlash.endsWith(pathWithoutDotSlash)) {\n      return key;\n    }\n  }\n\n  return null;\n}\n\n// The import map allows us to use external modules from different bundling contexts.\ntype ImportMap = {\n  router: () => Promise<typeof import('./router/expo-definedRouter')>;\n};\n\nexport async function renderRscWithImportsAsync(\n  distFolder: string,\n  imports: ImportMap,\n  { body, platform, searchParams, config, method, input, contentType, headers }: RenderRscArgs\n): Promise<ReadableStream<any>> {\n  globalThis.__expo_platform_header = platform;\n  if (method === 'POST' && !body) {\n    throw new Error('Server request must be provided when method is POST (server actions)');\n  }\n\n  const context = getRscRenderContext(platform);\n  context['__expo_requestHeaders'] = headers;\n\n  const router = await imports.router();\n  const entries = router.default({\n    redirects: Constants.expoConfig?.extra?.router?.redirects,\n    rewrites: Constants.expoConfig?.extra?.router?.rewrites,\n  });\n\n  const ssrManifest = getSSRManifest(distFolder, platform);\n  const actionManifest = getServerActionManifest(distFolder, platform);\n  return renderRsc(\n    {\n      body: body ?? undefined,\n      context,\n      config,\n      input,\n      contentType,\n      decodedBody: searchParams.get('x-expo-params'),\n    },\n    {\n      isExporting: true,\n\n      resolveClientEntry(file: string, isServer: boolean) {\n        debug('resolveClientEntry', file, { isServer });\n\n        if (isServer) {\n          const actionKey = resolveManifestKey(file, actionManifest);\n          if (!actionKey) {\n            throw new Error(\n              `Could not find file in server action manifest: ${file}. ${JSON.stringify(actionManifest)}`\n            );\n          }\n\n          const [id, chunk] = actionManifest[actionKey];\n          return {\n            id,\n            chunks: chunk ? [chunk] : [],\n          };\n        }\n\n        const ssrKey = resolveManifestKey(file, ssrManifest);\n        if (!ssrKey) {\n          throw new Error(`Could not find file in SSR manifest: ${file}`);\n        }\n\n        const [id, chunk] = ssrManifest[ssrKey];\n        return {\n          id,\n          chunks: chunk ? [chunk] : [],\n        };\n      },\n      async loadServerModuleRsc(file) {\n        debug('loadServerModuleRsc', file);\n        // NOTE(@kitten): [WORKAROUND] Assumes __dirname is at `dist/server/_expo/functions/_flight`\n        return serverRequire('../../../', file);\n      },\n\n      entries: entries!,\n    }\n  );\n}\n\nexport async function renderRscAsync(\n  distFolder: string,\n  args: RenderRscArgs\n): Promise<ReadableStream<any>> {\n  const platform = args.platform;\n  return renderRscWithImportsAsync(\n    distFolder,\n    {\n      router: () => {\n        // NOTE(@kitten): [WORKAROUND] Assumes __dirname is at `dist/server/_expo/functions/_flight`\n        return serverRequire(`../../rsc/${platform}/router.js`);\n      },\n    },\n    args\n  );\n}\n"]}