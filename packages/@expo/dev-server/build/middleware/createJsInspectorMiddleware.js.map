{"version":3,"file":"createJsInspectorMiddleware.js","names":["_chalk","data","_interopRequireDefault","require","_net","_tls","_url","_JsInspector","obj","__esModule","default","createJsInspectorMiddleware","req","res","next","_req$url","origin","searchParams","URL","url","getServerBase","applicationId","get","writeHead","end","app","queryInspectorAppAsync","console","warn","chalk","yellow","method","JSON","stringify","length","toString","openJsInspector","error","_error$message","red","message","scheme","socket","TLSSocket","encrypted","localAddress","localPort","address","net","isIPv6"],"sources":["../../src/middleware/createJsInspectorMiddleware.ts"],"sourcesContent":["import chalk from 'chalk';\nimport type { NextHandleFunction } from 'connect';\nimport type { IncomingMessage, ServerResponse } from 'http';\nimport net from 'net';\nimport { TLSSocket } from 'tls';\nimport { URL } from 'url';\n\nimport { openJsInspector, queryInspectorAppAsync } from '../JsInspector';\n\nexport default function createJsInspectorMiddleware(): NextHandleFunction {\n  return async function (req: IncomingMessage, res: ServerResponse, next: (err?: Error) => void) {\n    const { origin, searchParams } = new URL(req.url ?? '/', getServerBase(req));\n    const applicationId = searchParams.get('applicationId');\n    if (!applicationId) {\n      res.writeHead(400).end('Missing applicationId');\n      return;\n    }\n\n    const app = await queryInspectorAppAsync(origin, applicationId);\n    if (!app) {\n      res.writeHead(404).end('Unable to find inspector target from metro-inspector-proxy');\n      console.warn(\n        chalk.yellow(\n          'No compatible apps connected. JavaScript Debugging can only be used with the Hermes engine.'\n        )\n      );\n      return;\n    }\n\n    if (req.method === 'GET') {\n      const data = JSON.stringify(app);\n      res.writeHead(200, {\n        'Content-Type': 'application/json; charset=UTF-8',\n        'Cache-Control': 'no-cache',\n        'Content-Length': data.length.toString(),\n      });\n      res.end(data);\n    } else if (req.method === 'POST' || req.method === 'PUT') {\n      try {\n        await openJsInspector(app);\n      } catch (error: any) {\n        // abort(Error: Command failed: osascript -e POSIX path of (path to application \"google chrome\")\n        // 15:50: execution error: Google Chrome got an error: Application isnâ€™t running. (-600)\n\n        console.error(\n          chalk.red('Error launching JS inspector: ' + (error?.message ?? 'Unknown error occurred'))\n        );\n        res.writeHead(500);\n        res.end();\n        return;\n      }\n      res.end();\n    } else {\n      res.writeHead(405);\n    }\n  };\n}\n\nfunction getServerBase(req: IncomingMessage): string {\n  const scheme =\n    req.socket instanceof TLSSocket && req.socket.encrypted === true ? 'https' : 'http';\n  const { localAddress, localPort } = req.socket;\n  const address = localAddress && net.isIPv6(localAddress) ? `[${localAddress}]` : localAddress;\n  return `${scheme}:${address}:${localPort}`;\n}\n"],"mappings":"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"}