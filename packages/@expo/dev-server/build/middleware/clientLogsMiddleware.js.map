{"version":3,"file":"clientLogsMiddleware.js","names":["clientLogsMiddleware","logger","req","res","next","deviceId","headers","deviceName","expoPlatform","writeHead","end","body","handleDeviceLogs","toString","logs","devicePlatform","error","tag","stack","isIgnorableBugReportingExtraData","length","isAppRegistryStartupMessage","test","getDevicePlatformFromAppRegistryStartupMessage","match","formatDevicePlatform","platform","formatted","ios","android","web","chalk","bold","log","Array","isArray","level","platformId","args","map","obj","JSON","stringify","logLevel","groupDepth","shouldHide","includesStack"],"sources":["../../src/middleware/clientLogsMiddleware.ts"],"sourcesContent":["import Log from '@expo/bunyan';\nimport chalk from 'chalk';\nimport { HandleFunction } from 'connect';\nimport http from 'http';\n\ntype ConsoleLogLevel = 'info' | 'warn' | 'error' | 'debug';\n\nexport default function clientLogsMiddleware(logger: Log): HandleFunction {\n  return function (\n    req: http.IncomingMessage & { body?: any },\n    res: http.ServerResponse,\n    next: (err?: Error) => void\n  ) {\n    try {\n      const deviceId = req.headers['device-id'];\n      const deviceName = req.headers['device-name'];\n      const expoPlatform = req.headers['expo-platform'];\n      if (!deviceId) {\n        res.writeHead(400).end('Missing Device-Id.');\n        return;\n      }\n      if (!deviceName) {\n        res.writeHead(400).end('Missing Device-Name.');\n        return;\n      }\n      if (!req.body) {\n        res.writeHead(400).end('Missing request body.');\n        return;\n      }\n      handleDeviceLogs(logger, {\n        deviceId: deviceId.toString(),\n        deviceName: deviceName.toString(),\n        logs: req.body,\n        devicePlatform: expoPlatform?.toString(),\n      });\n    } catch (error: any) {\n      logger.error({ tag: 'expo' }, `Error getting device logs: ${error} ${error.stack}`);\n      next(error);\n    }\n    res.end('Success');\n  };\n}\n\nfunction isIgnorableBugReportingExtraData(body: any[]): boolean {\n  return body.length === 2 && body[0] === 'BugReporting extraData:';\n}\n\nfunction isAppRegistryStartupMessage(body: any[]): boolean {\n  return (\n    body.length === 1 &&\n    (/^Running application \"main\" with appParams:/.test(body[0]) ||\n      /^Running \"main\" with \\{/.test(body[0]))\n  );\n}\n\nexport function getDevicePlatformFromAppRegistryStartupMessage(body: string[]): string | null {\n  if (body.length === 1 && typeof body[0] === 'string') {\n    // Dangerously pick the platform out of the request URL\n    // like: http:\\\\\\\\/\\\\\\\\/192.168.6.113:19000\\\\\\\\/index.bundle&platform=android\\dev=true&hot=false&minify=false\n    return body[0].match(/[?|&]platform=(\\w+)[&|\\\\]/)?.[1] ?? null;\n  }\n  return null;\n}\n\nfunction formatDevicePlatform(platform: string): string {\n  // Map the ID like \"ios\" to \"iOS\"\n  const formatted = { ios: 'iOS', android: 'Android', web: 'Web' }[platform] || platform;\n  return `${chalk.bold(formatted)} `;\n}\n\nfunction handleDeviceLogs(\n  logger: Log,\n  {\n    deviceId,\n    deviceName,\n    logs,\n    devicePlatform,\n  }: { deviceId: string; deviceName: string; devicePlatform?: string; logs: any }\n): void {\n  for (const log of logs) {\n    let body = Array.isArray(log.body) ? log.body : [log.body];\n    let { level } = log;\n\n    if (isIgnorableBugReportingExtraData(body)) {\n      level = 'debug';\n    }\n    if (isAppRegistryStartupMessage(body)) {\n      // If the installed version of expo is sending back the `device-platform` header\n      // then use that, otherwise find it in the query string.\n      const platformId = devicePlatform\n        ? devicePlatform\n        : getDevicePlatformFromAppRegistryStartupMessage(body);\n\n      const platform = platformId ? formatDevicePlatform(platformId) : '';\n      body = [`${platform}Running app on ${deviceName}`];\n    }\n\n    const args = body.map((obj: any) => {\n      if (typeof obj === 'undefined') {\n        return 'undefined';\n      }\n      if (obj === 'null') {\n        return 'null';\n      }\n      if (typeof obj === 'string' || typeof obj === 'number' || typeof obj === 'boolean') {\n        return obj;\n      }\n      try {\n        return JSON.stringify(obj);\n      } catch {\n        return obj.toString();\n      }\n    });\n    const logLevel =\n      level === 'info' || level === 'warn' || level === 'error' || level === 'debug'\n        ? (level as ConsoleLogLevel)\n        : 'info';\n    logger[logLevel](\n      {\n        tag: 'device',\n        deviceId,\n        deviceName,\n        groupDepth: log.groupDepth,\n        shouldHide: log.shouldHide,\n        includesStack: log.includesStack,\n      },\n      ...args\n    );\n  }\n}\n"],"mappings":"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"}