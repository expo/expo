{"version":3,"file":"devServerMiddleware.js","names":["_bodyParser","data","_interopRequireDefault","require","_clientLogsMiddleware","_createJsInspectorMiddleware","_remoteDevtoolsCorsMiddleware","_remoteDevtoolsSecurityHeadersMiddleware","_suppressErrorMiddleware","_importMetroFromProject","_middlwareMutations","obj","__esModule","default","createDevServerMiddleware","projectRoot","watchFolders","port","logger","securityHeadersMiddleware","importCliServerApiFromProject","middleware","attachToServer","debuggerProxyEndpoint","messageSocketEndpoint","eventsSocketEndpoint","websocketEndpoints","replaceMiddlewareWith","remoteDevtoolsSecurityHeadersMiddleware","use","remoteDevtoolsCorsMiddleware","prependMiddleware","suppressRemoteDebuggingErrorMiddleware","bodyParser","json","clientLogsMiddleware","createJsInspectorMiddleware"],"sources":["../../src/middleware/devServerMiddleware.ts"],"sourcesContent":["import Log from '@expo/bunyan';\nimport bodyParser from 'body-parser';\nimport { Server as ConnectServer } from 'connect';\n\nimport clientLogsMiddleware from './clientLogsMiddleware';\nimport createJsInspectorMiddleware from './createJsInspectorMiddleware';\nimport { remoteDevtoolsCorsMiddleware } from './remoteDevtoolsCorsMiddleware';\nimport { remoteDevtoolsSecurityHeadersMiddleware } from './remoteDevtoolsSecurityHeadersMiddleware';\nimport { suppressRemoteDebuggingErrorMiddleware } from './suppressErrorMiddleware';\nimport { importCliServerApiFromProject } from '../metro/importMetroFromProject';\nimport { prependMiddleware, replaceMiddlewareWith } from '../middlwareMutations';\n\n/**\n * Extends the default `createDevServerMiddleware` and adds some Expo CLI-specific dev middleware\n * with exception for the manifest middleware which is currently in `xdl`.\n *\n * Adds:\n * - `/logs`: pipe runtime `console` logs to the `props.logger` object.\n * - `/inspector`: launch hermes inspector proxy in chrome.\n * - CORS support for remote devtools\n * - body parser middleware\n *\n * @param props.watchFolders array of directory paths to use with watchman\n * @param props.port port that the dev server will run on\n * @param props.logger bunyan instance that all runtime `console` logs will be piped through.\n *\n * @returns\n */\nexport function createDevServerMiddleware(\n  projectRoot: string,\n  {\n    watchFolders,\n    port,\n    logger,\n  }: {\n    watchFolders: readonly string[];\n    port: number;\n    logger: Log;\n  }\n) {\n  const { createDevServerMiddleware, securityHeadersMiddleware } =\n    importCliServerApiFromProject(projectRoot);\n  const {\n    middleware,\n    // @ts-expect-error: Old API\n    attachToServer,\n\n    // New\n    debuggerProxyEndpoint,\n    messageSocketEndpoint,\n    eventsSocketEndpoint,\n    websocketEndpoints,\n  } = createDevServerMiddleware({\n    port,\n    watchFolders,\n  });\n\n  // securityHeadersMiddleware does not support cross-origin requests for remote devtools to get the sourcemap.\n  // We replace with the enhanced version.\n  replaceMiddlewareWith(\n    middleware as ConnectServer,\n    securityHeadersMiddleware,\n    remoteDevtoolsSecurityHeadersMiddleware\n  );\n  middleware.use(remoteDevtoolsCorsMiddleware);\n  prependMiddleware(middleware, suppressRemoteDebuggingErrorMiddleware);\n\n  middleware.use(bodyParser.json());\n  middleware.use('/logs', clientLogsMiddleware(logger));\n  middleware.use('/inspector', createJsInspectorMiddleware());\n\n  return {\n    logger,\n    middleware,\n    // Old\n    attachToServer,\n    // New\n    debuggerProxyEndpoint,\n    messageSocketEndpoint,\n    eventsSocketEndpoint,\n    websocketEndpoints,\n  };\n}\n"],"mappings":";;;;;;AACA,SAAAA,YAAA;EAAA,MAAAC,IAAA,GAAAC,sBAAA,CAAAC,OAAA;EAAAH,WAAA,YAAAA,CAAA;IAAA,OAAAC,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAGA,SAAAG,sBAAA;EAAA,MAAAH,IAAA,GAAAC,sBAAA,CAAAC,OAAA;EAAAC,qBAAA,YAAAA,CAAA;IAAA,OAAAH,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAI,6BAAA;EAAA,MAAAJ,IAAA,GAAAC,sBAAA,CAAAC,OAAA;EAAAE,4BAAA,YAAAA,CAAA;IAAA,OAAAJ,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAK,8BAAA;EAAA,MAAAL,IAAA,GAAAE,OAAA;EAAAG,6BAAA,YAAAA,CAAA;IAAA,OAAAL,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAM,yCAAA;EAAA,MAAAN,IAAA,GAAAE,OAAA;EAAAI,wCAAA,YAAAA,CAAA;IAAA,OAAAN,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAO,yBAAA;EAAA,MAAAP,IAAA,GAAAE,OAAA;EAAAK,wBAAA,YAAAA,CAAA;IAAA,OAAAP,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAQ,wBAAA;EAAA,MAAAR,IAAA,GAAAE,OAAA;EAAAM,uBAAA,YAAAA,CAAA;IAAA,OAAAR,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAS,oBAAA;EAAA,MAAAT,IAAA,GAAAE,OAAA;EAAAO,mBAAA,YAAAA,CAAA;IAAA,OAAAT,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAAiF,SAAAC,uBAAAS,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAEjF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASG,yBAAyBA,CACvCC,WAAmB,EACnB;EACEC,YAAY;EACZC,IAAI;EACJC;AAKF,CAAC,EACD;EACA,MAAM;IAAEJ,yBAAyB;IAAEK;EAA0B,CAAC,GAC5D,IAAAC,uDAA6B,EAACL,WAAW,CAAC;EAC5C,MAAM;IACJM,UAAU;IACV;IACAC,cAAc;IAEd;IACAC,qBAAqB;IACrBC,qBAAqB;IACrBC,oBAAoB;IACpBC;EACF,CAAC,GAAGZ,yBAAyB,CAAC;IAC5BG,IAAI;IACJD;EACF,CAAC,CAAC;;EAEF;EACA;EACA,IAAAW,2CAAqB,EACnBN,UAAU,EACVF,yBAAyB,EACzBS,kFAAuC,CACxC;EACDP,UAAU,CAACQ,GAAG,CAACC,4DAA4B,CAAC;EAC5C,IAAAC,uCAAiB,EAACV,UAAU,EAAEW,iEAAsC,CAAC;EAErEX,UAAU,CAACQ,GAAG,CAACI,qBAAU,CAACC,IAAI,EAAE,CAAC;EACjCb,UAAU,CAACQ,GAAG,CAAC,OAAO,EAAE,IAAAM,+BAAoB,EAACjB,MAAM,CAAC,CAAC;EACrDG,UAAU,CAACQ,GAAG,CAAC,YAAY,EAAE,IAAAO,sCAA2B,GAAE,CAAC;EAE3D,OAAO;IACLlB,MAAM;IACNG,UAAU;IACV;IACAC,cAAc;IACd;IACAC,qBAAqB;IACrBC,qBAAqB;IACrBC,oBAAoB;IACpBC;EACF,CAAC;AACH"}