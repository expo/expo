{"version":3,"file":"load.js","names":["_nodeFs","data","_interopRequireDefault","require","nodeModule","_interopRequireWildcard","_nodePath","_nodeUrl","e","__esModule","default","_getRequireWildcardCache","WeakMap","r","t","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","ts","loadTypescript","undefined","error","code","parent","module","tsExtensionMapping","toFormat","filename","endsWith","isTypescriptFilename","compileModule","opts","format","prependPaths","paths","nodeModulePaths","_nodeModulePaths","path","dirname","mod","assign","Module","_compile","cache","children","splice","indexOf","exports","hasStripTypeScriptTypes","stripTypeScriptTypes","evalModule","inputCode","inputFilename","ext","extname","output","transpileModule","fileName","reportDiagnostics","compilerOptions","ModuleKind","CommonJS","ESNext","moduleResolution","ModuleResolutionKind","Bundler","target","ScriptTarget","newLine","NewLineKind","LineFeed","inlineSourceMap","outputText","mode","sourceMap","inputExt","join","basename","requireOrImport","Promise","resolve","isAbsolute","url","pathToFileURL","toString","then","s","loadModule","fs","promises","readFile"],"sources":["../src/load.ts"],"sourcesContent":["import fs from 'node:fs';\nimport * as nodeModule from 'node:module';\nimport path from 'node:path';\nimport url from 'node:url';\n\ndeclare module 'node:module' {\n  export function _nodeModulePaths(base: string): readonly string[];\n}\n\ndeclare global {\n  namespace NodeJS {\n    export interface Module {\n      _compile(\n        code: string,\n        filename: string,\n        format?: 'module' | 'commonjs' | 'commonjs-typescript' | 'module-typescript' | 'typescript'\n      ): unknown;\n    }\n  }\n}\n\nlet ts: typeof import('typescript') | null | undefined;\n\nfunction loadTypescript() {\n  if (ts === undefined) {\n    try {\n      ts = require('typescript');\n    } catch (error: any) {\n      if (error.code !== 'MODULE_NOT_FOUND') {\n        throw error;\n      } else {\n        ts = null;\n      }\n    }\n  }\n  return ts;\n}\n\nconst parent = module;\n\nconst tsExtensionMapping: Record<string, string | undefined> = {\n  '.ts': '.js',\n  '.cts': '.cjs',\n  '.mts': '.mjs',\n};\n\nfunction toFormat(filename: string) {\n  if (filename.endsWith('.cjs')) {\n    return 'commonjs';\n  } else if (filename.endsWith('.mjs')) {\n    return 'module';\n  } else if (filename.endsWith('.js')) {\n    return undefined;\n  } else if (filename.endsWith('.mts')) {\n    return 'module-typescript';\n  } else if (filename.endsWith('.cts')) {\n    return 'commonjs-typescript';\n  } else if (filename.endsWith('.ts')) {\n    return 'typescript';\n  } else {\n    return undefined;\n  }\n}\n\nfunction isTypescriptFilename(filename: string) {\n  switch (toFormat(filename)) {\n    case 'module-typescript':\n    case 'commonjs-typescript':\n    case 'typescript':\n      return true;\n    default:\n      return false;\n  }\n}\n\nexport interface ModuleOptions {\n  paths?: string[];\n}\n\nfunction compileModule<T = any>(code: string, filename: string, opts: ModuleOptions): T {\n  const format = toFormat(filename);\n  const prependPaths = opts.paths ?? [];\n  const nodeModulePaths = nodeModule._nodeModulePaths(path.dirname(filename));\n  const paths = [...prependPaths, ...nodeModulePaths];\n  try {\n    const mod = Object.assign(new nodeModule.Module(filename, parent), { filename, paths });\n    mod._compile(code, filename, format);\n    require.cache[filename] = mod;\n    parent?.children?.splice(parent.children.indexOf(mod), 1);\n    return mod.exports;\n  } catch (error: any) {\n    delete require.cache[filename];\n    throw error;\n  }\n}\n\nconst hasStripTypeScriptTypes = typeof nodeModule.stripTypeScriptTypes === 'function';\n\nfunction evalModule(code: string, filename: string, opts: ModuleOptions = {}) {\n  let inputCode = code;\n  let inputFilename = filename;\n  if (filename.endsWith('.ts') || filename.endsWith('.cts') || filename.endsWith('.mts')) {\n    const ext = path.extname(filename);\n    const ts = loadTypescript();\n    if (ts) {\n      const output = ts.transpileModule(code, {\n        fileName: filename,\n        reportDiagnostics: false,\n        compilerOptions: {\n          module: ext === '.cts' ? ts.ModuleKind.CommonJS : ts.ModuleKind.ESNext,\n          moduleResolution: ts.ModuleResolutionKind.Bundler,\n          target: ts.ScriptTarget.ESNext,\n          newLine: ts.NewLineKind.LineFeed,\n          inlineSourceMap: true,\n        },\n      });\n      inputCode = output ? output.outputText : inputCode;\n    }\n\n    if (hasStripTypeScriptTypes && inputCode === code) {\n      inputCode = nodeModule.stripTypeScriptTypes(code, {\n        mode: 'transform',\n        sourceMap: true,\n      });\n    }\n\n    if (inputCode !== code) {\n      const inputExt = tsExtensionMapping[ext] ?? ext;\n      if (inputExt !== ext) {\n        inputFilename = path.join(path.dirname(filename), path.basename(filename, ext) + inputExt);\n      }\n    }\n  }\n\n  const mod = compileModule(inputCode, inputFilename, opts);\n  if (inputFilename !== filename) {\n    require.cache[filename] = mod;\n  }\n  return mod;\n}\n\nasync function requireOrImport(filename: string) {\n  try {\n    return require(filename);\n  } catch {\n    return await import(\n      path.isAbsolute(filename)\n        ? url.pathToFileURL(filename).toString()\n        : filename\n    );\n  }\n}\n\nasync function loadModule(filename: string) {\n  try {\n    return await requireOrImport(filename);\n  } catch (error: any) {\n    if (error.code === 'ERR_UNKNOWN_FILE_EXTENSION' && isTypescriptFilename(filename)) {\n      const code = await fs.promises.readFile(filename, 'utf8');\n      return evalModule(code, filename);\n    } else {\n      throw error;\n    }\n  }\n}\n\nexport { evalModule, loadModule };\n"],"mappings":"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","ignoreList":[]}