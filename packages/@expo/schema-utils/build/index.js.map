{"version":3,"file":"index.js","names":["_deref","data","require","_validate","_JSONSchema","CACHE_SYMBOL","Symbol","flattenValidationResults","input","output","push","message","path","keyword","value","idx","cause","length","toErrorsMessages","errors","map","error","ValidationError","Error","constructor","result","schema","title","line","join","name","toErrorsMessage","exports","derefSchemaCache","derefed","deref","cache","WeakMap","derefSchema","validate","get","undefined","validateSchema","set"],"sources":["../src/index.ts"],"sourcesContent":["import { JSONSchema } from './JSONSchema';\nimport { deref } from './deref';\nimport {\n  validateSchema,\n  BaseValidationError,\n  ValidationError as ValidationResult,\n} from './validate';\n\nexport { JSONSchema } from './JSONSchema';\n\nconst CACHE_SYMBOL = Symbol('@expo/schema-utils');\n\ninterface SchemaCacheData {\n  schema: JSONSchema;\n  cache: WeakMap<object, ValidationResult | null>;\n}\n\nconst flattenValidationResults = (\n  input: ValidationResult,\n  output: BaseValidationError[] = []\n): BaseValidationError[] => {\n  output.push({\n    message: input.message,\n    path: input.path,\n    keyword: input.keyword,\n    value: input.value,\n  });\n  for (let idx = 0; input.cause && idx < input.cause.length; idx++) {\n    flattenValidationResults(input.cause[idx], output);\n  }\n  return output;\n};\n\nconst toErrorsMessages = (errors: BaseValidationError[]) =>\n  errors.map((error) => {\n    return `\\n - options${error.path} (${error.keyword}): ${error.message}`;\n  });\n\nexport class ValidationError<T> extends Error {\n  schema: JSONSchema<T>;\n  errors: BaseValidationError[];\n  constructor(result: ValidationResult, schema: JSONSchema<T>) {\n    const errors = flattenValidationResults(result);\n    const title = typeof schema.title === 'string' ? schema.title : 'Value';\n    super(\n      `Invalid options object. ${title} options object does not match the defined schema.\\n` +\n        toErrorsMessages(errors)\n          .map((line) => ` - options${line}`)\n          .join('\\n')\n    );\n    this.name = 'ValidationError';\n    this.errors = errors;\n    this.schema = schema;\n  }\n\n  toErrorsMessage(): string[] {\n    return toErrorsMessages(this.errors);\n  }\n}\n\nconst derefSchemaCache = (schema: JSONSchema): SchemaCacheData => {\n  let derefed = (schema as any)[CACHE_SYMBOL] as SchemaCacheData | undefined;\n  if (!derefed) {\n    derefed = {\n      schema: deref(schema),\n      cache: new WeakMap(),\n    };\n    (schema as any)[CACHE_SYMBOL] = derefed;\n  }\n  return derefed!;\n};\n\nexport function derefSchema<T>(schema: JSONSchema<T>): JSONSchema<T> {\n  return derefSchemaCache(schema).schema;\n}\n\nexport function validate<T>(schema: JSONSchema<T>, value: unknown): asserts value is T {\n  const data = derefSchemaCache(schema);\n  let result: ValidationResult | null | undefined;\n  if (\n    typeof value !== 'object' ||\n    value == null ||\n    (result = data.cache.get(value)) === undefined\n  ) {\n    result = validateSchema(data.schema, value, '');\n    if (typeof value === 'object' && value != null) {\n      data.cache.set(value, result);\n    }\n  }\n  if (result) {\n    throw new ValidationError(result, data.schema);\n  }\n}\n"],"mappings":"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","ignoreList":[]}