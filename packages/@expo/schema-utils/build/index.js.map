{"version":3,"file":"index.js","names":["_deref","data","require","_validate","_JSONSchema","CACHE_SYMBOL","Symbol","flattenValidationResults","input","output","push","message","path","keyword","value","idx","cause","length","toErrorMessage","errors","name","error","ValidationError","Error","constructor","result","schema","title","exports","derefSchemaCache","derefed","deref","cache","WeakMap","derefSchema","validate","get","undefined","validateSchema","set"],"sources":["../src/index.ts"],"sourcesContent":["import { JSONSchema } from './JSONSchema';\nimport { deref } from './deref';\nimport {\n  validateSchema,\n  BaseValidationError,\n  ValidationError as ValidationResult,\n} from './validate';\n\nexport { JSONSchema } from './JSONSchema';\n\nconst CACHE_SYMBOL = Symbol('@expo/schema-utils');\n\ninterface SchemaCacheData {\n  schema: JSONSchema;\n  cache: WeakMap<object, ValidationResult | null>;\n}\n\nconst flattenValidationResults = (\n  input: ValidationResult,\n  output: BaseValidationError[] = []\n): BaseValidationError[] => {\n  output.push({\n    message: input.message,\n    path: input.path,\n    keyword: input.keyword,\n    value: input.value,\n  });\n  for (let idx = 0; input.cause && idx < input.cause.length; idx++) {\n    flattenValidationResults(input.cause[idx], output);\n  }\n  return output;\n};\n\nconst toErrorMessage = (errors: BaseValidationError[], name: string) => {\n  let message = `Invalid options object. ${name} has been initialized using an options object that does not match the API schema.`;\n  for (const error of errors) {\n    message += `\\n - options${error.path} (${error.keyword}): ${error.message}`;\n  }\n  return message;\n};\n\nexport class ValidationError extends Error {\n  schema: JSONSchema;\n  errors: BaseValidationError[];\n  constructor(result: ValidationResult, schema: JSONSchema) {\n    const errors = flattenValidationResults(result);\n    super(toErrorMessage(errors, typeof schema.title === 'string' ? schema.title : 'Value'));\n    this.name = 'ValidationError';\n    this.errors = errors;\n    this.schema = schema;\n  }\n}\n\nconst derefSchemaCache = (schema: JSONSchema): SchemaCacheData => {\n  let derefed = (schema as any)[CACHE_SYMBOL] as SchemaCacheData | undefined;\n  if (!derefed) {\n    derefed = {\n      schema: deref(schema),\n      cache: new WeakMap(),\n    };\n    (schema as any)[CACHE_SYMBOL] = derefed;\n  }\n  return derefed!;\n};\n\nexport function derefSchema(schema: JSONSchema): JSONSchema {\n  return derefSchemaCache(schema).schema;\n}\n\nexport function validate(schema: JSONSchema, value: unknown) {\n  const data = derefSchemaCache(schema);\n  let result: ValidationResult | null | undefined;\n  if (\n    typeof value !== 'object' ||\n    value == null ||\n    (result = data.cache.get(value)) === undefined\n  ) {\n    result = validateSchema(data.schema, value, '');\n    if (typeof value === 'object' && value != null) {\n      data.cache.set(value, result);\n    }\n  }\n  if (result) {\n    throw new ValidationError(result, data.schema);\n  }\n}\n"],"mappings":"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","ignoreList":[]}