{"version":3,"file":"rewriteRequestUrl.js","names":["_config","data","require","_paths","_chalk","_interopRequireDefault","_fs","_path","_getModulesPaths","obj","__esModule","default","debug","directoryExistsSync","file","_fs$statSync$isDirect","_fs$statSync","fs","statSync","isDirectory","isEnableHermesManaged","expoConfig","platform","_expoConfig$android$j","_expoConfig$android","android","jsEngine","_expoConfig$ios$jsEng","_expoConfig$ios","ios","getRouterDirectoryModuleIdWithManifest","projectRoot","exp","_exp$extra$router$roo","_exp$extra","_exp$extra$router","extra","router","root","getRouterDirectory","path","join","getRewriteRequestUrl","rewriteExpoRequestUrl","url","includes","_searchParams$get","pkg","getConfig","skipSDKVersionRequirement","ensured","startsWith","URL","searchParams","get","entry","resolveEntryPoint","Error","chalk","has","set","isHermesEnabled","serverRoot","getServerRoot","relativeEntry","relative","replace","toString","pathname","outputUrl"],"sources":["../src/rewriteRequestUrl.ts"],"sourcesContent":["// Copyright 2023-present 650 Industries (Expo). All rights reserved.\nimport { ExpoConfig, getConfig } from '@expo/config';\nimport { resolveEntryPoint } from '@expo/config/paths';\nimport chalk from 'chalk';\nimport fs from 'fs';\nimport path from 'path';\n\nimport { getServerRoot } from './getModulesPaths';\n\nconst debug = require('debug')('expo:metro:config:rewriteRequestUrl');\n\nfunction directoryExistsSync(file: string): boolean {\n  try {\n    return fs.statSync(file)?.isDirectory() ?? false;\n  } catch {\n    return false;\n  }\n}\n\nfunction isEnableHermesManaged(\n  expoConfig: Partial<Pick<ExpoConfig, 'ios' | 'android' | 'jsEngine'>>,\n  platform: string\n): boolean {\n  switch (platform) {\n    case 'android': {\n      return (expoConfig.android?.jsEngine ?? expoConfig.jsEngine) !== 'jsc';\n    }\n    case 'ios': {\n      return (expoConfig.ios?.jsEngine ?? expoConfig.jsEngine) !== 'jsc';\n    }\n    default:\n      return false;\n  }\n}\n\nfunction getRouterDirectoryModuleIdWithManifest(projectRoot: string, exp: ExpoConfig): string {\n  return exp.extra?.router?.root ?? getRouterDirectory(projectRoot);\n}\n\nexport function getRouterDirectory(projectRoot: string): string {\n  // more specific directories first\n  if (directoryExistsSync(path.join(projectRoot, 'src/app'))) {\n    debug('Using src/app as the root directory for Expo Router.');\n    return 'src/app';\n  }\n\n  debug('Using app as the root directory for Expo Router.');\n  return 'app';\n}\n\nexport function getRewriteRequestUrl(projectRoot: string) {\n  function rewriteExpoRequestUrl(url: string): string {\n    // Like: `/.expo/.virtual-metro-entry.bundle?platform=ios&dev=true&minify=false&modulesOnly=false&runModule=true&app=com.bacon.test-custom-entry`\n    // Sometimes a fully qualified URL is passed in, e.g. `http://localhost:19001/.expo/.virtual-metro-entry.bundle?platform=ios&dev=true&minify=false&modulesOnly=false&runModule=true&app=com.bacon.test-custom-entry`\n    if (url.includes('/.expo/.virtual-metro-entry.bundle?')) {\n      const { pkg, exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n      const ensured = url.startsWith('/') ? new URL(url, 'https://acme.dev') : new URL(url);\n      // TODO: Maybe this function could be memoized in some capacity?\n      const { searchParams } = ensured;\n\n      const platform = searchParams.get('platform') ?? 'web';\n\n      debug('Rewriting magic request url to entry point', { url, platform });\n\n      const entry = resolveEntryPoint(projectRoot, {\n        platform,\n        pkg,\n      });\n\n      if (!entry) {\n        throw new Error(\n          chalk`The project entry file could not be resolved (platform: ${platform}, root: ${projectRoot}). Define it in the {bold package.json} \"main\" field.`\n        );\n      }\n\n      // Infer the missing transform properties to attempt to match the manifest request.\n      // NOTE: Keep in sync with metroOptions.ts\n      if (!ensured.searchParams.has('transform.routerRoot')) {\n        ensured.searchParams.set(\n          'transform.routerRoot',\n          getRouterDirectoryModuleIdWithManifest(projectRoot, exp)\n        );\n      }\n\n      if (!ensured.searchParams.has('transform.engine')) {\n        const isHermesEnabled = isEnableHermesManaged(exp, platform);\n        if (isHermesEnabled) {\n          debug('Enabling Hermes for managed project');\n          ensured.searchParams.set('transform.engine', 'hermes');\n        }\n      }\n\n      const serverRoot = getServerRoot(projectRoot);\n      const relativeEntry = path.relative(serverRoot, entry).replace(/\\.[tj]sx?$/, '');\n      debug('Resolved entry point', { entry, relativeEntry, serverRoot });\n\n      // Only return the pathname when url is relative\n      if (url.startsWith('/')) {\n        // Like: `/index.bundle?platform=ios&dev=true&minify=false&modulesOnly=false&runModule=true&app=com.bacon.test-custom-entry`\n        return '/' + relativeEntry + '.bundle?' + searchParams.toString();\n      }\n\n      // Modify the pathname within the URL and return the full URL\n      ensured.pathname = '/' + relativeEntry + '.bundle';\n\n      const outputUrl = ensured.toString();\n      debug('Redirected:', outputUrl);\n      // Like: `http://localhost:19001/index.bundle?platform=ios&dev=true&minify=false&modulesOnly=false&runModule=true&app=com.bacon.test-custom-entry`\n      return outputUrl;\n    }\n\n    return url;\n  }\n  return rewriteExpoRequestUrl;\n}\n"],"mappings":"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"}