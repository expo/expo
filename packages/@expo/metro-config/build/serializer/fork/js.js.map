{"version":3,"file":"js.js","names":["_assert","data","_interopRequireDefault","require","_jscSafeUrl","_metroTransformPlugins","_path","obj","__esModule","default","wrapModule","module","options","output","getJsOutput","type","startsWith","src","code","paths","params","getModuleParams","skipWrapping","addParamsToDefineCall","moduleId","createModuleId","path","hasPaths","dependencyMapArray","Array","from","dependencies","values","map","dependency","id","absolutePath","asyncType","includeAsyncPaths","sourceUrl","searchParams","URL","jscSafeUrl","toNormalUrl","set","bundlePath","relative","serverRoot","join","dirname","basename","extname","toString","splitChunks","computedAsyncModulePaths","dev","push","projectRoot","_module$path","_module$path2","jsModules","filter","assert","length","jsOutput","Number","isFinite","lineCount","isJsModule","isJsOutput"],"sources":["../../../src/serializer/fork/js.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * Fork of the metro helper, but with bundle splitting support.\n * https://github.com/facebook/metro/blob/bbdd7d7c5e6e0feb50a9967ffae1f723c1d7c4e8/packages/metro/src/DeltaBundler/Serializers/helpers/js.js#L1\n */\n\nimport assert from 'assert';\nimport jscSafeUrl from 'jsc-safe-url';\nimport type { MixedOutput, Module } from 'metro';\nimport { addParamsToDefineCall } from 'metro-transform-plugins';\nimport type { JsOutput } from 'metro-transform-worker';\nimport path from 'path';\n\nexport type Options = {\n  createModuleId: (module: string) => number | string;\n  dev: boolean;\n  includeAsyncPaths: boolean;\n  projectRoot: string;\n  serverRoot: string;\n  sourceUrl: string | undefined;\n  splitChunks: boolean;\n  skipWrapping: boolean;\n  computedAsyncModulePaths: Record<string, string> | null;\n};\n\nexport function wrapModule(\n  module: Module,\n  options: Options\n): { src: string; paths: Record<string, string> } {\n  const output = getJsOutput(module);\n\n  if (output.type.startsWith('js/script')) {\n    return { src: output.data.code, paths: {} };\n  }\n\n  const { params, paths } = getModuleParams(module, options);\n  let src = output.data.code;\n  if (!options.skipWrapping) {\n    src = addParamsToDefineCall(output.data.code, ...params);\n  }\n\n  return { src, paths };\n}\n\nexport function getModuleParams(\n  module: Module,\n  options: Pick<\n    Options,\n    | 'createModuleId'\n    | 'sourceUrl'\n    | 'includeAsyncPaths'\n    | 'serverRoot'\n    | 'splitChunks'\n    | 'dev'\n    | 'projectRoot'\n    | 'computedAsyncModulePaths'\n  >\n): { params: any[]; paths: Record<string, string> } {\n  const moduleId = options.createModuleId(module.path);\n\n  const paths: { [moduleID: number | string]: any } = {};\n  let hasPaths = false;\n  const dependencyMapArray = Array.from(module.dependencies.values()).map((dependency) => {\n    const id = options.createModuleId(dependency.absolutePath);\n    if (\n      // NOTE(EvanBacon): Disabled this to ensure that paths are provided even when the entire bundle\n      // is created. This is required for production bundle splitting.\n      // options.includeAsyncPaths &&\n\n      dependency.data.data.asyncType != null\n    ) {\n      if (options.includeAsyncPaths) {\n        if (options.sourceUrl) {\n          hasPaths = true;\n          // TODO: Only include path if the target is not in the bundle\n\n          // Construct a server-relative URL for the split bundle, propagating\n          // most parameters from the main bundle's URL.\n\n          const { searchParams } = new URL(jscSafeUrl.toNormalUrl(options.sourceUrl));\n          searchParams.set('modulesOnly', 'true');\n          searchParams.set('runModule', 'false');\n\n          const bundlePath = path.relative(options.serverRoot, dependency.absolutePath);\n          paths[id] =\n            '/' +\n            path.join(\n              path.dirname(bundlePath),\n              // Strip the file extension\n              path.basename(bundlePath, path.extname(bundlePath))\n            ) +\n            '.bundle?' +\n            searchParams.toString();\n        }\n      } else if (options.splitChunks && options.computedAsyncModulePaths != null) {\n        hasPaths = true;\n        // A template string that we'll match and replace later when we know the content hash for a given path.\n        paths[id] = options.computedAsyncModulePaths[dependency.absolutePath];\n      }\n    }\n    return id;\n  });\n\n  const params = [\n    moduleId,\n    hasPaths\n      ? {\n          ...dependencyMapArray,\n          paths,\n        }\n      : dependencyMapArray,\n  ];\n\n  if (options.dev) {\n    // Add the relative path of the module to make debugging easier.\n    // This is mapped to `module.verboseName` in `require.js`.\n    params.push(path.relative(options.projectRoot, module.path));\n  }\n\n  return { params, paths };\n}\n\nexport function getJsOutput(module: {\n  output: readonly MixedOutput[];\n  path?: string;\n  // ...\n}): JsOutput {\n  const jsModules = module.output.filter(({ type }) => type.startsWith('js/'));\n\n  assert(\n    jsModules.length === 1,\n    `Modules must have exactly one JS output, but ${module.path ?? 'unknown module'} has ${\n      jsModules.length\n    } JS outputs.`\n  );\n\n  const jsOutput: JsOutput = jsModules[0] as unknown as any;\n\n  assert(\n    Number.isFinite(jsOutput.data.lineCount),\n    `JS output must populate lineCount, but ${module.path ?? 'unknown module'} has ${\n      jsOutput.type\n    } output with lineCount '${jsOutput.data.lineCount}'`\n  );\n\n  return jsOutput;\n}\n\nexport function isJsModule(module: Module): boolean {\n  return module.output.filter(isJsOutput).length > 0;\n}\n\nexport function isJsOutput(output: MixedOutput): output is MixedOutput {\n  return output.type.startsWith('js/');\n}\n"],"mappings":"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"}