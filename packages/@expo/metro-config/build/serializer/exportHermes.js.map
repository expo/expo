{"version":3,"file":"exportHermes.js","names":["_spawnAsync","data","_interopRequireDefault","require","_chalk","_fsExtra","_metroSourceMap","_os","_path","_process","obj","__esModule","default","debug","importHermesCommandFromProject","platformExecutable","getHermesCommandPlatform","hermescLocations","process","env","location","resolve","Error","os","platform","currentHermesBuild","buildHermesBundleAsync","options","directlyBuildHermesBundleAsync","code","map","minify","filename","tempDir","path","join","tmpdir","Math","random","Date","now","fs","ensureDir","tempBundleFile","writeFile","tempSourcemapFile","tempHbcFile","hermesCommand","args","push","spawnAsync","hbc","sourcemap","readFile","Promise","all","createHermesSourcemapAsync","error","console","chalk","red","output","remove","hermesMapFile","bundlerSourcemap","JSON","parse","hermesSourcemap","readJSON","stringify","composeSourceMaps"],"sources":["../../src/serializer/exportHermes.ts"],"sourcesContent":["import spawnAsync from '@expo/spawn-async';\nimport chalk from 'chalk';\nimport fs from 'fs-extra';\nimport { composeSourceMaps } from 'metro-source-map';\nimport os from 'os';\nimport path from 'path';\nimport process from 'process';\n\nconst debug = require('debug')('expo:metro:hermes') as typeof console.log;\n\nfunction importHermesCommandFromProject(): string {\n  const platformExecutable = getHermesCommandPlatform();\n  const hermescLocations = [\n    // Override hermesc dir by environment variables\n    process.env['REACT_NATIVE_OVERRIDE_HERMES_DIR']\n      ? `${process.env['REACT_NATIVE_OVERRIDE_HERMES_DIR']}/build/bin/hermesc`\n      : '',\n\n    // Building hermes from source\n    'react-native/ReactAndroid/hermes-engine/build/hermes/bin/hermesc',\n\n    // Prebuilt hermesc in official react-native 0.69+\n    `react-native/sdks/hermesc/${platformExecutable}`,\n\n    // Legacy hermes-engine package\n    `hermes-engine/${platformExecutable}`,\n  ];\n\n  for (const location of hermescLocations) {\n    try {\n      return require.resolve(location);\n    } catch {}\n  }\n  throw new Error('Cannot find the hermesc executable.');\n}\n\nfunction getHermesCommandPlatform(): string {\n  switch (os.platform()) {\n    case 'darwin':\n      return 'osx-bin/hermesc';\n    case 'linux':\n      return 'linux64-bin/hermesc';\n    case 'win32':\n      return 'win64-bin/hermesc.exe';\n    default:\n      throw new Error(`Unsupported host platform for Hermes compiler: ${os.platform()}`);\n  }\n}\n\ninterface HermesBundleOutput {\n  hbc: Uint8Array;\n  sourcemap: string | null;\n}\n\ntype BuildHermesOptions = {\n  filename: string;\n  code: string;\n  map: string | null;\n  minify?: boolean;\n};\n\n// Only one hermes build at a time is supported.\nlet currentHermesBuild: Promise<HermesBundleOutput> | null = null;\n\nexport async function buildHermesBundleAsync(\n  options: BuildHermesOptions\n): Promise<HermesBundleOutput> {\n  if (currentHermesBuild) {\n    debug(`Waiting for existing Hermes builds to finish`);\n    await currentHermesBuild;\n  }\n  currentHermesBuild = directlyBuildHermesBundleAsync(options);\n  return await currentHermesBuild;\n}\n\nasync function directlyBuildHermesBundleAsync({\n  code,\n  map,\n  minify = false,\n  filename,\n}: BuildHermesOptions): Promise<HermesBundleOutput> {\n  const tempDir = path.join(os.tmpdir(), `expo-bundler-${Math.random()}-${Date.now()}`);\n  await fs.ensureDir(tempDir);\n  try {\n    const tempBundleFile = path.join(tempDir, 'index.js');\n    await fs.writeFile(tempBundleFile, code);\n\n    if (map) {\n      const tempSourcemapFile = path.join(tempDir, 'index.js.map');\n      await fs.writeFile(tempSourcemapFile, map);\n    }\n\n    const tempHbcFile = path.join(tempDir, 'index.hbc');\n    const hermesCommand = importHermesCommandFromProject();\n    const args = ['-emit-binary', '-out', tempHbcFile, tempBundleFile];\n    if (minify) {\n      args.push('-O');\n    }\n    if (map) {\n      args.push('-output-source-map');\n    }\n\n    debug(`Running hermesc: ${hermesCommand} ${args.join(' ')}`);\n    await spawnAsync(hermesCommand, args);\n\n    let hbc: Buffer;\n    let sourcemap: string | null = null;\n\n    if (!map) {\n      hbc = await fs.readFile(tempHbcFile);\n    } else {\n      [hbc, sourcemap] = await Promise.all([\n        fs.readFile(tempHbcFile),\n        createHermesSourcemapAsync(map, `${tempHbcFile}.map`),\n      ]);\n    }\n    return {\n      hbc,\n      sourcemap,\n    };\n  } catch (error: any) {\n    console.error(chalk.red(`\\nFailed to generate Hermes bytecode for: ${filename}`));\n    if ('status' in error) {\n      console.error(error.output.join('\\n'));\n    }\n    throw error;\n  } finally {\n    await fs.remove(tempDir);\n  }\n}\n\nasync function createHermesSourcemapAsync(\n  sourcemap: string,\n  hermesMapFile: string\n): Promise<string> {\n  const bundlerSourcemap = JSON.parse(sourcemap);\n  const hermesSourcemap = await fs.readJSON(hermesMapFile);\n  return JSON.stringify(composeSourceMaps([bundlerSourcemap, hermesSourcemap]));\n}\n"],"mappings":"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"}