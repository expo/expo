{"version":3,"file":"evalConfig.js","names":["_requireUtils","data","require","_Errors","_Serialize","_environment","evalConfig","configFile","request","mod","loadModuleSync","resolveConfigExport","result","hasBaseStaticConfig","NON_STANDARD_SYMBOL","config","default","exportedObjectType","Promise","ConfigError","mayHaveUnusedStaticConfig","_hasBaseStaticConfig","expo","serializeSkippingMods"],"sources":["../src/evalConfig.ts"],"sourcesContent":["import { loadModuleSync } from '@expo/require-utils';\n\nimport { AppJSONConfig, ConfigContext, ExpoConfig } from './Config.types';\nimport { ConfigError } from './Errors';\nimport { serializeSkippingMods } from './Serialize';\nimport { NON_STANDARD_SYMBOL } from './environment';\n\ntype RawDynamicConfig = AppJSONConfig | Partial<ExpoConfig> | null;\n\nexport type DynamicConfigResults = {\n  config: RawDynamicConfig;\n  exportedObjectType: string;\n  mayHaveUnusedStaticConfig: boolean;\n};\n\n/**\n * Transpile and evaluate the dynamic config object.\n * This method is shared between the standard reading method in getConfig, and the headless script.\n *\n * @param options configFile path to the dynamic app.config.*, request to send to the dynamic config if it exports a function.\n * @returns the serialized and evaluated config along with the exported object type (object or function).\n */\nexport function evalConfig(\n  configFile: string,\n  request: ConfigContext | null\n): DynamicConfigResults {\n  const mod = loadModuleSync(configFile);\n  return resolveConfigExport(mod, configFile, request);\n}\n\n/**\n * - Resolve the exported contents of an Expo config (be it default or module.exports)\n * - Assert no promise exports\n * - Return config type\n * - Serialize config\n *\n * @param result\n * @param configFile\n * @param request\n */\nexport function resolveConfigExport(\n  result: any,\n  configFile: string,\n  request: ConfigContext | null\n) {\n  // add key to static config that we'll check for after the dynamic is evaluated\n  // to see if the static config was used in determining the dynamic\n  const hasBaseStaticConfig = NON_STANDARD_SYMBOL;\n  if (request?.config) {\n    // @ts-ignore\n    request.config[hasBaseStaticConfig] = true;\n  }\n  if (result.default != null) {\n    result = result.default;\n  }\n  const exportedObjectType = typeof result;\n  if (typeof result === 'function') {\n    result = result(request);\n  }\n\n  if (result instanceof Promise) {\n    throw new ConfigError(`Config file ${configFile} cannot return a Promise.`, 'INVALID_CONFIG');\n  }\n\n  // If the key is not added, it suggests that the static config was not used as the base for the dynamic.\n  // note(Keith): This is the most common way to use static and dynamic config together, but not the only way.\n  // Hence, this is only output from getConfig() for informational purposes for use by tools like Expo Doctor\n  // to suggest that there *may* be a problem.\n  const mayHaveUnusedStaticConfig =\n    // @ts-ignore\n    request?.config?.[hasBaseStaticConfig] && !result?.[hasBaseStaticConfig];\n  if (result) {\n    delete result._hasBaseStaticConfig;\n  }\n\n  // If the expo object exists, ignore all other values.\n  if (result?.expo) {\n    result = serializeSkippingMods(result.expo);\n  } else {\n    result = serializeSkippingMods(result);\n  }\n\n  return { config: result, exportedObjectType, mayHaveUnusedStaticConfig };\n}\n"],"mappings":";;;;;;;AAAA,SAAAA,cAAA;EAAA,MAAAC,IAAA,GAAAC,OAAA;EAAAF,aAAA,YAAAA,CAAA;IAAA,OAAAC,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAGA,SAAAE,QAAA;EAAA,MAAAF,IAAA,GAAAC,OAAA;EAAAC,OAAA,YAAAA,CAAA;IAAA,OAAAF,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAG,WAAA;EAAA,MAAAH,IAAA,GAAAC,OAAA;EAAAE,UAAA,YAAAA,CAAA;IAAA,OAAAH,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAI,aAAA;EAAA,MAAAJ,IAAA,GAAAC,OAAA;EAAAG,YAAA,YAAAA,CAAA;IAAA,OAAAJ,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAUA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASK,UAAUA,CACxBC,UAAkB,EAClBC,OAA6B,EACP;EACtB,MAAMC,GAAG,GAAG,IAAAC,8BAAc,EAACH,UAAU,CAAC;EACtC,OAAOI,mBAAmB,CAACF,GAAG,EAAEF,UAAU,EAAEC,OAAO,CAAC;AACtD;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASG,mBAAmBA,CACjCC,MAAW,EACXL,UAAkB,EAClBC,OAA6B,EAC7B;EACA;EACA;EACA,MAAMK,mBAAmB,GAAGC,kCAAmB;EAC/C,IAAIN,OAAO,EAAEO,MAAM,EAAE;IACnB;IACAP,OAAO,CAACO,MAAM,CAACF,mBAAmB,CAAC,GAAG,IAAI;EAC5C;EACA,IAAID,MAAM,CAACI,OAAO,IAAI,IAAI,EAAE;IAC1BJ,MAAM,GAAGA,MAAM,CAACI,OAAO;EACzB;EACA,MAAMC,kBAAkB,GAAG,OAAOL,MAAM;EACxC,IAAI,OAAOA,MAAM,KAAK,UAAU,EAAE;IAChCA,MAAM,GAAGA,MAAM,CAACJ,OAAO,CAAC;EAC1B;EAEA,IAAII,MAAM,YAAYM,OAAO,EAAE;IAC7B,MAAM,KAAIC,qBAAW,EAAC,eAAeZ,UAAU,2BAA2B,EAAE,gBAAgB,CAAC;EAC/F;;EAEA;EACA;EACA;EACA;EACA,MAAMa,yBAAyB;EAC7B;EACAZ,OAAO,EAAEO,MAAM,GAAGF,mBAAmB,CAAC,IAAI,CAACD,MAAM,GAAGC,mBAAmB,CAAC;EAC1E,IAAID,MAAM,EAAE;IACV,OAAOA,MAAM,CAACS,oBAAoB;EACpC;;EAEA;EACA,IAAIT,MAAM,EAAEU,IAAI,EAAE;IAChBV,MAAM,GAAG,IAAAW,kCAAqB,EAACX,MAAM,CAACU,IAAI,CAAC;EAC7C,CAAC,MAAM;IACLV,MAAM,GAAG,IAAAW,kCAAqB,EAACX,MAAM,CAAC;EACxC;EAEA,OAAO;IAAEG,MAAM,EAAEH,MAAM;IAAEK,kBAAkB;IAAEG;EAA0B,CAAC;AAC1E","ignoreList":[]}