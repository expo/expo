{"version":3,"names":["_UIManager","_interopRequireDefault","require","_processColor","_StyleSheet","_Platform","_View","_TraceUpdateOverlayNativeComponent","_interopRequireWildcard","React","_jsxRuntime","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","useEffect","useRef","useState","hook","window","__REACT_DEVTOOLS_GLOBAL_HOOK__","isNativeComponentReady","Platform","OS","UIManager","hasViewManagerConfig","devToolsAgent","TraceUpdateOverlay","_useState","_useState2","_slicedToArray2","overlayDisabled","setOverlayDisabled","attachToDevtools","agent","addListener","onAgentDrawTraceUpdates","onAgentDisableTraceUpdates","subscribe","on","reactDevtoolsAgent","unsubscribe","off","removeListener","nodesToDraw","arguments","length","undefined","newFramesToDraw","forEach","_ref","_ref2","_node$publicInstance","node","color","component","publicInstance","canonical","measure","frameToDrawPromise","Promise","resolve","x","y","width","height","left","top","rect","processColor","push","all","then","results","nativeComponentRef","current","Commands","draw","JSON","stringify","filter","_ref3","err","console","error","jsx","pointerEvents","style","styles","overlay","children","ref","StyleSheet","create","position","bottom","right"],"sources":["TraceUpdateOverlay.js"],"sourcesContent":["/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow strict-local\n * @format\n */\n\nimport type {Overlay} from './TraceUpdateOverlayNativeComponent';\n\nimport UIManager from '../../ReactNative/UIManager';\nimport processColor from '../../StyleSheet/processColor';\nimport StyleSheet from '../../StyleSheet/StyleSheet';\nimport Platform from '../../Utilities/Platform';\nimport View from '../View/View';\nimport TraceUpdateOverlayNativeComponent, {\n  Commands,\n} from './TraceUpdateOverlayNativeComponent';\nimport * as React from 'react';\n\ntype AgentEvents = {\n  drawTraceUpdates: [Array<{node: TraceNode, color: string}>],\n  disableTraceUpdates: [],\n};\n\ninterface Agent {\n  addListener<Event: $Keys<AgentEvents>>(\n    event: Event,\n    listener: (...AgentEvents[Event]) => void,\n  ): void;\n  removeListener(event: $Keys<AgentEvents>, listener: () => void): void;\n}\n\ntype TraceNode = {\n  publicInstance?: TraceNode,\n  // TODO: remove this field when syncing the new version of the renderer from React to React Native.\n  canonical?: TraceNode,\n  measure?: (\n    (\n      x: number,\n      y: number,\n      width: number,\n      height: number,\n      left: number,\n      top: number,\n    ) => void,\n  ) => void,\n};\n\ntype ReactDevToolsGlobalHook = {\n  on: (eventName: string, (agent: Agent) => void) => void,\n  off: (eventName: string, (agent: Agent) => void) => void,\n  reactDevtoolsAgent: Agent,\n};\n\nconst {useEffect, useRef, useState} = React;\nconst hook: ReactDevToolsGlobalHook = window.__REACT_DEVTOOLS_GLOBAL_HOOK__;\nconst isNativeComponentReady =\n  Platform.OS === 'android' &&\n  UIManager.hasViewManagerConfig('TraceUpdateOverlay');\nlet devToolsAgent: ?Agent;\n\nexport default function TraceUpdateOverlay(): React.Node {\n  const [overlayDisabled, setOverlayDisabled] = useState(false);\n  // This effect is designed to be explicitly shown here to avoid re-subscribe from the same\n  // overlay component.\n  useEffect(() => {\n    if (!isNativeComponentReady) {\n      return;\n    }\n\n    function attachToDevtools(agent: Agent) {\n      devToolsAgent = agent;\n      agent.addListener('drawTraceUpdates', onAgentDrawTraceUpdates);\n      agent.addListener('disableTraceUpdates', onAgentDisableTraceUpdates);\n    }\n\n    function subscribe() {\n      hook?.on('react-devtools', attachToDevtools);\n      if (hook?.reactDevtoolsAgent) {\n        attachToDevtools(hook.reactDevtoolsAgent);\n      }\n    }\n\n    function unsubscribe() {\n      hook?.off('react-devtools', attachToDevtools);\n      const agent = devToolsAgent;\n      if (agent != null) {\n        agent.removeListener('drawTraceUpdates', onAgentDrawTraceUpdates);\n        agent.removeListener('disableTraceUpdates', onAgentDisableTraceUpdates);\n        devToolsAgent = null;\n      }\n    }\n\n    function onAgentDrawTraceUpdates(\n      nodesToDraw: Array<{node: TraceNode, color: string}> = [],\n    ) {\n      // If overlay is disabled before, now it's enabled.\n      setOverlayDisabled(false);\n\n      const newFramesToDraw: Array<Promise<Overlay>> = [];\n      nodesToDraw.forEach(({node, color}) => {\n        // `publicInstance` => Fabric\n        // TODO: remove this check when syncing the new version of the renderer from React to React Native.\n        // `canonical` => Legacy Fabric\n        // `node` => Legacy renderer\n        const component = node.publicInstance ?? node.canonical ?? node;\n        if (!component || !component.measure) {\n          return;\n        }\n        const frameToDrawPromise = new Promise<Overlay>(resolve => {\n          // The if statement here is to make flow happy\n          if (component.measure) {\n            // TODO(T145522797): We should refactor this to use `getBoundingClientRect` when Paper is no longer supported.\n            component.measure((x, y, width, height, left, top) => {\n              resolve({\n                rect: {left, top, width, height},\n                color: processColor(color),\n              });\n            });\n          }\n        });\n        newFramesToDraw.push(frameToDrawPromise);\n      });\n      Promise.all(newFramesToDraw).then(\n        results => {\n          if (nativeComponentRef.current != null) {\n            Commands.draw(\n              nativeComponentRef.current,\n              JSON.stringify(\n                results.filter(\n                  ({rect, color}) => rect.width >= 0 && rect.height >= 0,\n                ),\n              ),\n            );\n          }\n        },\n        err => {\n          console.error(`Failed to measure updated traces. Error: ${err}`);\n        },\n      );\n    }\n\n    function onAgentDisableTraceUpdates() {\n      // When trace updates are disabled from the backend, we won't receive draw events until it's enabled by the next draw. We can safely remove the overlay as it's not needed now.\n      setOverlayDisabled(true);\n    }\n\n    subscribe();\n    return unsubscribe;\n  }, []); // Only run once when the overlay initially rendered\n\n  const nativeComponentRef =\n    useRef<?React.ElementRef<typeof TraceUpdateOverlayNativeComponent>>(null);\n\n  return (\n    !overlayDisabled &&\n    isNativeComponentReady && (\n      <View pointerEvents=\"none\" style={styles.overlay}>\n        <TraceUpdateOverlayNativeComponent\n          ref={nativeComponentRef}\n          style={styles.overlay}\n        />\n      </View>\n    )\n  );\n}\n\nconst styles = StyleSheet.create({\n  overlay: {\n    position: 'absolute',\n    top: 0,\n    bottom: 0,\n    left: 0,\n    right: 0,\n  },\n});\n"],"mappings":"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"}