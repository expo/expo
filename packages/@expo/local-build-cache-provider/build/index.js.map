{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  BuildCacheProviderPlugin,\n  ResolveBuildCacheProps,\n  RunOptions,\n  UploadBuildCacheProps,\n} from '@expo/config';\nimport chalk from 'chalk';\nimport fs from 'fs';\nimport path from 'path';\n\ntype Options = {\n  cacheDir?: string;\n};\n\nasync function resolveBuildCacheAsync(\n  { projectRoot, platform, fingerprintHash, runOptions }: ResolveBuildCacheProps,\n  options: Options = {}\n): Promise<string | null> {\n  const cacheDir = resolveCacheDir(projectRoot, options);\n\n  if (!fs.existsSync(cacheDir)) {\n    console.debug('Local build cache directory does not exist, skipping check');\n    return null;\n  }\n\n  const files = await fs.promises.readdir(cacheDir);\n\n  const expectedFile = `${platform}-${fingerprintHash}-${getBuildVariant(runOptions)}`;\n  const file = files.find((file) => file.includes(expectedFile));\n  if (!file) {\n    console.debug('No matching builds found in local cache, starting build process');\n    return null;\n  }\n\n  return path.join(cacheDir, file);\n}\n\nasync function uploadBuildCacheAsync(\n  { projectRoot, platform, fingerprintHash, buildPath, runOptions }: UploadBuildCacheProps,\n  options: Options = {}\n): Promise<string | null> {\n  const cacheDir = resolveCacheDir(projectRoot, options);\n\n  if (!fs.existsSync(cacheDir)) {\n    console.debug(\n      'Build cache directory does not exist, creating build cache folder at:',\n      cacheDir\n    );\n\n    await fs.promises.mkdir(cacheDir, { recursive: true });\n  }\n\n  try {\n    console.log(chalk`{whiteBright \\u203A} {bold Copying build to local cache}`);\n    const destFile = `${platform}-${fingerprintHash}-${getBuildVariant(runOptions)}${path.extname(buildPath)}`;\n    const destPath = path.join(cacheDir, destFile);\n\n    // Remove existing cache entry if it exists.\n    if (fs.existsSync(destPath)) {\n      await fs.promises.rm(destPath, { recursive: true, force: true });\n    }\n\n    const stats = await fs.promises.stat(buildPath);\n    // iOS builds are usually directories, Android builds are usually files.\n    if (stats.isDirectory()) {\n      await fs.promises.cp(buildPath, destPath, { recursive: true });\n    } else if (stats.isFile()) {\n      await fs.promises.copyFile(buildPath, destPath);\n    } else {\n      console.debug('Unsupported build artifact type for caching:', buildPath);\n      return null;\n    }\n    return destPath;\n  } catch (error) {\n    console.debug(' error:', error);\n  }\n  return null;\n}\n\nfunction resolveCacheDir(projectRoot: string, options: Options) {\n  return options?.cacheDir ?? path.join(projectRoot, '.expo', 'build-cache');\n}\n\nfunction getBuildVariant(runOptions: RunOptions): string {\n  if ('variant' in runOptions && runOptions.variant !== undefined) {\n    return runOptions.variant;\n  }\n  if ('configuration' in runOptions && runOptions.configuration !== undefined) {\n    return runOptions.configuration;\n  }\n\n  return 'unknown';\n}\n\nconst LocalBuildCacheProvider: BuildCacheProviderPlugin = {\n  resolveBuildCache: resolveBuildCacheAsync,\n  uploadBuildCache: uploadBuildCacheAsync,\n};\n\nexport default LocalBuildCacheProvider;\n"]}