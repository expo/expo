{"version":3,"file":"runCliExtension.js","sourceRoot":"","sources":["../src/runCliExtension.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  ExpoCliExtensionCommandSchema,\n  ExpoCliExtensionExecutor,\n  ExpoCliExtensionParameters,\n} from './CliExtension.types.js';\n\nimport { format } from 'util';\n\n/**\n * Executes an Expo CLI extension command with the provided executor function.\n * This function retrieves the command, arguments, and connected applications,\n * then calls the executor with these parameters.\n *\n * @param executor - A function that takes a command, arguments, and connected applications,\n *                   and returns a Promise that resolves when the command execution is complete.\n */\nexport async function runCliExtension<T extends ExpoCliExtensionCommandSchema>(\n  executor: ExpoCliExtensionExecutor<T>\n) {\n  const params = getExpoCliPluginParameters<T>(process.argv);\n\n  try {\n    await executor(params, CliExtensionConsole);\n  } catch (error) {\n    for (const line of formatCliExtensionErrorLines(error)) {\n      CliExtensionConsole.error(line);\n    }\n  }\n}\n\n/**\n * Returns typed parameters for an Expo CLI plugin. (exported for testing)\n * Parameters are read from the process.\n */\nconst getExpoCliPluginParameters = <T extends ExpoCliExtensionCommandSchema>(\n  argv: string[]\n): ExpoCliExtensionParameters<T> => {\n  // Extract command, args, and apps from process arguments\n  const command = argv[2]?.toLowerCase();\n  const argsString = argv[3] ?? '{}';\n  const metroServerOrigin = argv[4] ?? '';\n\n  // Verify command exists\n  if (!command) {\n    throw new Error('No command provided.');\n  }\n\n  let args: T['args'] = {} as T['args'];\n\n  if (!metroServerOrigin || typeof metroServerOrigin !== 'string') {\n    throw new Error('Invalid metroServerOrigin parameter. It must be a non-empty string.');\n  }\n\n  try {\n    args = JSON.parse(argsString);\n  } catch (error) {\n    throw new Error(\n      `Invalid args JSON: ${error instanceof Error ? error.message : 'Unknown error'} - ${argv.join(', ')}`\n    );\n  }\n\n  if (Array.isArray(args) || typeof args !== 'object') {\n    throw new Error('Expected object for args parameter, got ' + JSON.stringify(args));\n  }\n\n  return {\n    command,\n    args,\n    metroServerOrigin,\n  } as ExpoCliExtensionParameters<T>;\n};\n\nexport { getExpoCliPluginParameters as testing_getExpoCliPluginParameters };\n\n// --------------- LOGGING HELPERS  ---------------\n\n/**\n * We're wrapping console methods to output structured JSON messages.\n */\nconst asJson = (level: 'log' | 'info' | 'warning' | 'error', message: string, args: any[]) =>\n  JSON.stringify([{ type: 'text', text: format(message, ...args), level }]);\n\nconst CliExtensionConsole = {\n  log: (message: string, ...args: any[]) => console.log(asJson('info', message, args)),\n  info: (message: string, ...args: any[]) => console.log(asJson('info', message, args)),\n  warn: (message: string, ...args: any[]) => console.error(asJson('warning', message, args)),\n  error: (message: string, ...args: any[]) => console.error(asJson('error', message, args)),\n  uri: (uri: string, altText?: string) => {\n    console.log(JSON.stringify([{ type: 'uri', uri, altText }]));\n  },\n};\n\n// --------------- ERROR HELPERS  ---------------\n\nconst stripErrorPrefix = (message: string) => message.replace(/^Error:\\s*/i, '');\n\nconst getErrorMessage = (value: unknown) => {\n  if (value instanceof Error && value.message) {\n    return stripErrorPrefix(value.message);\n  }\n\n  if (typeof value === 'string') {\n    return stripErrorPrefix(value);\n  }\n\n  return stripErrorPrefix(String(value));\n};\n\nconst getErrorCause = (value: unknown) => (value instanceof Error ? value.cause : undefined);\n\nconst formatCliExtensionErrorLines = (error: unknown) => {\n  const mainMessage = getErrorMessage(error) || 'Unknown error';\n  const lines = [mainMessage];\n\n  const maxCauses = 3;\n  let cause = getErrorCause(error);\n  let collected = 0;\n  let remaining = 0;\n\n  while (cause) {\n    if (collected < maxCauses) {\n      lines.push(getErrorMessage(cause));\n      collected += 1;\n    } else {\n      remaining += 1;\n    }\n\n    cause = getErrorCause(cause);\n  }\n\n  if (remaining > 0) {\n    lines.push(`â€¦and ${remaining} more issues`);\n  }\n\n  return lines;\n};\n"]}