{"version":3,"file":"sendCliMessage.js","sourceRoot":"","sources":["../src/sendCliMessage.ts"],"names":[],"mappings":"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","sourcesContent":["import { Data } from 'ws';\n\nimport { ExpoCliExtensionAppInfo } from './CliExtension.types.js';\nimport { SendMessageError } from './CliExtensionUtils.js';\n\n// We'd like this to be fairly quick, and at least a bit shorter\n// than Metro's own timeout (10 seconds) to be able to report errors before Metro does.\nconst DEFAULT_TIMEOUT_MS = 5_000;\n\n/**\n * Sends out a message to the WebSocket server using a broadcast channel and waits for a response.\n * If the connection times out or an error occurs, it rejects the promise with an error.\n * @param message Message to send to the WebSocket server.\n * @param pluginName Name of the plugin to send the message to. This is used to identify the plugin in the WebSocket server.\n * @param apps Apps to send the message to. This is an array of `MetroInspectorApp` objects.\n * @param timeoutMs Timeout in milliseconds to wait for a response. Defaults to 10 seconds.\n */\nexport async function sendCliMessageAsync(\n  message: string,\n  pluginName: string,\n  apps: ExpoCliExtensionAppInfo[],\n  timeoutMs = DEFAULT_TIMEOUT_MS\n): Promise<Record<string, string | null>> {\n  // Sanity check: ensure that all apps share the same WebSocket URL\n  if (apps.length === 0) {\n    return Promise.reject(\n      new SendMessageError('No apps provided to send the message to.', apps[0])\n    );\n  }\n\n  // Check that all apps share the same broadcast URL\n  if (\n    apps.some(\n      (app) => new URL(app.webSocketDebuggerUrl).host !== new URL(apps[0].webSocketDebuggerUrl).host\n    )\n  ) {\n    return Promise.reject(\n      new SendMessageError(\n        'All apps should share the same WebSocket URL hostname to send messages.' +\n          apps[0].webSocketDebuggerUrl,\n        apps[0]\n      )\n    );\n  }\n\n  // Create connection\n  const url = new URL(apps[0].webSocketDebuggerUrl);\n  const address = `ws://${url.host}/expo-dev-plugins/broadcast`;\n\n  // Create results for all apps\n  const results = apps.reduce(\n    (acc, app) => ({\n      ...acc,\n      [app.id]: null,\n    }),\n    {} as Record<string, string | null>\n  );\n\n  // Create a websocket connection to the broadcast channel\n  const ws = new WebSocket(address);\n\n  // Lets do the rest of the handling in the event listeners through a promise that will be resolved\n  // when we get a response for the message we sent\n  return new Promise<Record<string, string | null>>((resolve, reject) => {\n    // Setup timeout handler\n    const timeoutHandler = setTimeout(() => {\n      // Close the WebSocket to allow the process to exit\n      ws.close();\n      // Check if no results are resolved - this is an error:\n      if (Object.values(results).every((result) => result === null)) {\n        const errorMessage = `Timeout while waiting for response from apps.`;\n        reject(new SendMessageError(errorMessage, apps.find((a) => results[a.id] === null)!));\n      } else if (Object.values(results).some((result) => result !== null)) {\n        // We got partial results - this is ok, but with a warning - update results for each of the apps\n        // that didn't respond with a warning message\n        Object.keys(results).forEach((key) => {\n          if (results[key] === null) {\n            results[key] = 'No response (timeout)';\n          }\n        });\n        resolve(results as Record<string, string>);\n      }\n      // Clear the timeout handler\n      clearTimeout(timeoutHandler);\n    }, timeoutMs);\n\n    ws.addEventListener('message', ({ data }: { data: Data }) => {\n      const parsedData = parseWebSocketData(data);\n      const { messageKey, payload } = parsedData;\n      if (messageKey.pluginName === pluginName && messageKey.method === message + '_response') {\n        // We got a response for our message. Now get the app ID and result\n        const { deviceName, applicationId } = payload;\n        const result = payload.message;\n        const app = apps.find(\n          (app) => getDeviceIdentifier(app) === formatDeviceIdentifier(deviceName, applicationId)\n        );\n\n        if (!app) {\n          reject(\n            new Error(\n              `Received response for unknown app: ${deviceName} (${applicationId}). Ignoring.`\n            )\n          );\n          return;\n        }\n\n        results[app.id] = result.toString();\n\n        // Check if we have results for all apps\n        if (Object.values(results).every((result) => result !== null)) {\n          clearTimeout(timeoutHandler);\n          ws.close();\n          // Resolve the promise with the results\n          resolve(results);\n        }\n      }\n    });\n\n    ws.addEventListener('open', () => {\n      // On Open we'll send the message to the broadcast channel\n      const messageKey = getMessageKey(pluginName, message);\n      ws.send(JSON.stringify({ messageKey, payload: { from: 'cli' } }));\n    });\n    ws.addEventListener('error', () => {\n      clearTimeout(timeoutHandler);\n      ws.close();\n      console.error(`Failed to connect to the WebSocket server at ${url}`);\n      reject(new Error(`Failed to connect to the WebSocket server at ${url}`));\n    });\n    ws.addEventListener('close', () => {\n      clearTimeout(timeoutHandler);\n    });\n  });\n}\n\nconst getMessageKey = (pluginName: string, method: string) => ({\n  pluginName,\n  method,\n});\n\nfunction parseWebSocketData<T extends Record<string, any>>(data: Data): any {\n  if (typeof data === 'string') {\n    return JSON.parse(data) as T;\n  } else if (data instanceof Buffer) {\n    return JSON.parse(data.toString()) as T;\n  } else if (data instanceof ArrayBuffer) {\n    return JSON.parse(Buffer.from(data).toString()) as T;\n  } else if (Array.isArray(data)) {\n    return JSON.parse(Buffer.concat(data).toString()) as T;\n  }\n  throw new Error('Unsupported WebSocket data type');\n}\n\nconst getDeviceIdentifier = (app: ExpoCliExtensionAppInfo) => {\n  // Use the deviceName + app ID as the device identifier\n  return formatDeviceIdentifier(app.deviceName, app.appId);\n};\n\nconst formatDeviceIdentifier = (deviceName: string, applicationId: string) => {\n  // Use the deviceName + app ID as the device identifier\n  return `${deviceName} (${applicationId})`;\n};\n"]}