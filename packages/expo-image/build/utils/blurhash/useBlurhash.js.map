{"version":3,"file":"useBlurhash.js","sourceRoot":"","sources":["../../../src/utils/blurhash/useBlurhash.tsx"],"names":[],"mappings":"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","sourcesContent":["// adapted from https://gist.github.com/ngbrown/d62eb518753378eb0a9bf02bb4723235\n// modified from https://gist.github.com/WorldMaker/a3cbe0059acd827edee568198376b95a\n// https://github.com/woltapp/react-blurhash/issues/3\n\nimport { useEffect, useState, useMemo } from 'react';\n\nimport decode from './decode';\nimport { isBlurhashString } from '../resolveSources';\n\nconst DEFAULT_SIZE = {\n  width: 32,\n  height: 32,\n};\n\n// We scale up the canvas to avoid an irritating visual glitch when animating in Chrome.\nconst scaleRatio = 10;\n\nexport function useBlurhash(\n  blurhash: { uri?: string; width?: number; height?: number } | undefined | null,\n  punch: number = 1\n) {\n  punch = punch || 1;\n\n  const [uri, setUri] = useState<string | null>(null);\n  const isBlurhash = (blurhash?.uri && isBlurhashString(blurhash.uri)) ?? false;\n  useEffect(() => {\n    let isCanceled = false;\n\n    if (!blurhash || !blurhash.uri || !isBlurhash) {\n      return;\n    }\n    const strippedBlurhashString = blurhash.uri.replace(/blurhash:\\//, '');\n\n    const pixels = decode(\n      strippedBlurhashString,\n      blurhash.width ?? DEFAULT_SIZE.width,\n      blurhash.height ?? DEFAULT_SIZE.height,\n      punch\n    );\n\n    const canvas = document.createElement('canvas');\n    const upscaledCanvas = document.createElement('canvas');\n    canvas.width = blurhash.width ?? DEFAULT_SIZE.width;\n    canvas.height = blurhash.height ?? DEFAULT_SIZE.height;\n    upscaledCanvas.width = (blurhash.width ?? DEFAULT_SIZE.width) * scaleRatio;\n    upscaledCanvas.height = (blurhash.height ?? DEFAULT_SIZE.height) * scaleRatio;\n    const context = canvas.getContext('2d');\n    if (!context) {\n      console.warn('Failed to decode blurhash');\n      return;\n    }\n    const imageData = context.createImageData(canvas.width, canvas.height);\n    imageData.data.set(pixels);\n    context.putImageData(imageData, 0, 0);\n    const upscaledContext = upscaledCanvas.getContext('2d');\n    if (!upscaledContext) {\n      console.warn('Failed to decode blurhash');\n      return;\n    }\n    upscaledContext.scale(scaleRatio, scaleRatio);\n    upscaledContext.drawImage(canvas, 0, 0);\n    upscaledCanvas.toBlob((blob) => {\n      if (!isCanceled) {\n        setUri((oldUrl) => {\n          if (oldUrl) {\n            URL.revokeObjectURL(oldUrl);\n          }\n          return blob ? URL.createObjectURL(blob) : oldUrl;\n        });\n      }\n    });\n\n    return function cleanupBlurhash() {\n      isCanceled = true;\n      setUri((oldUrl) => {\n        if (oldUrl) {\n          URL.revokeObjectURL(oldUrl);\n        }\n        return null;\n      });\n    };\n  }, [blurhash?.uri, blurhash?.height, blurhash?.width, punch, isBlurhash]);\n  const source = useMemo(() => (uri ? { uri } : null), [uri]);\n  return [source, isBlurhash] as const;\n}\n"]}