{"version":3,"file":"writeStoriesAsync.js","sourceRoot":"","sources":["../../src/cli/writeStoriesAsync.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,sDAA2B;AAC3B,8CAAwB;AAGxB,mCAA2D;AAE3D,SAAsB,iBAAiB,CAAC,MAA+B;;;;;;oBAC7D,WAAW,GAAK,MAAM,YAAX,CAAY;oBACzB,aAAa,GAAG,IAAA,yBAAgB,EAAC,WAAW,CAAC,CAAC;oBAC9C,OAAO,GAAG,MAAM,CAAC,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,UAAC,EAAE,IAAK,OAAA,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC,EAAvB,CAAuB,CAAC,CAAC;oBAElF,QAAQ,GAAG,oDAET,OAAO,CAAC,GAAG,CAAC,UAAC,KAAK,IAAK,OAAA,wBAAwB,CAAC,KAAK,CAAC,EAA/B,CAA+B,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC,mDAEnE,CAAC;oBAEJ,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,UAAU,EAAE;wBAC3B,QAAQ,GAAG,OAAO,CAAC,SAAS,CAAC,CAAC,aAAa,CAAC,QAAQ,EAAE;4BACpD,MAAM,EAAE,IAAI;yBACb,CAAC,CAAC,IAAI,CAAC;qBACT;oBAEK,UAAU,GAAG,IAAA,sBAAa,EAAC,EAAE,WAAW,aAAA,EAAE,CAAC,CAAC;oBAC5C,iBAAiB,GAAG,cAAI,CAAC,OAAO,CAAC,UAAU,EAAE,YAAY,CAAC,CAAC;oBACjE,qBAAM,kBAAG,CAAC,SAAS,CAAC,iBAAiB,EAAE,QAAQ,EAAE,EAAE,QAAQ,EAAE,OAAO,EAAE,CAAC,EAAA;;oBAAvE,SAAuE,CAAC;;;;;CACzE;AApBD,8CAoBC;AAED,0FAA0F;AAC1F,SAAS,wBAAwB,CAAC,KAAgB;IAChD,IAAM,YAAY,GAAG,KAAK,CAAC,YAAY,CAAC,OAAO,CAAC,cAAc,EAAE,EAAE,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,CAAC;IAErF,OAAO,yBACM,KAAK,CAAC,EAAE,wDACU,KAAK,CAAC,QAAQ,8EAE5B,KAAK,CAAC,EAAE,mDACS,YAAY,iMAMnB,KAAK,CAAC,EAAE,8SAe/B,KAAK,CAAC,EAAE,gBACX,CAAC;AACJ,CAAC","sourcesContent":["import fse from 'fs-extra';\nimport path from 'path';\n\nimport { StoryFile } from '../types';\nimport { getStoriesDir, getStoryManifest } from './shared';\n\nexport async function writeStoriesAsync(config: { projectRoot: string }) {\n  const { projectRoot } = config;\n  const storyManifest = getStoryManifest(projectRoot);\n  const stories = Object.keys(storyManifest.files).map((id) => storyManifest.files[id]);\n\n  let template = `\n      const storiesToExport = {}\n      ${stories.map((story) => generateTemplateForStory(story)).join('')}\n      module.exports = storiesToExport\n    `;\n\n  if (!process.env.EXPO_DEBUG) {\n    template = require('esbuild').transformSync(template, {\n      minify: true,\n    }).code;\n  }\n\n  const storiesDir = getStoriesDir({ projectRoot });\n  const writeRequiresPath = path.resolve(storiesDir, 'stories.js');\n  await fse.writeFile(writeRequiresPath, template, { encoding: 'utf-8' });\n}\n\n// the formatting of this template is important because it preserves fast refresh w/ metro\nfunction generateTemplateForStory(story: StoryFile) {\n  const defaultTitle = story.relativePath.replace('.stories.tsx', '').split('/').pop();\n\n  return `\n    function ${story.id}Setup() {\n      const stories = require(\"${story.fullPath}\")\n      const file = stories.default || {}\n      file.id = \"${story.id}\"\n      file.title = file.title || '${defaultTitle}'\n\n      Object.keys(stories).forEach((key) => {\n        const Component = stories[key]\n        \n        if (typeof Component === \"function\") {\n          const storyId = \"${story.id}\" + \"_\" + key\n          \n          Component.storyConfig = {\n            id: storyId,\n            name: key,\n            ...Component.storyConfig,\n          }\n\n          Component.file = file\n\n          storiesToExport[storyId] = Component \n        }\n      })\n    }\n\n    ${story.id}Setup()\n  `;\n}\n"]}