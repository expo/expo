{"version":3,"file":"SessionUrlProvider.js","sourceRoot":"","sources":["../src/SessionUrlProvider.ts"],"names":[],"mappings":"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","sourcesContent":["import { Platform } from '@unimodules/react-native-adapter';\nimport Constants, { ExecutionEnvironment } from 'expo-constants';\nimport * as Linking from 'expo-linking';\nimport { CreateURLOptions } from 'expo-linking';\nimport { resolveScheme } from 'expo-linking/build/Schemes';\nimport qs, { ParsedQs } from 'qs';\n\nexport class SessionUrlProvider {\n  private static readonly BASE_URL = `https://auth.expo.io`;\n  private static readonly SESSION_PATH = 'expo-auth-session';\n\n  getDefaultReturnUrl(urlPath?: string, options?: Omit<CreateURLOptions, 'queryParams'>): string {\n    const queryParams = SessionUrlProvider.getHostAddressQueryParams();\n    let path = SessionUrlProvider.SESSION_PATH;\n    if (urlPath) {\n      path = [path, SessionUrlProvider.removeLeadingSlash(urlPath)].filter(Boolean).join('/');\n    }\n\n    return Linking.createURL(path, {\n      // The redirect URL doesn't matter for the proxy as long as it's valid, so silence warnings if needed.\n      scheme: options?.scheme ?? resolveScheme({ isSilent: true }),\n      queryParams,\n      isTripleSlashed: options?.isTripleSlashed,\n    });\n  }\n\n  getStartUrl(useEASAuthSession: boolean, authUrl: string, returnUrl: string): string {\n    if (Platform.OS === 'web' && !Platform.isDOMAvailable) {\n      // Return nothing in SSR envs\n      return '';\n    }\n    const queryString = qs.stringify({\n      authUrl,\n      returnUrl,\n    });\n\n    return `${this.getRedirectUrl(useEASAuthSession)}/start?${queryString}`;\n  }\n\n  getRedirectUrl(useEASAuthSession: boolean, urlPath?: string): string {\n    if (Platform.OS === 'web') {\n      if (Platform.isDOMAvailable) {\n        return [window.location.origin, urlPath].filter(Boolean).join('/');\n      } else {\n        // Return nothing in SSR envs\n        return '';\n      }\n    }\n\n    if (useEASAuthSession) {\n      const easProjectId =\n        Constants.manifest?.projectId || Constants.manifest2?.extra?.eas?.projectId;\n      if (!easProjectId) {\n        let nextSteps = '';\n        if (__DEV__) {\n          if (Constants.executionEnvironment === ExecutionEnvironment.Bare) {\n            nextSteps =\n              ' Please ensure you have the latest version of expo-constants installed and rebuild your native app.';\n          } else if (Constants.executionEnvironment === ExecutionEnvironment.StoreClient) {\n            nextSteps = ' Please report this as a bug.';\n          }\n        }\n        throw new Error(\n          'Cannot use AuthSession proxy because the project ID is not defined.' + nextSteps\n        );\n      }\n\n      return `${SessionUrlProvider.BASE_URL}/eas/${easProjectId}`;\n    } else {\n      const legacyExpoProjectId =\n        Constants.manifest?.originalFullName ||\n        Constants.manifest2?.extra?.expoClient?.originalFullName ||\n        Constants.manifest?.id;\n\n      if (!legacyExpoProjectId) {\n        let nextSteps = '';\n        if (__DEV__) {\n          if (Constants.executionEnvironment === ExecutionEnvironment.Bare) {\n            nextSteps =\n              ' Please ensure you have the latest version of expo-constants installed and rebuild your native app. You can verify that originalFullName is defined by running `expo config --type public` and inspecting the output.';\n          } else if (Constants.executionEnvironment === ExecutionEnvironment.StoreClient) {\n            nextSteps =\n              ' Please report this as a bug with the contents of `expo config --type public`.';\n          }\n        }\n        throw new Error(\n          'Cannot use AuthSession proxy because the legacy project ID is not defined.' + nextSteps\n        );\n      }\n\n      const redirectUrl = `${SessionUrlProvider.BASE_URL}/${legacyExpoProjectId}`;\n      if (__DEV__) {\n        SessionUrlProvider.warnIfAnonymous(legacyExpoProjectId, redirectUrl);\n        // TODO: Verify with the dev server that the manifest is up to date.\n      }\n      return redirectUrl;\n    }\n  }\n\n  private static getHostAddressQueryParams(): ParsedQs | undefined {\n    let hostUri: string | undefined =\n      Constants.manifest?.hostUri ?? Constants.manifest2?.extra?.expoClient?.hostUri;\n    if (\n      !hostUri &&\n      (ExecutionEnvironment.StoreClient === Constants.executionEnvironment || resolveScheme({}))\n    ) {\n      if (!Constants.linkingUri) {\n        hostUri = '';\n      } else {\n        // we're probably not using up-to-date xdl, so just fake it for now\n        // we have to remove the /--/ on the end since this will be inserted again later\n        hostUri = SessionUrlProvider.removeScheme(Constants.linkingUri).replace(/\\/--(\\/.*)?$/, '');\n      }\n    }\n\n    if (!hostUri) {\n      return undefined;\n    }\n\n    const uriParts = hostUri?.split('?');\n    try {\n      return qs.parse(uriParts?.[1]);\n    } catch {}\n\n    return undefined;\n  }\n\n  private static warnIfAnonymous(id: string, url: string): void {\n    if (id.startsWith('@anonymous/')) {\n      console.warn(\n        `You are not currently signed in to Expo on your development machine. As a result, the redirect URL for AuthSession will be \"${url}\". If you are using an OAuth provider that requires adding redirect URLs to an allow list, we recommend that you do not add this URL -- instead, you should sign in to Expo to acquire a unique redirect URL. Additionally, if you do decide to publish this app using Expo, you will need to register an account to do it.`\n      );\n    }\n  }\n\n  private static removeScheme(url: string) {\n    return url.replace(/^[a-zA-Z0-9+.-]+:\\/\\//, '');\n  }\n\n  private static removeLeadingSlash(url: string) {\n    return url.replace(/^\\//, '');\n  }\n}\n\nexport default new SessionUrlProvider();\n"]}