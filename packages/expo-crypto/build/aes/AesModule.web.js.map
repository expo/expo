{"version":3,"file":"AesModule.web.js","sourceRoot":"","sources":["../../src/aes/AesModule.web.ts"],"names":[],"mappings":"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","sourcesContent":["import { registerWebModule, NativeModule } from 'expo';\n\nimport {\n  DecryptOptions,\n  EncryptOptions,\n  KeySize,\n  SealedDataConfig,\n  BinaryInput,\n} from './aes.types';\nimport {\n  base64ToUintArray,\n  binaryInputBytes,\n  bytesToHex,\n  hexToUintArray,\n  uint8ArrayToBase64,\n} from './web-utils';\n\nconst DEFAULT_IV_LENGTH = 12;\nconst DEFAULT_TAG_LENGTH = 16;\n\nconst defaultConfig: SealedDataConfig = {\n  ivLength: DEFAULT_IV_LENGTH,\n  tagLength: DEFAULT_TAG_LENGTH,\n};\n\nclass EncryptionKey {\n  key: CryptoKey;\n  keySize: KeySize;\n\n  private constructor(key: CryptoKey, size: KeySize) {\n    this.key = key;\n    this.keySize = size;\n  }\n\n  static async generate(size?: KeySize): Promise<EncryptionKey> {\n    const keySize = size ?? KeySize.AES256;\n    const algorithm = { name: 'AES-GCM', length: keySize };\n    const key = await crypto.subtle.generateKey(algorithm, true, ['encrypt', 'decrypt']);\n    return new EncryptionKey(key, keySize);\n  }\n\n  static async import(\n    input: Uint8Array | string,\n    encoding?: 'hex' | 'base64'\n  ): Promise<EncryptionKey> {\n    let bytes: Uint8Array;\n    if (typeof input === 'string') {\n      bytes = encoding === 'base64' ? base64ToUintArray(input) : hexToUintArray(input);\n    } else {\n      bytes = input;\n    }\n\n    const key = await crypto.subtle.importKey('raw', bytes as BufferSource, 'AES-GCM', true, [\n      'encrypt',\n      'decrypt',\n    ]);\n    return new EncryptionKey(key, bytes.byteLength * 8);\n  }\n\n  async bytes(): Promise<Uint8Array> {\n    const buffer = await crypto.subtle.exportKey('raw', this.key);\n    return new Uint8Array(buffer);\n  }\n\n  async encoded(encoding: 'hex' | 'base64'): Promise<string> {\n    const bytes = await this.bytes();\n    const encoded = encoding === 'base64' ? uint8ArrayToBase64(bytes) : bytesToHex(bytes);\n    return encoded;\n  }\n\n  get size(): KeySize {\n    return this.keySize;\n  }\n}\n\nclass SealedData {\n  private buffer: ArrayBuffer;\n  private config: SealedDataConfig;\n\n  private constructor(buffer: ArrayBuffer, config: SealedDataConfig) {\n    this.buffer = buffer;\n    this.config = config;\n  }\n\n  static fromCombined(combined: BinaryInput, config?: SealedDataConfig): SealedData {\n    const buffer = binaryInputBytes(combined).buffer as ArrayBuffer;\n    return new SealedData(buffer, config ?? defaultConfig);\n  }\n\n  static fromParts(\n    iv: BinaryInput,\n    ciphertext: BinaryInput,\n    tag?: BinaryInput | number\n  ): SealedData {\n    const ciphertextBytes = binaryInputBytes(ciphertext);\n    const ivBytes = binaryInputBytes(iv);\n    const ivLength = ivBytes.byteLength;\n\n    if (!tag) {\n      tag = DEFAULT_TAG_LENGTH;\n    }\n\n    if (typeof tag === 'number') {\n      const totalLength = ivLength + ciphertextBytes.byteLength;\n      const combined = new Uint8Array(totalLength);\n      combined.set(ivBytes);\n      combined.set(ciphertextBytes, ivLength);\n\n      const config: SealedDataConfig = {\n        ivLength,\n        tagLength: tag,\n      };\n      return new SealedData(combined.buffer, config);\n    }\n\n    const tagBytes = binaryInputBytes(tag);\n    const tagLength = tagBytes.byteLength;\n    const totalLength = ivLength + ciphertextBytes.byteLength + tagLength;\n\n    const combined = new Uint8Array(totalLength);\n    combined.set(ivBytes);\n    combined.set(ciphertextBytes, ivLength);\n    combined.set(tagBytes, totalLength - tagLength);\n\n    return new SealedData(combined.buffer, { ivLength, tagLength });\n  }\n\n  get ivSize(): number {\n    return this.config.ivLength;\n  }\n  get tagSize(): number {\n    return this.config.tagLength;\n  }\n  get combinedSize(): number {\n    return this.buffer.byteLength;\n  }\n\n  async iv(encoding?: 'bytes' | 'base64'): Promise<Uint8Array | string> {\n    const useBase64 = encoding === 'base64';\n    const bytes = new Uint8Array(this.buffer, 0, this.ivSize);\n    return useBase64 ? uint8ArrayToBase64(bytes) : bytes;\n  }\n  async tag(encoding?: 'bytes' | 'base64'): Promise<Uint8Array | string> {\n    const useBase64 = encoding === 'base64';\n    const offset = this.combinedSize - this.tagSize;\n    const bytes = new Uint8Array(this.buffer, offset, this.tagSize);\n    return useBase64 ? uint8ArrayToBase64(bytes) : bytes;\n  }\n  async combined(encoding?: 'bytes' | 'base64'): Promise<Uint8Array | string> {\n    const useBase64 = encoding === 'base64';\n    const bytes = new Uint8Array(this.buffer);\n    return useBase64 ? uint8ArrayToBase64(bytes) : bytes;\n  }\n  async ciphertext(options?: {\n    withTag?: boolean;\n    encoding?: 'bytes' | 'base64';\n  }): Promise<Uint8Array | string> {\n    const includeTag = options?.withTag ?? false;\n    const useBase64 = options?.encoding === 'base64';\n\n    const taggedCiphertextLength = this.combinedSize - this.ivSize;\n    const ciphertextLength = includeTag\n      ? taggedCiphertextLength\n      : taggedCiphertextLength - this.tagSize;\n\n    const bytes = new Uint8Array(this.buffer, this.ivSize, ciphertextLength);\n    return useBase64 ? uint8ArrayToBase64(bytes) : bytes;\n  }\n}\n\ntype NativeEncryptOptions = Omit<EncryptOptions, 'nonce'> & {\n  nonce?: number | Uint8Array | undefined;\n};\n\nclass AesCryptoModule extends NativeModule {\n  EncryptionKey = EncryptionKey;\n  SealedData = SealedData;\n\n  async encryptAsync(\n    plaintext: BinaryInput,\n    key: EncryptionKey,\n    options: NativeEncryptOptions = {}\n  ): Promise<SealedData> {\n    const {\n      nonce = DEFAULT_IV_LENGTH,\n      tagLength = DEFAULT_TAG_LENGTH,\n      additionalData: aad,\n    } = options;\n\n    const iv =\n      typeof nonce === 'number'\n        ? crypto.getRandomValues(new Uint8Array(nonce))\n        : binaryInputBytes(nonce);\n\n    const baseParams = { name: 'AES-GCM', iv, tagLength: tagLength * 8 };\n\n    // workaround for invalid AAD format error when it's present but undefined\n    const gcmParams = aad\n      ? {\n          ...baseParams,\n          additionalData: binaryInputBytes(aad),\n        }\n      : baseParams;\n\n    const ciphertextWithTag = await crypto.subtle.encrypt(\n      gcmParams,\n      key.key,\n      binaryInputBytes(plaintext) as BufferSource\n    );\n\n    return SealedData.fromParts(iv, ciphertextWithTag, tagLength);\n  }\n\n  async decryptAsync(\n    sealedData: SealedData,\n    key: EncryptionKey,\n    options: DecryptOptions = {}\n  ): Promise<string | Uint8Array> {\n    const { additionalData: aad, output } = options;\n\n    // workaround for invalid AAD format error when it's present but undefined\n    const iv = await sealedData.iv();\n    const baseParams = {\n      name: 'AES-GCM',\n      iv: iv as BufferSource,\n      tagLength: sealedData.tagSize * 8,\n    };\n    const gcmParams: AesGcmParams = aad\n      ? {\n          ...baseParams,\n          additionalData: binaryInputBytes(aad) as BufferSource,\n        }\n      : baseParams;\n\n    const taggedCiphertext = await sealedData.ciphertext({ withTag: true });\n    const plaintextBuffer = await crypto.subtle.decrypt(\n      gcmParams,\n      key.key,\n      taggedCiphertext as BufferSource\n    );\n\n    const useBase64 = output === 'base64';\n    const bytes = new Uint8Array(plaintextBuffer);\n    return useBase64 ? uint8ArrayToBase64(bytes) : bytes;\n  }\n}\n\nexport default registerWebModule(AesCryptoModule, 'ExpoCryptoAES');\n"]}