{"version":3,"file":"TemplateProject.js","sourceRoot":"","sources":["../src/TemplateProject.ts"],"names":[],"mappings":"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","sourcesContent":["import spawnAsync from '@expo/spawn-async';\nimport { Definitions } from 'dot';\nimport fs from 'fs';\nimport path from 'path';\n\nimport BundlerController from './BundlerController';\nimport { Application, DetoxTest } from './Config';\nimport { Platform } from './Platform';\nimport TemplateEvaluator from './TemplateEvaluator';\nimport { ProjectFile, TemplateFilesFactory, UserFile } from './TemplateFile';\nimport { killVirtualDevicesAsync } from './Utils';\n\nexport default class TemplateProject {\n  constructor(\n    protected config: Application,\n    protected name: string,\n    protected platform: Platform,\n    protected configFilePath: string\n  ) {}\n\n  getDefinitions(): Definitions {\n    return {\n      name: 'devcliente2e',\n      appEntryPoint: 'e2e/app/App',\n    };\n  }\n\n  async createApplicationAsync(projectPath: string) {\n    // TODO: this assumes there is a parent folder\n    const parentFolder = path.resolve(projectPath, '..');\n    if (!fs.existsSync(parentFolder)) {\n      fs.mkdirSync(parentFolder, { recursive: true });\n    }\n\n    const appName = 'dev-client-e2e';\n    await spawnAsync('yarn', ['create', 'expo-app', appName], {\n      stdio: 'inherit',\n      cwd: parentFolder,\n    });\n    fs.renameSync(path.join(parentFolder, appName), projectPath);\n\n    const repoRoot = path.resolve(this.configFilePath, '..', '..', '..');\n    const localCliBin = path.join(repoRoot, 'packages/@expo/cli/build/bin/cli');\n    await spawnAsync(localCliBin, ['install', 'detox', 'jest'], {\n      stdio: 'inherit',\n      cwd: projectPath,\n    });\n\n    // add local dependencies\n    let packageJson = JSON.parse(fs.readFileSync(path.join(projectPath, 'package.json'), 'utf-8'));\n    packageJson = {\n      ...packageJson,\n      dependencies: {\n        ...packageJson.dependencies,\n        'expo-dev-client': `file:${repoRoot}/packages/expo-dev-client`,\n        'expo-dev-menu-interface': `file:${repoRoot}/packages/expo-dev-menu-interface`,\n        'expo-status-bar': `file:${repoRoot}/packages/expo-status-bar`,\n        expo: `file:${repoRoot}/packages/expo`,\n        'jest-circus': packageJson.dependencies.jest,\n      },\n      resolutions: {\n        ...packageJson.resolutions,\n        'expo-application': `file:${repoRoot}/packages/expo-application`,\n        'expo-asset': `file:${repoRoot}/packages/expo-asset`,\n        'expo-constants': `file:${repoRoot}/packages/expo-constants`,\n        'expo-dev-launcher': `file:${repoRoot}/packages/expo-dev-launcher`,\n        'expo-dev-menu': `file:${repoRoot}/packages/expo-dev-menu`,\n        'expo-error-recovery': `file:${repoRoot}/packages/expo-error-recovery`,\n        'expo-file-system': `file:${repoRoot}/packages/expo-file-system`,\n        'expo-font': `file:${repoRoot}/packages/expo-font`,\n        'expo-keep-awake': `file:${repoRoot}/packages/expo-keep-awake`,\n        'expo-manifests': `file:${repoRoot}/packages/expo-manifests`,\n        'expo-modules-autolinking': `file:${repoRoot}/packages/expo-modules-autolinking`,\n        'expo-modules-core': `file:${repoRoot}/packages/expo-modules-core`,\n        'expo-updates-interface': `file:${repoRoot}/packages/expo-updates-interface`,\n      },\n    };\n    fs.writeFileSync(\n      path.join(projectPath, 'package.json'),\n      JSON.stringify(packageJson, null, 2),\n      'utf-8'\n    );\n\n    // configure app.json\n    let appJson = JSON.parse(fs.readFileSync(path.join(projectPath, 'app.json'), 'utf-8'));\n    appJson = {\n      ...appJson,\n      expo: {\n        ...appJson.expo,\n        android: { ...appJson.android, package: 'com.testrunner' },\n        ios: { ...appJson.ios, bundleIdentifier: 'com.testrunner' },\n      },\n    };\n    fs.writeFileSync(path.join(projectPath, 'app.json'), JSON.stringify(appJson, null, 2), 'utf-8');\n\n    // pack local template and prebuild\n    const localTemplatePath = path.join(repoRoot, 'templates', 'expo-template-bare-minimum');\n    await spawnAsync('npm', ['pack', '--pack-destination', projectPath], {\n      cwd: localTemplatePath,\n      stdio: 'inherit',\n    });\n    const templateVersion = require(path.join(localTemplatePath, 'package.json')).version;\n\n    await spawnAsync(\n      localCliBin,\n      ['prebuild', '--template', `expo-template-bare-minimum-${templateVersion}.tgz`],\n      {\n        stdio: 'inherit',\n        cwd: projectPath,\n      }\n    );\n\n    const templateFiles = this.getTemplateFiles();\n    await this.copyFilesAsync(projectPath, templateFiles);\n    await this.evaluateFiles(projectPath, templateFiles);\n\n    // workaround for instrumented unit test files not compiling in this\n    // configuration (ignored in .npmignore)\n    await spawnAsync('rm', ['-rf', 'node_modules/expo-dev-client/android/src/androidTest'], {\n      stdio: 'inherit',\n      cwd: projectPath,\n    });\n  }\n\n  getTemplateFiles(): { [path: string]: ProjectFile } {\n    const tff = new TemplateFilesFactory('detox');\n\n    const additionalFiles: { [path: string]: ProjectFile } = this.config.additionalFiles?.reduce(\n      (reducer, file) => ({\n        ...reducer,\n        [file]: new UserFile(this.userFilePath(file)),\n      }),\n      {}\n    );\n\n    if (this.config.android?.detoxTestFile) {\n      additionalFiles['android/app/src/androidTest/java/com/testrunner/DetoxTest.java'] =\n        new UserFile(this.userFilePath(this.config.android.detoxTestFile), Platform.Android);\n    }\n\n    return {\n      'android/build.gradle': tff.androidFile(),\n      'android/app/build.gradle': tff.androidFile(),\n      'android/app/src/androidTest/java/com/testrunner/DetoxTest.java': tff.androidFile(),\n      'android/app/src/main/java/com/testrunner/MainApplication.java': tff.androidFile(),\n      'index.js': tff.file(true),\n      'ios/devcliente2e/main.m': tff.iosFile(),\n      [this.config.detoxConfigFile]: new UserFile(\n        this.userFilePath(this.config.detoxConfigFile),\n        Platform.Both,\n        true\n      ),\n      ...additionalFiles,\n    };\n  }\n\n  protected userFilePath(relativePath: string): string {\n    return path.join(this.configFilePath, '..', relativePath);\n  }\n\n  protected async copyFilesAsync(projectPath: string, files: { [path: string]: ProjectFile }) {\n    await Promise.all(Object.entries(files).map(([path, file]) => file.copy(projectPath, path)));\n  }\n\n  protected async evaluateFiles(projectPath: string, files: { [path: string]: ProjectFile }) {\n    const templateEvaluator = new TemplateEvaluator(this.getDefinitions());\n    await Promise.all(\n      Object.entries(files).map(([path, file]) =>\n        file.evaluate(projectPath, path, templateEvaluator)\n      )\n    );\n  }\n\n  async build(projectPath: string, test: DetoxTest): Promise<void> {\n    for (const conf of test.configurations) {\n      await spawnAsync('yarn', ['detox', 'build', '-c', conf], {\n        cwd: projectPath,\n        stdio: 'inherit',\n      });\n    }\n  }\n\n  async run(projectPath: string, test: DetoxTest): Promise<void> {\n    let bundler: BundlerController | undefined;\n    try {\n      bundler = new BundlerController(projectPath);\n\n      if (test.shouldRunBundler) {\n        await bundler.start();\n      }\n\n      for (const conf of test.configurations) {\n        await spawnAsync(\n          'yarn',\n          ['detox', 'test', '-c', conf, '--ci', '--headless', '--gpu', 'swiftshader_indirect'],\n          {\n            cwd: projectPath,\n            stdio: 'inherit',\n          }\n        );\n\n        await killVirtualDevicesAsync(this.platform);\n      }\n    } finally {\n      // If bundler wasn't started is noop.\n      await bundler?.stop();\n    }\n  }\n}\n"]}