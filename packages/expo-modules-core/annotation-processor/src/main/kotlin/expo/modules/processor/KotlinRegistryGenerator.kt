package expo.modules.processor

import expo.modules.processor.OptimizedFunctionProcessor.FunctionMetadata

object KotlinRegistryGenerator {

    fun generate(moduleName: String, packageName: String, functions: List<FunctionMetadata>): String {
        // Generate registration calls with metadata (no C++ code generation needed!)
        val registrationCalls = functions.joinToString("\n") { function ->
            val jsName = function.functionName
            val methodName = function.functionName
            val jniSignature = buildJNISignature(function)
            val paramTypesArray = function.parameters.joinToString(", ") {
                "\"${mapKotlinTypeToJNISignature(it.kotlinType)}\""
            }
            val returnType = mapKotlinTypeToJNISignature(function.returnType)

            """        decorator.registerOptimizedSyncFunction(
            name = "$jsName",
            methodName = "$methodName",
            moduleInstance = moduleInstance,
            jniSignature = "$jniSignature",
            paramTypes = arrayOf($paramTypesArray),
            returnType = "$returnType"
        )"""
        }

        return """
// Generated by OptimizedFunctionProcessor
// DO NOT EDIT - This file is auto-generated
//
// This registry uses JNI reflection with the shared C++ dispatcher in expo-modules-core.
// No per-function C++ code is generated, making builds faster!

package $packageName

import expo.modules.kotlin.jni.decorators.JSDecoratorsBridgingObject

@Suppress("unused")
internal object ${moduleName}_OptimizedRegistry {

    @JvmStatic
    fun registerOptimizedFunctions(
        decorator: JSDecoratorsBridgingObject,
        moduleInstance: $moduleName
    ) {
$registrationCalls
    }
}
""".trimIndent()
    }

    private fun buildJNISignature(metadata: FunctionMetadata): String {
        val paramSignatures = metadata.parameters.joinToString("") { param ->
            mapKotlinTypeToJNISignature(param.kotlinType)
        }
        val returnSignature = mapKotlinTypeToJNISignature(metadata.returnType)
        return "($paramSignatures)$returnSignature"
    }

    private fun mapKotlinTypeToJNISignature(kotlinType: String): String {
        return when (kotlinType) {
            "Double" -> "D"
            "Int" -> "I"
            "Boolean" -> "Z"
            "Long" -> "J"
            "Float" -> "F"
            "String" -> "Ljava/lang/String;"
            "Unit" -> "V"
            else -> "Ljava/lang/Object;"
        }
    }

    private fun String.capitalize(): String {
        return this.replaceFirstChar { if (it.isLowerCase()) it.titlecase() else it.toString() }
    }
}
